<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stylize Video - AIè§†é¢‘é£æ ¼è½¬æ¢å·¥å…·</title>
  <style>
    :root{--bg:#0f172a;--panel:#111827;--text:#e5e7eb;--muted:#9ca3af;--accent:#22d3ee;--ok:#22c55e;--warn:#f59e0b;--err:#ef4444;--card:#0b1220}
    *{box-sizing:border-box} 
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0b1329 40%,#0a0f1a);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto;min-height:100vh}
    header{padding:20px 16px 8px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid rgba(255,255,255,.06)}
    h1{font-size:18px;margin:0} a{color:var(--accent);text-decoration:none}
    .wrap{max-width:1200px;margin:0 auto;padding:12px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{background:radial-gradient(1200px 400px at -10% -10%,rgba(34,211,238,.1),transparent 40%),radial-gradient(1200px 400px at 110% 110%,rgba(34,197,94,.08),transparent 40%),var(--card);border:1px solid rgba(255,255,255,.06);border-radius:16px;box-shadow:0 6px 22px rgba(0,0,0,.35)}
    .card h2{font-size:16px;margin:0;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.06)}
    .card .body{padding:14px 16px}
    label{display:block;margin:.5rem 0 .25rem;color:var(--muted);font-size:12px}
    input[type=text],input[type=password],input[type=number],select,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.1);background:#0b1120;color:var(--text);font-size:13px}
    input[type=file]{border:1px dashed rgba(255,255,255,.25);padding:16px;border-radius:12px;width:100%;background:#0b1120;color:var(--muted)}
    button{cursor:pointer;background:linear-gradient(90deg,#22d3ee,#22c55e);border:none;color:#02111a;font-weight:700;letter-spacing:.2px;transition:all .2s}
    button:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(34,211,238,.3)}
    button:disabled{filter:grayscale(1);opacity:.55;cursor:not-allowed;transform:none}
    .row{display:flex;gap:10px;align-items:center}
    .muted{color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid rgba(255,255,255,.1);background:#0b1120;border-radius:999px;padding:6px 10px;margin:4px 6px 0 0;font-size:12px;text-decoration:none}
    .gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;margin-top:12px}
    .thumb{position:relative;background:#000;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,.1)}
    .thumb img{display:block;width:100%;height:160px;object-fit:cover}
    .thumb .info{position:absolute;left:8px;right:8px;bottom:8px;background:rgba(0,0,0,.8);backdrop-filter:blur(4px);padding:6px 8px;border-radius:8px;text-align:center;border:1px solid rgba(255,255,255,.2);font-size:11px}
    .log{max-height:220px;overflow:auto;background:#0b1120;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px;font-family:monospace;font-size:12px}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    progress{width:100%;height:14px;border-radius:7px;background:#1e293b;border:1px solid rgba(255,255,255,.1)}
    progress::-webkit-progress-bar{background:#1e293b;border-radius:7px}
    progress::-webkit-progress-value{background:linear-gradient(90deg,#22d3ee,#22c55e);border-radius:7px}
    footer{padding:20px 16px;color:var(--muted);text-align:center;border-top:1px solid rgba(255,255,255,.06);margin-top:20px}
    .tiny{font-size:12px}
    details{border:1px solid rgba(255,255,255,.08);border-radius:8px;margin-top:8px}
    details[open] summary{border-bottom:1px solid rgba(255,255,255,.08);margin-bottom:0}
    summary{padding:8px 12px;color:var(--accent);font-weight:500;cursor:pointer}
    details .config-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:12px}
    details input[type=number], details select{font-size:12px;padding:6px 8px}
    details label{font-size:11px;margin:.25rem 0 .125rem;color:var(--muted)}
    .status-indicator{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px}
    .status-connecting{background:#f59e0b}
    .status-connected{background:#22c55e}
    .status-error{background:#ef4444}
    .preview-container{margin-bottom:12px}
    .preview-img{width:100%;height:200px;object-fit:contain;background:#000;border-radius:8px;border:1px solid rgba(255,255,255,.1)}
    .task-status{background:rgba(255,255,255,.02);border-radius:8px;padding:12px;margin-top:12px;border:1px solid rgba(255,255,255,.08)}
    .video-container{margin-top:12px}
    .video-player{width:100%;height:600px;border-radius:12px;border:1px solid rgba(255,255,255,.1)}
    .transition-checkbox{display:flex;align-items:center;gap:4px;font-size:10px;padding:2px 4px;border-radius:4px;cursor:pointer;transition:background-color 0.2s}
    .transition-checkbox:hover{background:rgba(255,255,255,.05)}
    .transition-checkbox input{width:auto;margin:0;transform:scale(0.8)}
    .transition-checkbox label{margin:0;cursor:pointer;color:var(--muted);font-size:10px}
    .mode-btn{width:auto;padding:6px 12px;margin:0;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:var(--muted);font-size:12px}
    .mode-btn.active{background:linear-gradient(90deg,#22d3ee,#22c55e);color:#02111a;font-weight:600}
    
    /* è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†æ ·å¼ */
    .custom-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px);z-index:9999;display:flex;align-items:center;justify-content:center;opacity:0;visibility:hidden;transition:all 0.3s ease}
    .custom-modal.show{opacity:1;visibility:visible}
    .modal-content{background:var(--card);border:1px solid rgba(255,255,255,.15);border-radius:16px;padding:24px;max-width:400px;width:90%;box-shadow:0 20px 40px rgba(0,0,0,0.5);transform:scale(0.9);transition:transform 0.3s ease}
    .custom-modal.show .modal-content{transform:scale(1)}
    .modal-icon{font-size:48px;text-align:center;margin-bottom:16px;color:var(--warn)}
    .modal-title{font-size:18px;font-weight:600;margin-bottom:8px;text-align:center;color:var(--text)}
    .modal-message{font-size:14px;color:var(--muted);text-align:center;margin-bottom:24px;line-height:1.5;white-space:pre-line;max-height:300px;overflow-y:auto}
    .modal-buttons{display:flex;gap:12px;justify-content:center}
    .modal-btn{padding:10px 20px;border-radius:8px;border:none;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.2s;min-width:80px}
    .modal-btn-confirm{background:linear-gradient(90deg,#ef4444,#dc2626);color:white}
    .modal-btn-confirm:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(239,68,68,0.4)}
    .modal-btn-cancel{background:rgba(255,255,255,.1);color:var(--text);border:1px solid rgba(255,255,255,.2)}
    .modal-btn-cancel:hover{background:rgba(255,255,255,.15);transform:translateY(-1px)}
    .history-task{border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:12px;margin-bottom:8px;cursor:pointer;transition:all 0.2s;position:relative}
    .history-task:hover{border-color:rgba(34,211,238,.3);background:rgba(34,211,238,.05)}
    .history-task.selected{border-color:#22d3ee;background:rgba(34,211,238,.1)}
    .history-task-title{font-size:13px;font-weight:600;margin-bottom:4px;display:flex;justify-content:space-between;align-items:center}
    .history-task-info{font-size:11px;color:var(--muted);line-height:1.4}
    .history-task-delete{background:rgba(239,68,68,0.8);color:white;border:none;border-radius:50%;width:20px;height:20px;font-size:12px;font-weight:bold;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;margin-left:8px}
    .history-task-delete:hover{background:rgba(239,68,68,1);transform:scale(1.1)}
    
    /* å›¾åº“ç½‘æ ¼æ ·å¼ */
    .gallery-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;max-height:300px;overflow-y:auto;border:1px solid rgba(255,255,255,.1);border-radius:6px;padding:8px}
    .gallery-item{position:relative;aspect-ratio:1;border-radius:6px;overflow:hidden;border:2px solid transparent;transition:all 0.2s;cursor:pointer}
    .gallery-item:hover{border-color:rgba(34,211,238,.3);transform:scale(1.02)}
    .gallery-item.selected{border-color:#22d3ee;box-shadow:0 0 12px rgba(34,211,238,.4)}
    .gallery-item img{width:100%;height:100%;object-fit:cover}
    .gallery-item-checkbox{position:absolute;top:4px;left:4px;width:16px;height:16px;cursor:pointer;z-index:2}
    .gallery-item-delete{position:absolute;top:4px;right:4px;background:rgba(239,68,68,0.8);color:white;border:none;border-radius:50%;width:18px;height:18px;font-size:10px;font-weight:bold;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;z-index:2}
    .gallery-item-delete:hover{background:rgba(239,68,68,1);transform:scale(1.1)}
    .gallery-group-option{padding:8px;border-bottom:1px solid rgba(255,255,255,.1);cursor:pointer;transition:background-color 0.2s}
    .gallery-group-option:hover{background:rgba(255,255,255,.05)}
    .gallery-group-option.selected{background:rgba(34,211,238,.1);color:#22d3ee}
    
    /* å›¾åº“è¾“å…¥æ¡†æ ·å¼ */
    .modal-input {
      width: 100%;
      padding: 10px;
      background: rgba(0,0,0,0.2);
      border: 1px solid rgba(255,255,255,.1);
      border-radius: 6px;
      color: var(--text);
      font-size: 0.9rem;
      margin-bottom: 20px;
    }
    
    .modal-input:focus {
      outline: 2px solid var(--accent);
      border-color: var(--accent);
    }
    
    @media (max-width: 768px) {
      .grid{grid-template-columns:1fr}
      .wrap{padding:8px}
    }
  </style>
</head>
<body>
  <header class="wrap">
    <h1>ğŸ¨ Stylize Video</h1>
    <div class="tiny">
      <span id="connectionStatus" class="status-indicator status-connecting"></span>
      <span id="connectionText">è¿æ¥ä¸­...</span>
    </div>
  </header>

  <main class="wrap grid">
    <!-- å·¦ï¼šé…ç½®ä¸æ“ä½œ -->
    <section class="card">
      <h2>1) é…ç½® & ç”Ÿæˆ</h2>
      <div class="body">
        <!-- æ¨¡å¼é€‰æ‹© -->
        <div style="margin-bottom: 16px">
          <label>ç”Ÿæˆæ¨¡å¼</label>
          <div style="display:flex;gap:8px;margin-top:4px">
            <button type="button" id="newTaskBtn" class="mode-btn active" onclick="switchMode('new')">æ–°ä»»åŠ¡</button>
            <button type="button" id="imageOnlyBtn" class="mode-btn" onclick="switchMode('image-only')">ä»…ç”Ÿæˆå›¾ç‰‡</button>
            <button type="button" id="historyTaskBtn" class="mode-btn" onclick="switchMode('history')">å†å²ä»»åŠ¡</button>
            <button type="button" id="galleryBtn" class="mode-btn" onclick="switchMode('gallery')">æˆ‘çš„å›¾åº“</button>
          </div>
        </div>

        <!-- æ–°ä»»åŠ¡æ¨¡å¼ -->
        <div id="newTaskMode">
          <form id="newTaskForm" onsubmit="return false;">
            <label>OpenRouter API Key</label>
            <input id="apiKey" type="password" placeholder="sk-or-v1-..." />

            <label style="margin-top:10px">ä¸Šä¼ åŸå›¾</label>
            <input id="inputImage" type="file" accept="image/*" />
          <div class="preview-container" style="margin-top:8px">
            <img id="origPreview" class="preview-img" style="display:none" alt="åŸå›¾é¢„è§ˆ" />
          </div>

          <label style="margin-top:10px">é€‰æ‹©æœ¬åœ°èƒŒæ™¯éŸ³ä¹ï¼ˆå¯é€‰ï¼‰</label>
          <input id="bgmFile" type="file" accept="audio/*" />

          <details style="margin-top:16px">
            <summary>âš™ï¸ é«˜çº§é…ç½®</summary>
            <div class="config-grid">
              <div>
                <label>é£æ ¼å›¾æ•°é‡</label>
                <input id="slideCount" type="number" value="2" min="1" max="20" />
              </div>
              <div>
                <label>å¸§ç‡ (FPS)</label>
                <input id="videoFps" type="number" value="30" min="15" max="60" />
              </div>
              <div>
                <label>æ¯å¼ å›¾æŒç»­æ—¶é—´ (ç§’)</label>
                <input id="perSlideSeconds" type="number" value="3.0" min="0.5" max="5" step="0.1" />
              </div>
              <div>
                <label>è¿‡æ¸¡æ—¶é—´ (ç§’)</label>
                <input id="transitionSeconds" type="number" value="0.6" min="0" max="1" step="0.1" />
              </div>
              <div style="grid-column: span 2">
                <label>è½¬åœºæ•ˆæœé€‰æ‹© (å¯å¤šé€‰ï¼Œå¾ªç¯ä½¿ç”¨)</label>
                <div style="display:flex;gap:4px;margin:4px 0;font-size:10px">
                  <button type="button" onclick="selectAllTransitions()" style="padding:2px 6px;font-size:10px;width:auto">å…¨é€‰</button>
                  <button type="button" onclick="selectNoneTransitions()" style="padding:2px 6px;font-size:10px;width:auto">æ¸…ç©º</button>
                  <button type="button" onclick="selectSlideTransitions()" style="padding:2px 6px;font-size:10px;width:auto">åªé€‰æ»‘åŠ¨</button>
                  <button type="button" onclick="selectFadeTransitions()" style="padding:2px 6px;font-size:10px;width:auto">åªé€‰æ·¡åŒ–</button>
                </div>
                <div id="transitionEffects" style="display:grid;grid-template-columns:repeat(4,1fr);gap:4px;margin-top:4px;max-height:120px;overflow-y:auto;border:1px solid rgba(255,255,255,.1);border-radius:6px;padding:8px">
                  <!-- è½¬åœºæ•ˆæœé€‰é¡¹å°†ç”±JavaScriptç”Ÿæˆ -->
                </div>
              </div>
              <div>
                <label>è§†é¢‘å®½åº¦</label>
                <select id="videoWidth">
                  <option value="720">720 (æŠ–éŸ³ç«–å±)</option>
                  <option value="1280">1280 (720p)</option>
                  <option value="1920">1920 (1080p)</option>
                  <option value="854">854 (480p)</option>
                </select>
              </div>
              <div>
                <label>è§†é¢‘é«˜åº¦</label>
                <select id="videoHeight">
                  <option value="1280">1280 (æŠ–éŸ³ç«–å±)</option>
                  <option value="720">720</option>
                  <option value="1080">1080</option>
                  <option value="480">480</option>
                </select>
              </div>
              <div>
                <label>å¹¶å‘è¯·æ±‚æ•°</label>
                <input id="concurrentLimit" type="number" value="1" min="1" max="5" />
              </div>
              <div style="display:flex;align-items:center;padding-top:20px">
                <label style="margin:0">
                  <input id="includeOriginal" type="checkbox" checked style="width:auto;margin-right:6px" /> 
                  åœ¨è§†é¢‘ä¸­åŒ…å«åŸå›¾
                </label>
              </div>
            </div>
          </details>
          </form>
        </div>

        <!-- ä»…ç”Ÿæˆå›¾ç‰‡æ¨¡å¼ -->
        <div id="imageOnlyMode" style="display:none">
          <form id="imageOnlyForm" onsubmit="return false;">
            <label>OpenRouter API Key</label>
            <input id="imageApiKey" type="password" placeholder="sk-or-v1-..." />

          <label style="margin-top:10px">ä¸Šä¼ åŸå›¾</label>
          <input id="imageInputImage" type="file" accept="image/*" />
          <div class="preview-container" style="margin-top:8px">
            <img id="imageOrigPreview" class="preview-img" style="display:none" alt="åŸå›¾é¢„è§ˆ" />
          </div>

          <details style="margin-top:16px">
            <summary>âš™ï¸ ç”Ÿæˆé…ç½®</summary>
            <div class="config-grid">
              <div>
                <label>é£æ ¼å›¾æ•°é‡</label>
                <input id="imageSlideCount" type="number" value="2" min="1" max="20" />
              </div>
              <div>
                <label>å¹¶å‘è¯·æ±‚æ•°</label>
                <input id="imageConcurrentLimit" type="number" value="1" min="1" max="5" />
              </div>
            </div>
          </details>
          
          <!-- å›¾ç‰‡é€‰æ‹©ç®¡ç†åŒºåŸŸ -->
          <div id="imageSelectionArea" style="display:none;margin-top:16px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <h3 style="font-size:14px;margin:0">é€‰æ‹©è¦åŒ…å«çš„å›¾ç‰‡</h3>
              <div style="display:flex;gap:8px">
                <button type="button" onclick="selectAllImages()" style="padding:4px 8px;font-size:11px;width:auto">å…¨é€‰</button>
                <button type="button" onclick="selectNoneImages()" style="padding:4px 8px;font-size:11px;width:auto">å…¨ä¸é€‰</button>
              </div>
            </div>
            <div id="imageGallerySelection" class="gallery">
              <!-- å›¾ç‰‡é€‰æ‹©åˆ—è¡¨å°†ç”±JavaScriptç”Ÿæˆ -->
            </div>
            
            <!-- è§†é¢‘åˆæˆé…ç½® -->
            <details style="margin-top:16px">
              <summary>âš™ï¸ è§†é¢‘åˆæˆé…ç½®</summary>
              <div class="config-grid">
                <div>
                  <label>å¸§ç‡ (FPS)</label>
                  <input id="composeVideoFps" type="number" value="30" min="15" max="60" />
                </div>
                <div>
                  <label>æ¯å¼ å›¾æŒç»­æ—¶é—´ (ç§’)</label>
                  <input id="composePerSlideSeconds" type="number" value="3.0" min="0.5" max="5" step="0.1" />
                </div>
                <div>
                  <label>è¿‡æ¸¡æ—¶é—´ (ç§’)</label>
                  <input id="composeTransitionSeconds" type="number" value="0.6" min="0" max="1" step="0.1" />
                </div>
                <div>
                  <label>è§†é¢‘å®½åº¦</label>
                  <select id="composeVideoWidth">
                    <option value="720">720 (æŠ–éŸ³ç«–å±)</option>
                    <option value="1280">1280 (720p)</option>
                    <option value="1920">1920 (1080p)</option>
                    <option value="854">854 (480p)</option>
                  </select>
                </div>
                <div>
                  <label>è§†é¢‘é«˜åº¦</label>
                  <select id="composeVideoHeight">
                    <option value="1280">1280 (æŠ–éŸ³ç«–å±)</option>
                    <option value="720">720</option>
                    <option value="1080">1080</option>
                    <option value="480">480</option>
                  </select>
                </div>
                <div style="grid-column: span 2">
                  <label>è½¬åœºæ•ˆæœé€‰æ‹© (å¯å¤šé€‰ï¼Œå¾ªç¯ä½¿ç”¨)</label>
                  <div style="display:flex;gap:4px;margin:4px 0;font-size:10px">
                    <button type="button" onclick="selectAllComposeTransitions()" style="padding:2px 6px;font-size:10px;width:auto">å…¨é€‰</button>
                    <button type="button" onclick="selectNoneComposeTransitions()" style="padding:2px 6px;font-size:10px;width:auto">æ¸…ç©º</button>
                    <button type="button" onclick="selectSlideComposeTransitions()" style="padding:2px 6px;font-size:10px;width:auto">åªé€‰æ»‘åŠ¨</button>
                    <button type="button" onclick="selectFadeComposeTransitions()" style="padding:2px 6px;font-size:10px;width:auto">åªé€‰æ·¡åŒ–</button>
                  </div>
                  <div id="composeTransitionEffects" style="display:grid;grid-template-columns:repeat(4,1fr);gap:4px;margin-top:4px;max-height:120px;overflow-y:auto;border:1px solid rgba(255,255,255,.1);border-radius:6px;padding:8px">
                    <!-- è½¬åœºæ•ˆæœé€‰é¡¹å°†ç”±JavaScriptç”Ÿæˆ -->
                  </div>
                </div>
                <div style="display:flex;align-items:center;padding-top:20px">
                  <label style="margin:0">
                    <input id="composeIncludeOriginal" type="checkbox" checked style="width:auto;margin-right:6px" /> 
                    åœ¨è§†é¢‘ä¸­åŒ…å«åŸå›¾
                  </label>
                </div>
              </div>
            </details>
            
            <label style="margin-top:10px">é€‰æ‹©æœ¬åœ°èƒŒæ™¯éŸ³ä¹ï¼ˆå¯é€‰ï¼‰</label>
            <input id="composeBgmFile" type="file" accept="audio/*" />
          </div>
        </div>

        <!-- å†å²ä»»åŠ¡æ¨¡å¼ -->
        <div id="historyTaskMode" style="display:none">
          <div style="margin-bottom:10px">
            <button type="button" onclick="loadHistoryTasks()" style="width:auto;padding:8px 16px">åˆ·æ–°åˆ—è¡¨</button>
          </div>
          <div id="historyTasksList" style="max-height:400px;overflow-y:auto">
            <!-- å†å²ä»»åŠ¡åˆ—è¡¨å°†ç”±JavaScriptç”Ÿæˆ -->
          </div>
          
          <!-- é€‰ä¸­ä»»åŠ¡çš„é…ç½® -->
          <div id="historyTaskConfig" style="display:none;margin-top:16px">
            <h3 style="font-size:14px;margin:0 0 12px 0">é‡æ–°ç”Ÿæˆé…ç½®</h3>
            <div class="config-grid">
              <div>
                <label>å¸§ç‡ (FPS)</label>
                <input id="historyVideoFps" type="number" value="30" min="15" max="60" />
              </div>
              <div>
                <label>æ¯å¼ å›¾æŒç»­æ—¶é—´ (ç§’)</label>
                <input id="historyPerSlideSeconds" type="number" value="3.0" min="0.5" max="5" step="0.1" />
              </div>
              <div>
                <label>å›¾ç‰‡å¾ªç¯å€æ•°</label>
                <input id="historyImageMultiplier" type="number" value="1" min="1" max="10" title="è®¾ç½®å›¾ç‰‡å¾ªç¯å€æ•°ï¼Œå¦‚3å¼ å›¾ç‰‡è®¾ç½®3å€åˆ™å¾ªç¯ä¸º: 1-2-3-1-2-3-1-2-3" />
              </div>
              <div>
                <label>è¿‡æ¸¡æ—¶é—´ (ç§’)</label>
                <input id="historyTransitionSeconds" type="number" value="0.6" min="0" max="1" step="0.1" />
              </div>
              <div>
                <label>è§†é¢‘å®½åº¦</label>
                <select id="historyVideoWidth">
                  <option value="720">720 (æŠ–éŸ³ç«–å±)</option>
                  <option value="1280">1280 (720p)</option>
                  <option value="1920">1920 (1080p)</option>
                  <option value="854">854 (480p)</option>
                </select>
              </div>
              <div>
                <label>è§†é¢‘é«˜åº¦</label>
                <select id="historyVideoHeight">
                  <option value="1280">1280 (æŠ–éŸ³ç«–å±)</option>
                  <option value="720">720</option>
                  <option value="1080">1080</option>
                  <option value="480">480</option>
                </select>
              </div>
              <div>
                <label>èƒŒæ™¯éŸ³ä¹ (å¯é€‰)</label>
                <input id="historyBgmFile" type="file" accept="audio/*" />
              </div>
              <div style="grid-column: span 2">
                <label>è½¬åœºæ•ˆæœé€‰æ‹©</label>
                <div style="display:flex;gap:4px;margin:4px 0;font-size:10px">
                  <button type="button" onclick="selectAllHistoryTransitions()" style="padding:2px 6px;font-size:10px;width:auto">å…¨é€‰</button>
                  <button type="button" onclick="selectNoneHistoryTransitions()" style="padding:2px 6px;font-size:10px;width:auto">æ¸…ç©º</button>
                  <button type="button" onclick="selectSlideHistoryTransitions()" style="padding:2px 6px;font-size:10px;width:auto">åªé€‰æ»‘åŠ¨</button>
                  <button type="button" onclick="selectFadeHistoryTransitions()" style="padding:2px 6px;font-size:10px;width:auto">åªé€‰æ·¡åŒ–</button>
                </div>
                <div id="historyTransitionEffects" style="display:grid;grid-template-columns:repeat(4,1fr);gap:4px;margin-top:4px;max-height:120px;overflow-y:auto;border:1px solid rgba(255,255,255,.1);border-radius:6px;padding:8px">
                  <!-- è½¬åœºæ•ˆæœé€‰é¡¹å°†ç”±JavaScriptç”Ÿæˆ -->
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- æˆ‘çš„å›¾åº“æ¨¡å¼ -->
        <div id="galleryMode" style="display:none">
          <!-- åˆ†ç»„ç®¡ç† -->
          <div style="margin-bottom:16px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <h3 style="font-size:14px;margin:0">å›¾ç‰‡åˆ†ç»„ç®¡ç†</h3>
              <div style="display:flex;gap:8px">
                <button type="button" onclick="createNewGalleryGroup()" style="padding:4px 8px;font-size:11px;width:auto">æ–°å»ºåˆ†ç»„</button>
                <button type="button" onclick="loadGalleryGroups()" style="padding:4px 8px;font-size:11px;width:auto">åˆ·æ–°</button>
              </div>
            </div>
            
            <!-- åˆ†ç»„é€‰æ‹©ä¸‹æ‹‰æ¡† -->
            <select id="galleryGroupSelect" onchange="selectGalleryGroup()" style="width:100%;margin-bottom:8px">
              <option value="">é€‰æ‹©æˆ–åˆ›å»ºåˆ†ç»„...</option>
            </select>
            
            <!-- åˆ†ç»„ç®¡ç†æŒ‰é’® -->
            <div id="galleryGroupActions" style="display:none;gap:8px;margin-bottom:8px">
              <button type="button" onclick="renameGalleryGroup()" style="padding:4px 8px;font-size:11px;width:auto">é‡å‘½ååˆ†ç»„</button>
              <button type="button" onclick="deleteGalleryGroup()" style="padding:4px 8px;font-size:11px;width:auto;background:#dc3545;color:white">åˆ é™¤åˆ†ç»„</button>
            </div>
          </div>
          
          <!-- å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ -->
          <div id="galleryUploadArea" style="display:none;margin-bottom:16px">
            <label>ä¸Šä¼ å›¾ç‰‡åˆ°å½“å‰åˆ†ç»„</label>
            <input id="galleryImageUpload" type="file" accept="image/*" multiple />
            <div style="font-size:11px;color:var(--muted);margin-top:4px">æ”¯æŒå¤šé€‰ä¸Šä¼ ï¼Œå›¾ç‰‡å°†è¢«æ·»åŠ åˆ°å½“å‰é€‰ä¸­çš„åˆ†ç»„ä¸­</div>
          </div>
          
          <!-- å›¾ç‰‡ç½‘æ ¼æ˜¾ç¤ºåŒºåŸŸ -->
          <div id="galleryImagesArea" style="display:none">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div style="font-size:14px;font-weight:bold" id="galleryGroupTitle">åˆ†ç»„ä¸­çš„å›¾ç‰‡</div>
              <div style="display:flex;gap:8px">
                <button type="button" onclick="selectAllGalleryImages()" style="padding:4px 8px;font-size:11px;width:auto">å…¨é€‰</button>
                <button type="button" onclick="selectNoneGalleryImages()" style="padding:4px 8px;font-size:11px;width:auto">å…¨ä¸é€‰</button>
                <button type="button" onclick="deleteSelectedGalleryImages()" style="padding:4px 8px;font-size:11px;width:auto;background:#dc3545;color:white">åˆ é™¤é€‰ä¸­</button>
              </div>
            </div>
            <div id="galleryImagesGrid" class="gallery-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;max-height:300px;overflow-y:auto;border:1px solid rgba(255,255,255,.1);border-radius:6px;padding:8px">
              <!-- å›¾ç‰‡å°†ç”±JavaScriptç”Ÿæˆ -->
            </div>
          </div>
          
          <!-- ç”Ÿæˆè§†é¢‘é…ç½® -->
          <div id="galleryVideoConfig" style="display:none;margin-top:16px">
            <h3 style="font-size:14px;margin:0 0 12px 0">ä»å›¾åº“ç”Ÿæˆè§†é¢‘</h3>
            <div class="config-grid">
              <div>
                <label>å¸§ç‡ (FPS)</label>
                <input id="galleryVideoFps" type="number" value="30" min="15" max="60" />
              </div>
              <div>
                <label>æ¯å¼ å›¾æŒç»­æ—¶é—´ (ç§’)</label>
                <input id="galleryPerSlideSeconds" type="number" value="3.0" min="0.5" max="5" step="0.1" />
              </div>
              <div>
                <label>å›¾ç‰‡å¾ªç¯å€æ•°</label>
                <input id="galleryImageMultiplier" type="number" value="1" min="1" max="10" title="è®¾ç½®å›¾ç‰‡å¾ªç¯å€æ•°ï¼Œå¦‚3å¼ å›¾ç‰‡è®¾ç½®3å€åˆ™å¾ªç¯ä¸º: 1-2-3-1-2-3-1-2-3" />
              </div>
              <div>
                <label>è¿‡æ¸¡æ—¶é—´ (ç§’)</label>
                <input id="galleryTransitionSeconds" type="number" value="0.6" min="0" max="1" step="0.1" />
              </div>
              <div>
                <label>è§†é¢‘å®½åº¦</label>
                <select id="galleryVideoWidth">
                  <option value="720">720 (æŠ–éŸ³ç«–å±)</option>
                  <option value="1280">1280 (720p)</option>
                  <option value="1920">1920 (1080p)</option>
                  <option value="854">854 (480p)</option>
                </select>
              </div>
              <div>
                <label>è§†é¢‘é«˜åº¦</label>
                <select id="galleryVideoHeight">
                  <option value="1280">1280 (æŠ–éŸ³ç«–å±)</option>
                  <option value="720">720</option>
                  <option value="1080">1080</option>
                  <option value="480">480</option>
                </select>
              </div>
              <div>
                <label>èƒŒæ™¯éŸ³ä¹ (å¯é€‰)</label>
                <input id="galleryBgmFile" type="file" accept="audio/*" />
              </div>
              <div style="grid-column: span 2">
                <label>è½¬åœºæ•ˆæœé€‰æ‹©</label>
                <div style="display:flex;gap:4px;margin:4px 0;font-size:10px">
                  <button type="button" onclick="selectAllGalleryTransitions()" style="padding:2px 6px;font-size:10px;width:auto">å…¨é€‰</button>
                  <button type="button" onclick="selectNoneGalleryTransitions()" style="padding:2px 6px;font-size:10px;width:auto">æ¸…ç©º</button>
                  <button type="button" onclick="selectSlideGalleryTransitions()" style="padding:2px 6px;font-size:10px;width:auto">åªé€‰æ»‘åŠ¨</button>
                  <button type="button" onclick="selectFadeGalleryTransitions()" style="padding:2px 6px;font-size:10px;width:auto">åªé€‰æ·¡åŒ–</button>
                </div>
                <div id="galleryTransitionEffects" style="display:grid;grid-template-columns:repeat(4,1fr);gap:4px;margin-top:4px;max-height:120px;overflow-y:auto;border:1px solid rgba(255,255,255,.1);border-radius:6px;padding:8px">
                  <!-- è½¬åœºæ•ˆæœé€‰é¡¹å°†ç”±JavaScriptç”Ÿæˆ -->
                </div>
              </div>
              <div style="display:flex;align-items:center;padding-top:20px">
                <label style="margin:0">
                  <input id="galleryIncludeOriginal" type="checkbox" style="width:auto;margin-right:6px" /> 
                  åœ¨è§†é¢‘ä¸­åŒ…å«åŸå›¾
                </label>
              </div>
            </div>
          </div>
        </div>

        <div style="margin-top:14px" class="row">
          <button id="startBtn">å¼€å§‹ç”Ÿæˆå¹¶åˆæˆè§†é¢‘</button>
        </div>

        <div id="taskStatus" class="task-status" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <span id="taskMessage">å‡†å¤‡ä¸­...</span>
            <span id="taskProgress">0%</span>
          </div>
          <progress id="prog" value="0" max="100"></progress>
          <div id="log" class="log" style="margin-top:8px;max-height:150px"></div>
        </div>
      </div>
    </section>

    <!-- å³ï¼šç»“æœé¢„è§ˆ -->
    <section class="card">
      <h2>2) ç»“æœ & ä¸‹è½½</h2>
      <div class="body">
        <div id="imagesSection">
          <div class="muted tiny">ç”Ÿæˆçš„é£æ ¼åŒ–å›¾ç‰‡</div>
          <div id="gallery" class="gallery"></div>
        </div>
        
        <div id="videoSection" class="video-container" style="display:none">
          <div class="muted tiny">åˆæˆè§†é¢‘</div>
          <video id="videoOut" class="video-player" controls playsinline></video>
          <div class="row" style="margin-top:8px">
            <a id="dlVideo" class="pill" download="stylized_slideshow.mp4">ğŸ“¥ ä¸‹è½½è§†é¢‘</a>
            <a id="dlOrig" class="pill" download="original.jpg">ğŸ“¸ ä¸‹è½½åŸå›¾</a>
          </div>
        </div>

        <div id="statsSection" style="margin-top:16px;display:none">
          <div class="tiny muted">ç”Ÿæˆç»Ÿè®¡</div>
          <div id="stats" style="font-size:11px;color:var(--muted);margin-top:4px"></div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="tiny" id="footerInfo">AIé©±åŠ¨çš„è§†é¢‘é£æ ¼è½¬æ¢å·¥å…· - å®Œå…¨æœ¬åœ°è¿è¡Œï¼Œä¿æŠ¤éšç§å®‰å…¨</div>
  </footer>

  <!-- è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡† -->
  <div id="customModal" class="custom-modal">
    <div class="modal-content">
      <div class="modal-icon">âš ï¸</div>
      <div class="modal-title">ç¡®è®¤åˆ é™¤</div>
      <div class="modal-message">ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿåˆ é™¤åå°†æ— æ³•æ¢å¤ã€‚</div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" onclick="hideCustomModal(false)">å–æ¶ˆ</button>
        <button class="modal-btn modal-btn-confirm" onclick="hideCustomModal(true)">åˆ é™¤</button>
      </div>
    </div>
  </div>

<script>
(function(){
  // APIé…ç½®
  const API_BASE = '/api';
  
  // DOMå…ƒç´ 
  const el = (id) => document.getElementById(id);
  const apiKeyInput = el('apiKey');
  const inputImage = el('inputImage');
  const bgmFile = el('bgmFile');
  const startBtn = el('startBtn');
  const origPreview = el('origPreview');
  const gallery = el('gallery');
  const videoOut = el('videoOut');
  const dlVideo = el('dlVideo');
  const dlOrig = el('dlOrig');
  const taskStatus = el('taskStatus');
  const taskMessage = el('taskMessage');
  const taskProgress = el('taskProgress');
  const prog = el('prog');
  const logBox = el('log');
  const connectionStatus = el('connectionStatus');
  const connectionText = el('connectionText');
  const videoSection = el('videoSection');
  const statsSection = el('statsSection');

  // é…ç½®æ§ä»¶
  const slideCountInput = el('slideCount');
  const videoFpsInput = el('videoFps');
  const perSlideSecondsInput = el('perSlideSeconds');
  const transitionSecondsInput = el('transitionSeconds');
  const videoWidthSelect = el('videoWidth');
  const videoHeightSelect = el('videoHeight');
  const includeOriginalCheckbox = el('includeOriginal');
  const concurrentLimitInput = el('concurrentLimit');
  const transitionEffectsContainer = el('transitionEffects');

  // å†å²ä»»åŠ¡ç›¸å…³å…ƒç´ 
  const newTaskMode = el('newTaskMode');
  const historyTaskMode = el('historyTaskMode');
  const historyTasksList = el('historyTasksList');
  const historyTaskConfig = el('historyTaskConfig');
  const historyVideoFpsInput = el('historyVideoFps');
  const historyPerSlideSecondsInput = el('historyPerSlideSeconds');
  const historyTransitionSecondsInput = el('historyTransitionSeconds');
  const historyImageMultiplierInput = el('historyImageMultiplier');
  const historyVideoWidthSelect = el('historyVideoWidth');
  const historyVideoHeightSelect = el('historyVideoHeight');
  const historyBgmFile = el('historyBgmFile');
  const historyTransitionEffectsContainer = el('historyTransitionEffects');

  // æ–°å¢ï¼šä»…ç”Ÿæˆå›¾ç‰‡æ¨¡å¼ç›¸å…³å…ƒç´ 
  const imageOnlyMode = el('imageOnlyMode');
  const imageApiKeyInput = el('imageApiKey');
  const imageInputImage = el('imageInputImage');
  const imageOrigPreview = el('imageOrigPreview');
  const imageSlideCountInput = el('imageSlideCount');
  const imageConcurrentLimitInput = el('imageConcurrentLimit');
  const imageSelectionArea = el('imageSelectionArea');
  const imageGallerySelection = el('imageGallerySelection');
  const composeVideoFpsInput = el('composeVideoFps');
  const composePerSlideSecondsInput = el('composePerSlideSeconds');
  const composeTransitionSecondsInput = el('composeTransitionSeconds');
  const composeVideoWidthSelect = el('composeVideoWidth');
  const composeVideoHeightSelect = el('composeVideoHeight');
  const composeTransitionEffectsContainer = el('composeTransitionEffects');
  const composeIncludeOriginalCheckbox = el('composeIncludeOriginal');
  const composeBgmFile = el('composeBgmFile');

  // å¯ç”¨çš„è½¬åœºæ•ˆæœåˆ—è¡¨
  const availableTransitions = [
    { value: 'slideleft', label: 'å·¦æ»‘' },
    { value: 'slideright', label: 'å³æ»‘' },
    { value: 'slideup', label: 'ä¸Šæ»‘' },
    { value: 'slidedown', label: 'ä¸‹æ»‘' },
    { value: 'wipeleft', label: 'å·¦æ“¦é™¤' },
    { value: 'wiperight', label: 'å³æ“¦é™¤' },
    { value: 'wipeup', label: 'ä¸Šæ“¦é™¤' },
    { value: 'wipedown', label: 'ä¸‹æ“¦é™¤' },
    { value: 'fadeblack', label: 'é»‘è‰²æ·¡å…¥' },
    { value: 'fadewhite', label: 'ç™½è‰²æ·¡å…¥' },
    { value: 'dissolve', label: 'æº¶è§£' },
    { value: 'pixelize', label: 'åƒç´ åŒ–' },
    { value: 'circlecrop', label: 'åœ†å½¢è£åˆ‡' },
    { value: 'rectcrop', label: 'çŸ©å½¢è£åˆ‡' },
    { value: 'distance', label: 'è·ç¦»' },
    { value: 'radial', label: 'å¾„å‘' },
    { value: 'smoothleft', label: 'å¹³æ»‘å·¦ç§»' },
    { value: 'smoothright', label: 'å¹³æ»‘å³ç§»' },
    { value: 'smoothup', label: 'å¹³æ»‘ä¸Šç§»' },
    { value: 'smoothdown', label: 'å¹³æ»‘ä¸‹ç§»' },
    { value: 'circleopen', label: 'åœ†å½¢å¼€å¯' },
    { value: 'circleclose', label: 'åœ†å½¢å…³é—­' },
    { value: 'vertopen', label: 'å‚ç›´å¼€å¯' },
    { value: 'vertclose', label: 'å‚ç›´å…³é—­' },
    { value: 'horzopen', label: 'æ°´å¹³å¼€å¯' },
    { value: 'horzclose', label: 'æ°´å¹³å…³é—­' },
    { value: 'diagtl', label: 'å¯¹è§’å·¦ä¸Š' },
    { value: 'diagtr', label: 'å¯¹è§’å³ä¸Š' },
    { value: 'diagbl', label: 'å¯¹è§’å·¦ä¸‹' },
    { value: 'diagbr', label: 'å¯¹è§’å³ä¸‹' },
    { value: 'hlslice', label: 'æ°´å¹³å·¦åˆ‡ç‰‡' },
    { value: 'hrslice', label: 'æ°´å¹³å³åˆ‡ç‰‡' },
    { value: 'vuslice', label: 'å‚ç›´ä¸Šåˆ‡ç‰‡' },
    { value: 'vdslice', label: 'å‚ç›´ä¸‹åˆ‡ç‰‡' },
    { value: 'hblur', label: 'æ°´å¹³æ¨¡ç³Š' },
    { value: 'fadegrays', label: 'ç°åº¦æ·¡åŒ–' },
    { value: 'wipetl', label: 'å·¦ä¸Šæ“¦é™¤' },
    { value: 'wipetr', label: 'å³ä¸Šæ“¦é™¤' },
    { value: 'wipebl', label: 'å·¦ä¸‹æ“¦é™¤' },
    { value: 'wipebr', label: 'å³ä¸‹æ“¦é™¤' },
    { value: 'squeezeh', label: 'æ°´å¹³æŒ¤å‹' },
    { value: 'squeezev', label: 'å‚ç›´æŒ¤å‹' },
    { value: 'zoomin', label: 'æ”¾å¤§' },
    { value: 'fadefast', label: 'å¿«é€Ÿæ·¡åŒ–' },
    { value: 'fadeslow', label: 'ç¼“æ…¢æ·¡åŒ–' },
    { value: 'hlwind', label: 'æ°´å¹³å·¦é£' },
    { value: 'hrwind', label: 'æ°´å¹³å³é£' },
    { value: 'vuwind', label: 'å‚ç›´ä¸Šé£' },
    { value: 'vdwind', label: 'å‚ç›´ä¸‹é£' },
    { value: 'coverleft', label: 'å·¦è¦†ç›–' },
    { value: 'coverright', label: 'å³è¦†ç›–' },
    { value: 'coverup', label: 'ä¸Šè¦†ç›–' },
    { value: 'coverdown', label: 'ä¸‹è¦†ç›–' },
    { value: 'revealleft', label: 'å·¦æ­ç¤º' },
    { value: 'revealright', label: 'å³æ­ç¤º' },
    { value: 'revealup', label: 'ä¸Šæ­ç¤º' },
    { value: 'revealdown', label: 'ä¸‹æ­ç¤º' }
  ];

  // å…¨å±€å˜é‡ç”¨äºå¤„ç†æ¨¡æ€å¯¹è¯æ¡†çš„å›è°ƒ
  let modalCallback = null;

  // æ˜¾ç¤ºè‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†ï¼ˆè¿”å›Promiseï¼‰
  function showCustomConfirm(title, message, confirmText = 'ç¡®è®¤', cancelText = 'å–æ¶ˆ') {
    return new Promise((resolve) => {
      const modal = document.getElementById('customModal');
      const titleEl = modal.querySelector('.modal-title');
      const messageEl = modal.querySelector('.modal-message');
      const confirmBtn = modal.querySelector('.modal-btn-confirm');
      const cancelBtn = modal.querySelector('.modal-btn-cancel');
      
      // è®¾ç½®å†…å®¹
      titleEl.textContent = title;
      messageEl.textContent = message;
      confirmBtn.textContent = confirmText;
      cancelBtn.textContent = cancelText;
      
      // é‡ç½®ç‚¹å‡»äº‹ä»¶ï¼ˆé¿å…ä¹‹å‰çš„äº‹ä»¶å¹²æ‰°ï¼‰
      confirmBtn.onclick = () => {
        hideCustomModal();
        resolve(true);
      };
      
      cancelBtn.onclick = () => {
        hideCustomModal();
        resolve(false);
      };
      
      // æ˜¾ç¤ºæ¨¡æ€æ¡†
      modal.classList.add('show');
      
      // ESCé”®æ”¯æŒ
      const handleEscape = (event) => {
        if (event.key === 'Escape') {
          document.removeEventListener('keydown', handleEscape);
          hideCustomModal();
          resolve(false);
        }
      };
      
      document.addEventListener('keydown', handleEscape);
      
      // ç‚¹å‡»å¤–éƒ¨åŒºåŸŸå…³é—­
      const handleOutsideClick = (event) => {
        if (event.target === modal) {
          document.removeEventListener('click', handleOutsideClick);
          hideCustomModal();
          resolve(false);
        }
      };
      
      setTimeout(() => {
        document.addEventListener('click', handleOutsideClick);
      }, 100); // å»¶è¿Ÿæ·»åŠ ï¼Œé¿å…ç«‹å³è§¦å‘
    });
  }

  // éšè—è‡ªå®šä¹‰æ¨¡æ€å¯¹è¯æ¡†
  function hideCustomModal() {
    const modal = document.getElementById('customModal');
    modal.classList.remove('show');
  }

  // æ˜¾ç¤ºè‡ªå®šä¹‰æ¨¡æ€å¯¹è¯æ¡†
  function showCustomModal(message, callback) {
    const modal = document.getElementById('customModal');
    const messageEl = modal.querySelector('.modal-message');
    
    messageEl.textContent = message;
    modalCallback = callback;
    
    modal.classList.add('show');
    
    // ç›‘å¬ ESC é”®å…³é—­å¯¹è¯æ¡†
    document.addEventListener('keydown', handleModalEscape);
  }

  // éšè—è‡ªå®šä¹‰æ¨¡æ€å¯¹è¯æ¡†
  function hideCustomModal(confirmed) {
    const modal = document.getElementById('customModal');
    modal.classList.remove('show');
    
    // ç§»é™¤ ESC é”®ç›‘å¬
    document.removeEventListener('keydown', handleModalEscape);
    
    // æ‰§è¡Œå›è°ƒ
    if (modalCallback) {
      modalCallback(confirmed);
      modalCallback = null;
    }
  }

  // å¤„ç† ESC é”®æŒ‰ä¸‹
  function handleModalEscape(event) {
    if (event.key === 'Escape') {
      hideCustomModal(false);
    }
  }

  // å°†å‡½æ•°æ·»åŠ åˆ°å…¨å±€ä½œç”¨åŸŸ
  window.showCustomModal = showCustomModal;
  window.showCustomConfirm = showCustomConfirm;
  window.hideCustomModal = hideCustomModal;

  // çŠ¶æ€å˜é‡
  let currentTaskId = null;
  let pollingInterval = null;
  let uploadedImageId = null;
  let uploadedAudioId = null;
  let currentMode = 'new';  // å½“å‰æ¨¡å¼ï¼š'new'ã€'image-only' æˆ– 'history'
  let selectedHistoryTask = null;  // é€‰ä¸­çš„å†å²ä»»åŠ¡
  let historyAudioId = null;  // å†å²ä»»åŠ¡æ¨¡å¼ä¸‹çš„éŸ³é¢‘ID
  let imageOnlyTaskId = null;  // ä»…ç”Ÿæˆå›¾ç‰‡ä»»åŠ¡ID
  let imageOnlyUploadedImageId = null;  // ä»…ç”Ÿæˆå›¾ç‰‡æ¨¡å¼ä¸‹çš„åŸå›¾ ID
  let composeAudioId = null;  // åˆæˆè§†é¢‘æ—¶çš„éŸ³é¢‘ID
  let currentGalleryGroup = null;  // å½“å‰é€‰ä¸­çš„å›¾åº“åˆ†ç»„
  let galleryAudioId = null;  // å›¾åº“æ¨¡å¼ä¸‹çš„éŸ³é¢‘ID

  // åˆå§‹åŒ–
  init();

  async function init() {
    setupEventListeners();
    initTransitionEffects();
    initHistoryTransitionEffects();
    initComposeTransitionEffects();
    initGalleryTransitionEffects();
    updateButtonText();
    await checkConnection();
  }

  function initTransitionEffects() {
    // åˆå§‹åŒ–è½¬åœºæ•ˆæœé€‰æ‹©å™¨
    transitionEffectsContainer.innerHTML = '';
    
    // é»˜è®¤é€‰ä¸­çš„è½¬åœºæ•ˆæœ
    const defaultSelected = ['slideleft', 'slideright', 'slideup', 'slidedown'];
    
    availableTransitions.forEach(transition => {
      const wrapper = document.createElement('div');
      wrapper.className = 'transition-checkbox';
      
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.id = `transition_${transition.value}`;
      checkbox.value = transition.value;
      checkbox.checked = defaultSelected.includes(transition.value);
      
      const label = document.createElement('label');
      label.htmlFor = checkbox.id;
      label.textContent = transition.label;
      
      wrapper.appendChild(checkbox);
      wrapper.appendChild(label);
      transitionEffectsContainer.appendChild(wrapper);
      
      // æ·»åŠ å˜åŒ–äº‹ä»¶
      checkbox.onchange = updateButtonText;
    });
  }

  function initHistoryTransitionEffects() {
    // åˆå§‹åŒ–å†å²ä»»åŠ¡æ¨¡å¼ä¸‹çš„è½¬åœºæ•ˆæœé€‰æ‹©å™¨
    historyTransitionEffectsContainer.innerHTML = '';
    
    // é»˜è®¤é€‰ä¸­çš„è½¬åœºæ•ˆæœ
    const defaultSelected = ['slideleft', 'slideright', 'slideup', 'slidedown'];
    
    availableTransitions.forEach(transition => {
      const wrapper = document.createElement('div');
      wrapper.className = 'transition-checkbox';
      
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.id = `history_transition_${transition.value}`;
      checkbox.value = transition.value;
      checkbox.checked = defaultSelected.includes(transition.value);
      
      const label = document.createElement('label');
      label.htmlFor = checkbox.id;
      label.textContent = transition.label;
      
      wrapper.appendChild(checkbox);
      wrapper.appendChild(label);
      historyTransitionEffectsContainer.appendChild(wrapper);
    });
  }

  function initComposeTransitionEffects() {
    // åˆå§‹åŒ–ä»…ç”Ÿæˆå›¾ç‰‡æ¨¡å¼ä¸‹çš„è½¬åœºæ•ˆæœé€‰æ‹©å™¨
    composeTransitionEffectsContainer.innerHTML = '';
    
    // é»˜è®¤é€‰ä¸­çš„è½¬åœºæ•ˆæœ
    const defaultSelected = ['slideleft', 'slideright', 'slideup', 'slidedown'];
    
    availableTransitions.forEach(transition => {
      const wrapper = document.createElement('div');
      wrapper.className = 'transition-checkbox';
      
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.id = `compose_transition_${transition.value}`;
      checkbox.value = transition.value;
      checkbox.checked = defaultSelected.includes(transition.value);
      
      const label = document.createElement('label');
      label.htmlFor = checkbox.id;
      label.textContent = transition.label;
      
      wrapper.appendChild(checkbox);
      wrapper.appendChild(label);
      composeTransitionEffectsContainer.appendChild(wrapper);
    });
  }

  function initGalleryTransitionEffects() {
    // åˆå§‹åŒ–å›¾åº“æ¨¡å¼ä¸‹çš„è½¬åœºæ•ˆæœé€‰æ‹©å™¨
    const galleryTransitionEffectsContainer = el('galleryTransitionEffects');
    galleryTransitionEffectsContainer.innerHTML = '';
    
    // é»˜è®¤é€‰ä¸­çš„è½¬åœºæ•ˆæœ
    const defaultSelected = ['slideleft', 'slideright', 'slideup', 'slidedown'];
    
    availableTransitions.forEach(transition => {
      const wrapper = document.createElement('div');
      wrapper.className = 'transition-checkbox';
      
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.id = `gallery_transition_${transition.value}`;
      checkbox.value = transition.value;
      checkbox.checked = defaultSelected.includes(transition.value);
      
      const label = document.createElement('label');
      label.htmlFor = checkbox.id;
      label.textContent = transition.label;
      
      wrapper.appendChild(checkbox);
      wrapper.appendChild(label);
      galleryTransitionEffectsContainer.appendChild(wrapper);
    });
  }

  function switchMode(mode) {
    currentMode = mode;
    
    // éšè—æ‰€æœ‰æ¨¡å¼
    newTaskMode.style.display = 'none';
    imageOnlyMode.style.display = 'none';
    historyTaskMode.style.display = 'none';
    el('galleryMode').style.display = 'none';
    
    // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„æ´»è·ƒçŠ¶æ€
    el('newTaskBtn').classList.remove('active');
    el('imageOnlyBtn').classList.remove('active');
    el('historyTaskBtn').classList.remove('active');
    el('galleryBtn').classList.remove('active');
    
    if (mode === 'new') {
      newTaskMode.style.display = 'block';
      el('newTaskBtn').classList.add('active');
      startBtn.textContent = 'å¼€å§‹ç”Ÿæˆå¹¶åˆæˆè§†é¢‘';
      // æ¸…ç©ºå…¶ä»–æ¨¡å¼çš„æ˜¾ç¤ºå†…å®¹
      gallery.innerHTML = '';
      videoSection.style.display = 'none';
      statsSection.style.display = 'none';
    } else if (mode === 'image-only') {
      imageOnlyMode.style.display = 'block';
      el('imageOnlyBtn').classList.add('active');
      startBtn.textContent = 'å¼€å§‹ç”Ÿæˆå›¾ç‰‡';
      // æ¸…ç©ºå…¶ä»–æ¨¡å¼çš„æ˜¾ç¤ºå†…å®¹
      gallery.innerHTML = '';
      imageSelectionArea.style.display = 'none';
      videoSection.style.display = 'none';
      statsSection.style.display = 'none';
    } else if (mode === 'history') {
      historyTaskMode.style.display = 'block';
      el('historyTaskBtn').classList.add('active');
      startBtn.textContent = 'ä»å†å²ä»»åŠ¡é‡æ–°ç”Ÿæˆè§†é¢‘';
      // æ¸…ç©ºå›¾ç‰‡æ˜¾ç¤ºï¼Œç­‰å¾…ç”¨æˆ·é€‰æ‹©å†å²ä»»åŠ¡
      gallery.innerHTML = '';
      videoSection.style.display = 'none';
      statsSection.style.display = 'none';
      loadHistoryTasks();
    } else if (mode === 'gallery') {
      el('galleryMode').style.display = 'block';
      el('galleryBtn').classList.add('active');
      startBtn.textContent = 'ä»å›¾åº“ç”Ÿæˆè§†é¢‘';
      // æ¸…ç©ºå›¾ç‰‡æ˜¾ç¤ºï¼Œç­‰å¾…ç”¨æˆ·é€‰æ‹©å›¾åº“åˆ†ç»„
      gallery.innerHTML = '';
      videoSection.style.display = 'none';
      statsSection.style.display = 'none';
      loadGalleryGroups();
    }
    
    updateButtonText();
  }

  async function loadHistoryTasks() {
    try {
      const response = await fetch(`${API_BASE}/history`);
      const data = await response.json();
      
      historyTasksList.innerHTML = '';
      
      if (data.tasks.length === 0) {
        historyTasksList.innerHTML = '<div style="text-align:center;color:var(--muted);padding:20px">æš‚æ— å†å²ä»»åŠ¡</div>';
        return;
      }
      
      data.tasks.forEach(task => {
        const taskElement = document.createElement('div');
        taskElement.className = 'history-task';
        taskElement.onclick = (e) => {
          // é¿å…åœ¨ç‚¹å‡»åˆ é™¤æŒ‰é’®æ—¶è§¦å‘é€‰æ‹©
          if (!e.target.closest('.history-task-delete')) {
            selectHistoryTask(task, e);
          }
        };
        
        const createdDate = new Date(task.created_at).toLocaleString();
        const completedDate = task.completed_at ? new Date(task.completed_at).toLocaleString() : 'æœªå®Œæˆ';
        
        taskElement.innerHTML = `
          <div class="history-task-title">
            ä»»åŠ¡ ${task.task_id.substr(0, 8)}...
            <button class="history-task-delete" onclick="deleteHistoryTask('${task.task_id}', event)" title="åˆ é™¤ä»»åŠ¡">
              Ã—
            </button>
          </div>
          <div class="history-task-info">
            åˆ›å»ºæ—¶é—´: ${createdDate}<br>
            å®Œæˆæ—¶é—´: ${completedDate}<br>
            å›¾ç‰‡æ•°é‡: ${task.image_count} å¼ <br>
            åˆ†è¾¨ç‡: ${task.config ? (task.config.width || 720) : 720}x${task.config ? (task.config.height || 1280) : 1280}
          </div>
        `;
        
        historyTasksList.appendChild(taskElement);
      });
      
    } catch (error) {
      toast(`åŠ è½½å†å²ä»»åŠ¡å¤±è´¥: ${error.message}`, 'err');
    }
  }

  function selectHistoryTask(task, eventParam) {
    selectedHistoryTask = task;
    
    // æ›´æ–°é€‰ä¸­çŠ¶æ€
    document.querySelectorAll('.history-task').forEach(el => el.classList.remove('selected'));
    // ä½¿ç”¨ä¼ å…¥çš„äº‹ä»¶å‚æ•°æˆ–å°è¯•è·å–å½“å‰äº‹ä»¶
    const event = eventParam || window.event;
    if (event && event.target) {
      event.target.closest('.history-task').classList.add('selected');
    }
    
    // æ˜¾ç¤ºé…ç½®é¢æ¿
    historyTaskConfig.style.display = 'block';
    
    // æ˜¾ç¤ºå†å²ä»»åŠ¡çš„å›¾ç‰‡
    if (task.images && task.images.length > 0) {
      gallery.innerHTML = ''; // æ¸…ç©ºå½“å‰æ˜¾ç¤ºçš„å›¾ç‰‡
      updateGallery(task.images);
      toast(`âœ… å·²åŠ è½½ ${task.images.length} å¼ å†å²å›¾ç‰‡`, 'ok');
    }
    
    // æ˜¾ç¤ºå†å²ä»»åŠ¡çš„è§†é¢‘é¢„è§ˆï¼ˆå¦‚æœæœ‰ï¼‰
    if (task.video_url) {
      videoOut.src = task.video_url;
      dlVideo.href = task.video_url;
      videoSection.style.display = 'block';
      showStats(task);
      toast(`âœ… å·²åŠ è½½å†å²è§†é¢‘é¢„è§ˆ`, 'ok');
    } else {
      // å¦‚æœæ²¡æœ‰è§†é¢‘ï¼Œéšè—è§†é¢‘åŒºåŸŸ
      videoSection.style.display = 'none';
      statsSection.style.display = 'none';
    }
    
    // å¡«å……é»˜è®¤é…ç½®
    historyVideoFpsInput.value = task.config.fps || 30;
    historyPerSlideSecondsInput.value = task.config.per_slide_seconds || 3.0;
    historyTransitionSecondsInput.value = task.config.transition_seconds || 0.6;
    historyImageMultiplierInput.value = task.config.image_multiplier || 1;
    historyVideoWidthSelect.value = task.config.width || 720;
    historyVideoHeightSelect.value = task.config.height || 1280;
    
    updateButtonText();
  }

  async function handleHistoryAudioUpload() {
    const file = historyBgmFile.files?.[0];
    if (!file) {
      historyAudioId = null;
      return;
    }

    try {
      toast('ğŸ“¤ æ­£åœ¨ä¸Šä¼ éŸ³é¢‘...', 'info');
      
      const formData = new FormData();
      formData.append('file', file);
      formData.append('type', 'audio');

      const response = await fetch(`${API_BASE}/upload`, {
        method: 'POST',
        body: formData
      });

      const result = await response.json();
      
      if (result.success) {
        historyAudioId = result.file_id;
        toast('âœ… éŸ³é¢‘ä¸Šä¼ æˆåŠŸ', 'ok');
      } else {
        throw new Error(result.error || 'ä¸Šä¼ å¤±è´¥');
      }
    } catch (error) {
      toast(`âŒ éŸ³é¢‘ä¸Šä¼ å¤±è´¥: ${error.message}`, 'err');
      console.error('Upload error:', error);
    }
  }

  // ä»…ç”Ÿæˆå›¾ç‰‡æ¨¡å¼çš„æ–‡ä»¶ä¸Šä¼ å¤„ç†
  async function handleImageOnlyImageUpload() {
    const file = imageInputImage.files?.[0];
    if (!file) return;

    try {
      toast('ğŸ“¤ æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...', 'info');
      
      const formData = new FormData();
      formData.append('file', file);
      formData.append('type', 'image');

      const response = await fetch(`${API_BASE}/upload`, {
        method: 'POST',
        body: formData
      });

      const result = await response.json();
      
      if (result.success) {
        imageOnlyUploadedImageId = result.file_id;
        imageOrigPreview.src = `${API_BASE}/files/${result.file_id}`;
        imageOrigPreview.style.display = 'block';
        toast('âœ… å›¾ç‰‡ä¸Šä¼ æˆåŠŸ', 'ok');
      } else {
        throw new Error(result.error || 'ä¸Šä¼ å¤±è´¥');
      }
    } catch (error) {
      toast(`âŒ å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ${error.message}`, 'err');
      console.error('Upload error:', error);
    }
  }

  async function handleComposeAudioUpload() {
    const file = composeBgmFile.files?.[0];
    if (!file) {
      composeAudioId = null;
      return;
    }

    try {
      toast('ğŸ“¤ æ­£åœ¨ä¸Šä¼ éŸ³é¢‘...', 'info');
      
      const formData = new FormData();
      formData.append('file', file);
      formData.append('type', 'audio');

      const response = await fetch(`${API_BASE}/upload`, {
        method: 'POST',
        body: formData
      });

      const result = await response.json();
      
      if (result.success) {
        composeAudioId = result.file_id;
        toast('âœ… éŸ³é¢‘ä¸Šä¼ æˆåŠŸ', 'ok');
      } else {
        throw new Error(result.error || 'ä¸Šä¼ å¤±è´¥');
      }
    } catch (error) {
      toast(`âŒ éŸ³é¢‘ä¸Šä¼ å¤±è´¥: ${error.message}`, 'err');
      console.error('Upload error:', error);
    }
  }

  function setupEventListeners() {
    // æ–‡ä»¶ä¸Šä¼ 
    inputImage.onchange = handleImageUpload;
    bgmFile.onchange = handleAudioUpload;
    historyBgmFile.onchange = handleHistoryAudioUpload;
    
    // å›¾åº“æ–‡ä»¶ä¸Šä¼ 
    el('galleryImageUpload').onchange = handleGalleryImageUpload;
    el('galleryBgmFile').onchange = handleGalleryAudioUpload;
    
    // ä»…ç”Ÿæˆå›¾ç‰‡æ¨¡å¼çš„æ–‡ä»¶ä¸Šä¼ 
    imageInputImage.onchange = handleImageOnlyImageUpload;
    composeBgmFile.onchange = handleComposeAudioUpload;
    
    // ä»…ç”Ÿæˆå›¾ç‰‡æ¨¡å¼çš„æ–‡ä»¶ä¸Šä¼ 
    imageInputImage.onchange = handleImageOnlyImageUpload;
    composeBgmFile.onchange = handleComposeAudioUpload;
    
    // é…ç½®å˜åŒ–
    [slideCountInput, videoFpsInput, perSlideSecondsInput, transitionSecondsInput, includeOriginalCheckbox].forEach(input => {
      input.onchange = updateButtonText;
      input.oninput = updateButtonText;
    });

    // å†å²ä»»åŠ¡é…ç½®å˜åŒ–
    [historyVideoFpsInput, historyPerSlideSecondsInput, historyTransitionSecondsInput, historyImageMultiplierInput].forEach(input => {
      input.onchange = updateButtonText;
      input.oninput = updateButtonText;
    });

    // ä»…ç”Ÿæˆå›¾ç‰‡æ¨¡å¼é…ç½®å˜åŒ–
    [imageSlideCountInput, imageConcurrentLimitInput, composeVideoFpsInput, composePerSlideSecondsInput, composeTransitionSecondsInput].forEach(input => {
      input.onchange = updateButtonText;
      input.oninput = updateButtonText;
    });

    // è§†é¢‘å°ºå¯¸åŒæ­¥
    videoWidthSelect.onchange = () => {
      const width = parseInt(videoWidthSelect.value);
      if (width === 720) videoHeightSelect.value = '1280';  // æŠ–éŸ³ç«–å± 9:16
      else if (width === 1280) videoHeightSelect.value = '720';
      else if (width === 1920) videoHeightSelect.value = '1080';
      else if (width === 854) videoHeightSelect.value = '480';
      updateButtonText();
    };
    
    videoHeightSelect.onchange = () => {
      const height = parseInt(videoHeightSelect.value);
      if (height === 1280) videoWidthSelect.value = '720';  // æŠ–éŸ³ç«–å± 9:16
      else if (height === 720) videoWidthSelect.value = '1280';
      else if (height === 1080) videoWidthSelect.value = '1920';
      else if (height === 480) videoWidthSelect.value = '854';
      updateButtonText();
    };

    // ä»…ç”Ÿæˆå›¾ç‰‡æ¨¡å¼è§†é¢‘å°ºå¯¸åŒæ­¥
    composeVideoWidthSelect.onchange = () => {
      const width = parseInt(composeVideoWidthSelect.value);
      if (width === 720) composeVideoHeightSelect.value = '1280';
      else if (width === 1280) composeVideoHeightSelect.value = '720';
      else if (width === 1920) composeVideoHeightSelect.value = '1080';
      else if (width === 854) composeVideoHeightSelect.value = '480';
      updateButtonText();
    };

    composeVideoHeightSelect.onchange = updateButtonText;

    // å¯åŠ¨æŒ‰é’®äº‹ä»¶
    startBtn.onclick = handleGenerate;
  }

  async function checkConnection() {
    try {
      const response = await fetch(`${API_BASE}/health`);
      if (response.ok) {
        setConnectionStatus('connected', 'åç«¯å·²è¿æ¥');
      } else {
        setConnectionStatus('error', 'åç«¯è¿æ¥å¤±è´¥');
      }
    } catch (error) {
      setConnectionStatus('error', 'æ— æ³•è¿æ¥åç«¯');
      toast('âŒ æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡ï¼Œè¯·ç¡®ä¿åç«¯æœåŠ¡å·²å¯åŠ¨', 'err');
    }
  }

  function setConnectionStatus(status, text) {
    connectionStatus.className = `status-indicator status-${status}`;
    connectionText.textContent = text;
  }

  async function handleImageUpload() {
    const file = inputImage.files?.[0];
    if (!file) return;

    try {
      toast('ğŸ“¤ æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...', 'info');
      
      const formData = new FormData();
      formData.append('file', file);
      formData.append('type', 'image');

      const response = await fetch(`${API_BASE}/upload`, {
        method: 'POST',
        body: formData
      });

      const result = await response.json();
      
      if (result.success) {
        uploadedImageId = result.file_id;
        origPreview.src = `${API_BASE}/files/${result.file_id}`;
        origPreview.style.display = 'block';
        dlOrig.href = `${API_BASE}/files/${result.file_id}`;
        dlOrig.download = result.filename;
        toast('âœ… å›¾ç‰‡ä¸Šä¼ æˆåŠŸ', 'ok');
      } else {
        throw new Error(result.error || 'ä¸Šä¼ å¤±è´¥');
      }
    } catch (error) {
      toast(`âŒ å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ${error.message}`, 'err');
      console.error('Upload error:', error);
    }
  }

  async function handleAudioUpload() {
    const file = bgmFile.files?.[0];
    if (!file) return;

    try {
      toast('ğŸ“¤ æ­£åœ¨ä¸Šä¼ éŸ³é¢‘...', 'info');
      
      const formData = new FormData();
      formData.append('file', file);
      formData.append('type', 'audio');

      const response = await fetch(`${API_BASE}/upload`, {
        method: 'POST',
        body: formData
      });

      const result = await response.json();
      
      if (result.success) {
        uploadedAudioId = result.file_id;
        toast('âœ… éŸ³é¢‘ä¸Šä¼ æˆåŠŸ', 'ok');
      } else {
        throw new Error(result.error || 'ä¸Šä¼ å¤±è´¥');
      }
    } catch (error) {
      toast(`âŒ éŸ³é¢‘ä¸Šä¼ å¤±è´¥: ${error.message}`, 'err');
      console.error('Upload error:', error);
    }
  }

  async function handleGalleryAudioUpload() {
    const file = el('galleryBgmFile').files?.[0];
    if (!file) return;

    if (!currentGalleryGroup) {
      toast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªåˆ†ç»„', 'warn');
      return;
    }

    try {
      toast('ğŸ“¤ æ­£åœ¨ä¸Šä¼ èƒŒæ™¯éŸ³ä¹...', 'info');
      
      const formData = new FormData();
      formData.append('file', file);
      formData.append('type', 'audio');

      const response = await fetch(`${API_BASE}/upload`, {
        method: 'POST',
        body: formData
      });

      const result = await response.json();
      
      if (result.success) {
        galleryAudioId = result.file_id;
        toast('âœ… èƒŒæ™¯éŸ³ä¹ä¸Šä¼ æˆåŠŸ', 'ok');
      } else {
        throw new Error(result.error || 'ä¸Šä¼ å¤±è´¥');
      }
    } catch (error) {
      toast(`âŒ èƒŒæ™¯éŸ³ä¹ä¸Šä¼ å¤±è´¥: ${error.message}`, 'err');
      console.error('Gallery audio upload error:', error);
    }
  }

  async function handleGenerate() {
    if (startBtn.disabled) return;
    
    if (currentMode === 'new') {
      // æ–°ä»»åŠ¡æ¨¡å¼
      // éªŒè¯è¾“å…¥
      if (!apiKeyInput.value.trim()) {
        toast('âŒ è¯·å…ˆå¡«å†™ OpenRouter API Key', 'err');
        return;
      }

      if (!uploadedImageId) {
        toast('âŒ è¯·å…ˆä¸Šä¼ åŸå›¾', 'err');
        return;
      }

      try {
        startBtn.disabled = true;
        taskStatus.style.display = 'block';
        gallery.innerHTML = ''; // æ¸…ç©ºå›¾ç‰‡å»Šï¼Œä¸ºå®æ—¶æ˜¾ç¤ºåšå‡†å¤‡
        videoSection.style.display = 'none';
        statsSection.style.display = 'none';
        logBox.innerHTML = '';

        // è·å–é…ç½®
        const config = getConfig();
        
        // å‘é€ç”Ÿæˆè¯·æ±‚
        const response = await fetch(`${API_BASE}/generate`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            image_id: uploadedImageId,
            audio_id: uploadedAudioId,
            api_key: apiKeyInput.value.trim(),
            ...config
          })
        });

        const result = await response.json();
        
        if (result.success) {
          currentTaskId = result.task_id;
          toast('ğŸš€ è§†é¢‘ç”Ÿæˆä»»åŠ¡å·²å¼€å§‹', 'ok');
          startPolling();
        } else {
          throw new Error(result.error || 'ä»»åŠ¡åˆ›å»ºå¤±è´¥');
        }
      } catch (error) {
        toast(`âŒ ç”Ÿæˆå¤±è´¥: ${error.message}`, 'err');
        console.error('Generate error:', error);
        resetUI();
      }
    } else if (currentMode === 'image-only') {
      // ä»…ç”Ÿæˆå›¾ç‰‡æ¨¡å¼
      if (imageOnlyTaskId && document.querySelector('#imageSelectionArea[style*="display: block"]')) {
        // å¦‚æœå›¾ç‰‡å·²ç”Ÿæˆï¼Œåˆ™åˆæˆè§†é¢‘
        handleComposeVideo();
      } else {
        // å¼€å§‹ç”Ÿæˆå›¾ç‰‡
        handleGenerateImagesOnly();
      }
    } else if (currentMode === 'gallery') {
      // å›¾åº“æ¨¡å¼
      if (!currentGalleryGroup) {
        toast('âŒ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå›¾åº“åˆ†ç»„', 'err');
        return;
      }

      // è·å–é€‰ä¸­çš„å›¾ç‰‡
      const selectedCheckboxes = el('galleryImagesGrid').querySelectorAll('.gallery-item-checkbox:checked');
      const selectedCount = selectedCheckboxes.length;
      
      if (selectedCount === 0) {
        toast('âŒ è¯·å…ˆé€‰æ‹©è¦ä½¿ç”¨çš„å›¾ç‰‡', 'err');
        return;
      }

      try {
        startBtn.disabled = true;
        taskStatus.style.display = 'block';
        videoSection.style.display = 'none';
        statsSection.style.display = 'none';
        logBox.innerHTML = '';

        // è·å–é€‰ä¸­çš„å›¾ç‰‡ID
        const imageIds = Array.from(selectedCheckboxes).map(cb => cb.closest('.gallery-item').dataset.imageId);
        
        // è·å–å›¾åº“é…ç½®
        const config = getGalleryConfig();
        
        // å‘é€ç”Ÿæˆè¯·æ±‚
        const response = await fetch(`${API_BASE}/gallery/compose-video`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            selected_image_ids: imageIds,
            audio_id: galleryAudioId,
            ...config
          })
        });

        const result = await response.json();
        
        if (result.success) {
          currentTaskId = result.task_id;
          toast('ğŸš€ ä»å›¾åº“ç”Ÿæˆè§†é¢‘ä»»åŠ¡å·²å¼€å§‹', 'ok');
          startPolling();
        } else {
          throw new Error(result.error || 'ä»»åŠ¡åˆ›å»ºå¤±è´¥');
        }
      } catch (error) {
        toast(`âŒ ç”Ÿæˆå¤±è´¥: ${error.message}`, 'err');
        console.error('Generate from gallery error:', error);
        resetUI();
      }
    } else {
      // å†å²ä»»åŠ¡æ¨¡å¼
      if (!selectedHistoryTask) {
        toast('âŒ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå†å²ä»»åŠ¡', 'err');
        return;
      }

      try {
        startBtn.disabled = true;
        taskStatus.style.display = 'block';
        // ä¸æ¸…ç©º galleryï¼Œä¿æŒå†å²å›¾ç‰‡æ˜¾ç¤º
        // gallery.innerHTML = '';
        videoSection.style.display = 'none';
        statsSection.style.display = 'none';
        logBox.innerHTML = '';

        // å†å²å›¾ç‰‡å·²ç»åœ¨ selectHistoryTask ä¸­æ˜¾ç¤ºäº†ï¼Œä¸éœ€è¦é‡å¤æ˜¾ç¤º
        // if (selectedHistoryTask.images) {
        //   updateGallery(selectedHistoryTask.images);
        // }

        // è·å–å†å²ä»»åŠ¡é…ç½®
        const config = getHistoryConfig();
        
        // å‘é€é‡æ–°ç”Ÿæˆè¯·æ±‚
        const response = await fetch(`${API_BASE}/regenerate`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            task_id: selectedHistoryTask.task_id,
            audio_id: historyAudioId,
            ...config
          })
        });

        const result = await response.json();
        
        if (result.success) {
          currentTaskId = result.task_id;
          toast('ğŸš€ è§†é¢‘é‡æ–°ç”Ÿæˆä»»åŠ¡å·²å¼€å§‹', 'ok');
          startPolling();
        } else {
          throw new Error(result.error || 'ä»»åŠ¡åˆ›å»ºå¤±è´¥');
        }
      } catch (error) {
        toast(`âŒ é‡æ–°ç”Ÿæˆå¤±è´¥: ${error.message}`, 'err');
        console.error('Regenerate error:', error);
        resetUI();
      }
    }
  }

  function getConfig() {
    // è·å–é€‰ä¸­çš„è½¬åœºæ•ˆæœ
    const selectedTransitions = [];
    const checkboxes = transitionEffectsContainer.querySelectorAll('input[type="checkbox"]:checked');
    checkboxes.forEach(checkbox => {
      selectedTransitions.push(checkbox.value);
    });
    
    return {
      slide_count: parseInt(slideCountInput.value) || 2,
      fps: parseInt(videoFpsInput.value) || 30,
      per_slide_seconds: parseFloat(perSlideSecondsInput.value) || 1.0,
      transition_seconds: parseFloat(transitionSecondsInput.value) || 0.6,
      transition_effects: selectedTransitions,
      width: parseInt(videoWidthSelect.value) || 720,
      height: parseInt(videoHeightSelect.value) || 1280,
      include_original: includeOriginalCheckbox.checked,
      concurrent_limit: parseInt(concurrentLimitInput.value) || 1
    };
  }

  function getGalleryConfig() {
    // è·å–å›¾åº“æ¨¡å¼ä¸‹çš„é…ç½®
    const selectedTransitions = [];
    const checkboxes = el('galleryTransitionEffects').querySelectorAll('input[type="checkbox"]:checked');
    checkboxes.forEach(checkbox => {
      selectedTransitions.push(checkbox.value);
    });
    
    return {
      fps: parseInt(el('galleryVideoFps').value) || 30,
      per_slide_seconds: parseFloat(el('galleryPerSlideSeconds').value) || 3.0,
      transition_seconds: parseFloat(el('galleryTransitionSeconds').value) || 0.6,
      transition_effects: selectedTransitions,
      width: parseInt(el('galleryVideoWidth').value) || 720,
      height: parseInt(el('galleryVideoHeight').value) || 1280,
      image_multiplier: parseInt(el('galleryImageMultiplier').value) || 1,
      include_original: el('galleryIncludeOriginal').checked
    };
  }

  function getHistoryConfig() {
    // è·å–å†å²ä»»åŠ¡æ¨¡å¼ä¸‹çš„é…ç½®
    const selectedTransitions = [];
    const checkboxes = historyTransitionEffectsContainer.querySelectorAll('input[type="checkbox"]:checked');
    checkboxes.forEach(checkbox => {
      selectedTransitions.push(checkbox.value);
    });
    
    return {
      fps: parseInt(historyVideoFpsInput.value) || 30,
      per_slide_seconds: parseFloat(historyPerSlideSecondsInput.value) || 3.0,
      transition_seconds: parseFloat(historyTransitionSecondsInput.value) || 0.6,
      transition_effects: selectedTransitions,
      width: parseInt(historyVideoWidthSelect.value) || 720,
      height: parseInt(historyVideoHeightSelect.value) || 1280,
      image_multiplier: parseInt(historyImageMultiplierInput.value) || 1
    };
  }

  function updateButtonText() {
    if (currentMode === 'new') {
      const config = getConfig();
      const totalSeconds = config.include_original ? 
        (config.slide_count + 1) * config.per_slide_seconds : 
        config.slide_count * config.per_slide_seconds;
      const resolution = `${config.width}x${config.height}`;
      
      startBtn.textContent = `å¼€å§‹ç”Ÿæˆï¼ˆ${config.slide_count}å¼ ï¼‰å¹¶åˆæˆ ${totalSeconds.toFixed(1)}ç§’è§†é¢‘ (${resolution})`;
    } else if (currentMode === 'image-only') {
      if (imageSelectionArea.style.display === 'block') {
        // å›¾ç‰‡å·²ç”Ÿæˆï¼Œæ˜¾ç¤ºåˆæˆè§†é¢‘æŒ‰é’®
        const selectedCount = getSelectedImages().length;
        const config = getComposeConfig();
        const totalSeconds = config.include_original ? 
          (selectedCount + 1) * config.per_slide_seconds : 
          selectedCount * config.per_slide_seconds;
        const resolution = `${config.width}x${config.height}`;
        
        startBtn.textContent = `åˆæˆè§†é¢‘ï¼ˆ${selectedCount}å¼ ï¼‰${totalSeconds.toFixed(1)}ç§’ (${resolution})`;
      } else {
        // å°šæœªç”Ÿæˆå›¾ç‰‡
        const slideCount = parseInt(imageSlideCountInput.value) || 2;
        startBtn.textContent = `å¼€å§‹ç”Ÿæˆ ${slideCount} å¼ é£æ ¼å›¾ç‰‡`;
      }
    } else if (currentMode === 'history') {
      if (selectedHistoryTask) {
        const config = getHistoryConfig();
        const originalImageCount = selectedHistoryTask.images ? selectedHistoryTask.images.length : 0;
        const totalImages = originalImageCount * config.image_multiplier;
        const totalSeconds = totalImages * config.per_slide_seconds;
        const resolution = `${config.width}x${config.height}`;
        
        if (config.image_multiplier > 1) {
          startBtn.textContent = `é‡æ–°ç”Ÿæˆè§†é¢‘ï¼ˆ${originalImageCount}å¼ Ã—${config.image_multiplier}å€=${totalImages}å¼ ï¼‰${totalSeconds.toFixed(1)}ç§’ (${resolution})`;
        } else {
          startBtn.textContent = `ä»å†å²ä»»åŠ¡é‡æ–°ç”Ÿæˆè§†é¢‘ï¼ˆ${originalImageCount}å¼ ï¼‰${totalSeconds.toFixed(1)}ç§’ (${resolution})`;
        }
      } else {
        startBtn.textContent = 'ä»å†å²ä»»åŠ¡é‡æ–°ç”Ÿæˆè§†é¢‘';
      }
    } else if (currentMode === 'gallery') {
      if (currentGalleryGroup) {
        // è·å–é€‰ä¸­çš„å›¾ç‰‡æ•°é‡
        const selectedCheckboxes = el('galleryImagesGrid').querySelectorAll('.gallery-item-checkbox:checked');
        const selectedCount = selectedCheckboxes.length;
        
        if (selectedCount > 0) {
          const config = getGalleryConfig();
          const totalImages = selectedCount * config.image_multiplier;
          const totalSeconds = totalImages * config.per_slide_seconds;
          const resolution = `${config.width}x${config.height}`;
          
          if (config.image_multiplier > 1) {
            startBtn.textContent = `ä»å›¾åº“ç”Ÿæˆè§†é¢‘ï¼ˆ${selectedCount}å¼ Ã—${config.image_multiplier}å€=${totalImages}å¼ ï¼‰${totalSeconds.toFixed(1)}ç§’ (${resolution})`;
          } else {
            startBtn.textContent = `ä»å›¾åº“ç”Ÿæˆè§†é¢‘ï¼ˆ${selectedCount}å¼ ï¼‰${totalSeconds.toFixed(1)}ç§’ (${resolution})`;
          }
        } else {
          startBtn.textContent = 'ä»å›¾åº“ç”Ÿæˆè§†é¢‘ï¼ˆè¯·å…ˆé€‰æ‹©å›¾ç‰‡ï¼‰';
        }
      } else {
        startBtn.textContent = 'ä»å›¾åº“ç”Ÿæˆè§†é¢‘ï¼ˆè¯·å…ˆé€‰æ‹©åˆ†ç»„ï¼‰';
      }
    }
  }

  function startPolling() {
    if (pollingInterval) clearInterval(pollingInterval);
    
    pollingInterval = setInterval(async () => {
      if (!currentTaskId) return;
      
      try {
        const response = await fetch(`${API_BASE}/tasks/${currentTaskId}`);
        const task = await response.json();
        
        updateTaskStatus(task);
        
        if (task.status === 'completed' || task.status === 'images_ready') {
          stopPolling();
          handleTaskCompleted(task);
        } else if (task.status === 'error') {
          stopPolling();
          handleTaskError(task);
        }
      } catch (error) {
        console.error('Polling error:', error);
      }
    }, 1000); // æ¯1ç§’è½®è¯¢ä¸€æ¬¡ï¼Œæ›´åŠæ—¶åœ°æ˜¾ç¤ºæ–°ç”Ÿæˆçš„å›¾ç‰‡
  }

  function stopPolling() {
    if (pollingInterval) {
      clearInterval(pollingInterval);
      pollingInterval = null;
    }
  }

  function updateTaskStatus(task) {
    taskMessage.textContent = task.message || 'å¤„ç†ä¸­...';
    taskProgress.textContent = `${Math.round(task.progress || 0)}%`;
    prog.value = task.progress || 0;
    
    // æ˜¾ç¤ºç”Ÿæˆçš„å›¾ç‰‡
    if (task.images && task.images.length > 0) {
      updateGallery(task.images);
      
      // å¦‚æœæ˜¯ä»…ç”Ÿæˆå›¾ç‰‡æ¨¡å¼ä¸”çŠ¶æ€ä¸º images_readyï¼Œæ˜¾ç¤ºé€‰æ‹©ç•Œé¢
      if (currentMode === 'image-only' && task.status === 'images_ready') {
        updateImageSelectionArea(task.images);
        imageSelectionArea.style.display = 'block';
        startBtn.textContent = 'åˆæˆè§†é¢‘';
        startBtn.disabled = false;
      }
    }
  }

  function updateImageSelectionArea(images) {
    imageGallerySelection.innerHTML = '';
    
    images.forEach((img, index) => {
      if (img) {
        const wrap = document.createElement('div');
        wrap.className = 'thumb';
        wrap.style.position = 'relative';
        
        const imgEl = document.createElement('img');
        imgEl.src = `${API_BASE}/files/${img.file_id}`;
        imgEl.alt = img.style;
        imgEl.loading = 'lazy';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = img.file_id;
        checkbox.checked = img.selected !== false; // é»˜è®¤é€‰ä¸­
        checkbox.style.position = 'absolute';
        checkbox.style.top = '8px';
        checkbox.style.left = '8px';
        checkbox.style.width = 'auto';
        checkbox.style.zIndex = '10';
        
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Ã—';
        deleteBtn.style.position = 'absolute';
        deleteBtn.style.top = '8px';
        deleteBtn.style.right = '8px';
        deleteBtn.style.width = '24px';
        deleteBtn.style.height = '24px';
        deleteBtn.style.padding = '0';
        deleteBtn.style.fontSize = '16px';
        deleteBtn.style.fontWeight = 'bold';
        deleteBtn.style.color = 'white';
        deleteBtn.style.backgroundColor = 'rgba(239, 68, 68, 0.8)';
        deleteBtn.style.border = 'none';
        deleteBtn.style.borderRadius = '50%';
        deleteBtn.style.cursor = 'pointer';
        deleteBtn.style.zIndex = '10';
        deleteBtn.onclick = () => deleteSelectedImage(img.file_id);
        
        const info = document.createElement('div');
        info.className = 'info';
        // ç¡®å®šè¦æ˜¾ç¤ºçš„æ–‡æœ¬ï¼šå¦‚æœæœ‰styleå°±æ˜¾ç¤ºstyleï¼Œå¦‚æœæ²¡æœ‰å°±æ˜¾ç¤ºfilename
        const displayText = img.style ? img.style : (img.filename || 'æ— é£æ ¼');
        // å¦‚æœæ–‡æœ¬è¿‡é•¿ï¼Œæ·»åŠ titleå±æ€§ä»¥ä¾¿æ‚¬åœæ—¶æ˜¾ç¤ºå®Œæ•´æ–‡æœ¬
        const titleAttr = displayText.length > 20 ? ` title="${displayText}"` : '';
        info.innerHTML = `
          <div${titleAttr} style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${displayText}</div>
          <a href="${API_BASE}/files/${img.file_id}" download="style_${img.index}.png" style="color:var(--accent)">ä¸‹è½½</a>
        `;
        
        wrap.appendChild(imgEl);
        wrap.appendChild(checkbox);
        wrap.appendChild(deleteBtn);
        wrap.appendChild(info);
        imageGallerySelection.appendChild(wrap);
      }
    });
  }

  function updateGallery(images) {
    // è·å–å½“å‰å·²å±•ç¤ºçš„å›¾ç‰‡æ•°é‡
    const currentImageCount = gallery.children.length;
    
    // åªæ·»åŠ æ–°çš„å›¾ç‰‡ï¼Œé¿å…é‡å¤æ¸²æŸ“
    for (let i = currentImageCount; i < images.length; i++) {
      const img = images[i];
      if (img) {
        const wrap = document.createElement('div');
        wrap.className = 'thumb';
        wrap.style.position = 'relative'; // è®¾ç½®ç›¸å¯¹å®šä½ä»¥ä¾¿æ·»åŠ åˆ é™¤æŒ‰é’®
        
        const imgEl = document.createElement('img');
        imgEl.src = `${API_BASE}/files/${img.file_id}`;
        imgEl.alt = img.style;
        imgEl.loading = 'lazy';
        
        // æ·»åŠ åŠ è½½åŠ¨ç”»æ•ˆæœ
        imgEl.style.opacity = '0';
        imgEl.style.transition = 'opacity 0.3s ease-in-out';
        imgEl.onload = () => {
          imgEl.style.opacity = '1';
        };
        
        // æ·»åŠ åˆ é™¤æŒ‰é’®
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Ã—';
        deleteBtn.style.position = 'absolute';
        deleteBtn.style.top = '8px';
        deleteBtn.style.right = '8px';
        deleteBtn.style.width = '24px';
        deleteBtn.style.height = '24px';
        deleteBtn.style.padding = '0';
        deleteBtn.style.fontSize = '16px';
        deleteBtn.style.fontWeight = 'bold';
        deleteBtn.style.color = 'white';
        deleteBtn.style.backgroundColor = 'rgba(239, 68, 68, 0.8)';
        deleteBtn.style.border = 'none';
        deleteBtn.style.borderRadius = '50%';
        deleteBtn.style.cursor = 'pointer';
        deleteBtn.style.zIndex = '10';
        deleteBtn.style.opacity = '0.8';
        deleteBtn.style.transition = 'opacity 0.2s';
        deleteBtn.title = 'åˆ é™¤è¿™å¼ å›¾ç‰‡';
        
        // é¼ æ ‡æ‚¬åœæ•ˆæœ
        deleteBtn.onmouseover = () => deleteBtn.style.opacity = '1';
        deleteBtn.onmouseout = () => deleteBtn.style.opacity = '0.8';
        
        // åˆ é™¤äº‹ä»¶
        deleteBtn.onclick = (e) => {
          e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
          deleteGalleryImage(img.file_id, wrap);
        };
        
        const info = document.createElement('div');
        info.className = 'info';
        // ç¡®å®šè¦æ˜¾ç¤ºçš„æ–‡æœ¬ï¼šå¦‚æœæœ‰styleå°±æ˜¾ç¤ºstyleï¼Œå¦‚æœæ²¡æœ‰å°±æ˜¾ç¤ºfilename
        const displayText = img.style ? img.style : (img.filename || 'æ— é£æ ¼');
        // å¦‚æœæ–‡æœ¬è¿‡é•¿ï¼Œæ·»åŠ titleå±æ€§ä»¥ä¾¿æ‚¬åœæ—¶æ˜¾ç¤ºå®Œæ•´æ–‡æœ¬
        const titleAttr = displayText.length > 20 ? ` title="${displayText}"` : '';
        info.innerHTML = `
          <div${titleAttr} style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${displayText}</div>
          <a href="${API_BASE}/files/${img.file_id}" download="style_${img.index}.png" style="color:var(--accent)">ä¸‹è½½</a>
        `;
        
        wrap.appendChild(imgEl);
        wrap.appendChild(deleteBtn);
        wrap.appendChild(info);
        gallery.appendChild(wrap);
        
        // æ·»åŠ å…¥åœºåŠ¨ç”»
        wrap.style.opacity = '0';
        wrap.style.transform = 'scale(0.9)';
        wrap.style.transition = 'all 0.3s ease-in-out';
        
        // å»¶è¿Ÿæ‰§è¡ŒåŠ¨ç”»
        setTimeout(() => {
          wrap.style.opacity = '1';
          wrap.style.transform = 'scale(1)';
        }, 50);
        
        // æ˜¾ç¤ºæ–°å›¾ç‰‡ç”Ÿæˆçš„æç¤º
        toast(`âœ¨ æ–°é£æ ¼å›¾ç‰‡ç”Ÿæˆ: ${img.style}`, 'ok');
      }
    }
  }

  function handleTaskCompleted(task) {
    if (task.status === 'images_ready') {
      // å›¾ç‰‡ç”Ÿæˆå®Œæˆï¼Œç­‰å¾…ç”¨æˆ·é€‰æ‹©
      toast('âœ… å›¾ç‰‡ç”Ÿæˆå®Œæˆï¼è¯·é€‰æ‹©è¦åŒ…å«çš„å›¾ç‰‡åç‚¹å‡»â€œåˆæˆè§†é¢‘â€', 'ok');
      return; // ä¸é‡ç½®UIï¼Œç­‰å¾…ç”¨æˆ·æ“ä½œ
    }
    
    toast('âœ… è§†é¢‘ç”Ÿæˆå®Œæˆï¼', 'ok');
    
    // æ˜¾ç¤ºè§†é¢‘
    if (task.video_url) {
      videoOut.src = task.video_url;
      dlVideo.href = task.video_url;
      videoSection.style.display = 'block';
    }
    
    // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
    showStats(task);
    
    resetUI();
  }

  function handleTaskError(task) {
    let errorMessage = task.error || 'æœªçŸ¥é”™è¯¯';
    
    // å¯¹ä¸åŒç±»å‹çš„é”™è¯¯æä¾›æ›´å¥½çš„æç¤º
    if (errorMessage.includes('é€Ÿç‡é™åˆ¶')) {
      toast(`âš ï¸ APIè°ƒç”¨è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•æˆ–å‡å°‘å¹¶å‘æ•°é‡`, 'warn');
      errorMessage = 'APIé€Ÿç‡é™åˆ¶ï¼Œè¯·ç¨åå†è¯•æˆ–åœ¨é«˜çº§é…ç½®ä¸­å‡å°‘â€œå¹¶å‘è¯·æ±‚æ•°â€';
    } else if (errorMessage.includes('å›¾ç‰‡ç”Ÿæˆå®Œæˆï¼ŒæˆåŠŸ: 0')) {
      toast(`âš ï¸ æ‰€æœ‰å›¾ç‰‡ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥API Keyæˆ–ç¨åå†è¯•`, 'warn');
      errorMessage = 'æ‰€æœ‰å›¾ç‰‡ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥OpenRouter API Keyæ˜¯å¦æœ‰æ•ˆ';
    }
    
    toast(`âŒ ç”Ÿæˆå¤±è´¥: ${errorMessage}`, 'err');
    resetUI();
  }

  function showStats(task) {
    const stats = el('stats');
    const config = task.config || {};
    const imageCount = task.images ? task.images.length : 0;
    
    stats.innerHTML = `
      æˆåŠŸç”Ÿæˆ: ${imageCount}/${config.slide_count || 0} å¼ å›¾ç‰‡<br>
      è§†é¢‘åˆ†è¾¨ç‡: ${config.width || 0}Ã—${config.height || 0}<br>
      è§†é¢‘å¸§ç‡: ${config.fps || 0} FPS<br>
      å®Œæˆæ—¶é—´: ${new Date(task.completed_at).toLocaleString()}
    `;
    
    statsSection.style.display = 'block';
  }

  function resetUI() {
    startBtn.disabled = false;
    currentTaskId = null;
  }

  function toast(msg, type) {
    const line = document.createElement('div');
    line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
    if (type === 'ok') line.classList.add('ok');
    else if (type === 'warn') line.classList.add('warn');
    else if (type === 'err') line.classList.add('err');
    
    logBox.appendChild(line);
    logBox.scrollTop = logBox.scrollHeight;
  }

  // é¡µé¢å¸è½½æ—¶æ¸…ç†
  window.addEventListener('beforeunload', () => {
    stopPolling();
  });

  // è½¬åœºæ•ˆæœé€‰æ‹©å¿«æ·å‡½æ•°
  function selectAllTransitions() {
    const checkboxes = transitionEffectsContainer.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      checkbox.checked = true;
    });
    updateButtonText();
  }

  function selectNoneTransitions() {
    const checkboxes = transitionEffectsContainer.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      checkbox.checked = false;
    });
    updateButtonText();
  }

  function selectSlideTransitions() {
    const checkboxes = transitionEffectsContainer.querySelectorAll('input[type="checkbox"]');
    const slideEffects = ['slideleft', 'slideright', 'slideup', 'slidedown'];
    checkboxes.forEach(checkbox => {
      checkbox.checked = slideEffects.includes(checkbox.value);
    });
    updateButtonText();
  }

  function selectFadeTransitions() {
    const checkboxes = transitionEffectsContainer.querySelectorAll('input[type="checkbox"]');
    const fadeEffects = ['fadeblack', 'fadewhite', 'dissolve', 'fadefast', 'fadeslow', 'fadegrays'];
    checkboxes.forEach(checkbox => {
      checkbox.checked = fadeEffects.includes(checkbox.value);
    });
    updateButtonText();
  }

  // å°†å‡½æ•°æ·»åŠ åˆ°å…¨å±€ä½œç”¨åŸŸï¼Œä»¥ä¾¿ onclick å¯ä»¥è®¿é—®
  window.selectAllTransitions = selectAllTransitions;
  window.selectNoneTransitions = selectNoneTransitions;
  window.selectSlideTransitions = selectSlideTransitions;
  window.selectFadeTransitions = selectFadeTransitions;
  window.switchMode = switchMode;
  window.loadHistoryTasks = loadHistoryTasks;

  // ä»…ç”Ÿæˆå›¾ç‰‡æ¨¡å¼çš„ç›¸å…³å‡½æ•°
  async function handleGenerateImagesOnly() {
    // éªŒè¯è¾“å…¥
    if (!imageApiKeyInput.value.trim()) {
      toast('âŒ è¯·å…ˆå¡«å†™ OpenRouter API Key', 'err');
      return;
    }

    if (!imageOnlyUploadedImageId) {
      toast('âŒ è¯·å…ˆä¸Šä¼ åŸå›¾', 'err');
      return;
    }

    try {
      startBtn.disabled = true;
      taskStatus.style.display = 'block';
      gallery.innerHTML = '';
      imageGallerySelection.innerHTML = '';
      imageSelectionArea.style.display = 'none';
      videoSection.style.display = 'none';
      statsSection.style.display = 'none';
      logBox.innerHTML = '';

      // è·å–é…ç½®
      const config = {
        slide_count: parseInt(imageSlideCountInput.value) || 2,
        concurrent_limit: parseInt(imageConcurrentLimitInput.value) || 1
      };
      
      // å‘é€ç”Ÿæˆå›¾ç‰‡è¯·æ±‚
      const response = await fetch(`${API_BASE}/generate-images`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          image_id: imageOnlyUploadedImageId,
          api_key: imageApiKeyInput.value.trim(),
          ...config
        })
      });

      const result = await response.json();
      
      if (result.success) {
        imageOnlyTaskId = result.task_id;
        currentTaskId = result.task_id;
        toast('ğŸš€ å›¾ç‰‡ç”Ÿæˆä»»åŠ¡å·²å¼€å§‹', 'ok');
        startPolling();
      } else {
        throw new Error(result.error || 'ä»»åŠ¡åˆ›å»ºå¤±è´¥');
      }
    } catch (error) {
      toast(`âŒ ç”Ÿæˆå¤±è´¥: ${error.message}`, 'err');
      console.error('Generate error:', error);
      resetUI();
    }
  }

  async function handleComposeVideo() {
    // è·å–é€‰ä¸­çš„å›¾ç‰‡
    const selectedImages = getSelectedImages();
    
    if (selectedImages.length === 0) {
      toast('âŒ è¯·è‡³å°‘é€‰æ‹©ä¸€å¼ å›¾ç‰‡', 'err');
      return;
    }

    try {
      startBtn.disabled = true;
      taskStatus.style.display = 'block';
      videoSection.style.display = 'none';
      statsSection.style.display = 'none';
      logBox.innerHTML = '';

      // è·å–é…ç½®
      const config = getComposeConfig();
      
      // å‘é€åˆæˆè§†é¢‘è¯·æ±‚
      const response = await fetch(`${API_BASE}/compose-video`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          task_id: imageOnlyTaskId,
          selected_image_ids: selectedImages,
          audio_id: composeAudioId,
          ...config
        })
      });

      const result = await response.json();
      
      if (result.success) {
        currentTaskId = result.task_id;
        toast('ğŸš€ è§†é¢‘åˆæˆä»»åŠ¡å·²å¼€å§‹', 'ok');
        startPolling();
      } else {
        throw new Error(result.error || 'ä»»åŠ¡åˆ›å»ºå¤±è´¥');
      }
    } catch (error) {
      toast(`âŒ åˆæˆå¤±è´¥: ${error.message}`, 'err');
      console.error('Compose error:', error);
      resetUI();
    }
  }

  function getSelectedImages() {
    const selectedImages = [];
    const checkboxes = imageGallerySelection.querySelectorAll('input[type="checkbox"]:checked');
    checkboxes.forEach(checkbox => {
      selectedImages.push(checkbox.value);
    });
    return selectedImages;
  }

  function getComposeConfig() {
    // è·å–é€‰ä¸­çš„è½¬åœºæ•ˆæœ
    const selectedTransitions = [];
    const checkboxes = composeTransitionEffectsContainer.querySelectorAll('input[type="checkbox"]:checked');
    checkboxes.forEach(checkbox => {
      selectedTransitions.push(checkbox.value);
    });
    
    return {
      fps: parseInt(composeVideoFpsInput.value) || 30,
      per_slide_seconds: parseFloat(composePerSlideSecondsInput.value) || 3.0,
      transition_seconds: parseFloat(composeTransitionSecondsInput.value) || 0.6,
      transition_effects: selectedTransitions,
      width: parseInt(composeVideoWidthSelect.value) || 720,
      height: parseInt(composeVideoHeightSelect.value) || 1280,
      include_original: composeIncludeOriginalCheckbox.checked
    };
  }

  function selectAllImages() {
    const checkboxes = imageGallerySelection.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      checkbox.checked = true;
    });
  }

  function selectNoneImages() {
    const checkboxes = imageGallerySelection.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      checkbox.checked = false;
    });
  }

  async function deleteSelectedImage(imageId) {
    showCustomModal('ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿ', async (confirmed) => {
      if (!confirmed) {
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/images/${imageId}`, {
          method: 'DELETE'
        });

        const result = await response.json();
        
        if (result.success) {
          // ä»ç•Œé¢ä¸­ç§»é™¤å›¾ç‰‡
          const imageElement = document.querySelector(`input[value="${imageId}"]`).closest('.thumb');
          if (imageElement) {
            imageElement.remove();
          }
          toast('âœ… å›¾ç‰‡åˆ é™¤æˆåŠŸ', 'ok');
        } else {
          throw new Error(result.error || 'åˆ é™¤å¤±è´¥');
        }
      } catch (error) {
        toast(`âŒ åˆ é™¤å›¾ç‰‡å¤±è´¥: ${error.message}`, 'err');
        console.error('Delete error:', error);
      }
    });
  }

  async function deleteGalleryImage(imageId, imageElement) {
    showCustomModal('ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿåˆ é™¤åå°†æ— æ³•æ¢å¤ã€‚', async (confirmed) => {
      if (!confirmed) {
        return;
      }

      try {
        // æ·»åŠ åˆ é™¤åŠ¨ç”»
        imageElement.style.transition = 'all 0.3s ease-in-out';
        imageElement.style.opacity = '0.5';
        imageElement.style.transform = 'scale(0.9)';
        
        const response = await fetch(`${API_BASE}/images/${imageId}`, {
          method: 'DELETE'
        });

        const result = await response.json();
        
        if (result.success) {
          // æ·»åŠ é€€åœºåŠ¨ç”»åç§»é™¤å…ƒç´ 
          imageElement.style.opacity = '0';
          imageElement.style.transform = 'scale(0.8)';
          
          setTimeout(() => {
            if (imageElement.parentNode) {
              imageElement.remove();
            }
          }, 300);
          
          toast('âœ… å›¾ç‰‡åˆ é™¤æˆåŠŸ', 'ok');
        } else {
          // æ¢å¤åŸçŠ¶
          imageElement.style.opacity = '1';
          imageElement.style.transform = 'scale(1)';
          throw new Error(result.error || 'åˆ é™¤å¤±è´¥');
        }
      } catch (error) {
        // æ¢å¤åŸçŠ¶
        imageElement.style.opacity = '1';
        imageElement.style.transform = 'scale(1)';
        toast(`âŒ åˆ é™¤å›¾ç‰‡å¤±è´¥: ${error.message}`, 'err');
        console.error('Delete error:', error);
      }
    });
  }

  // ä»…ç”Ÿæˆå›¾ç‰‡æ¨¡å¼è½¬åœºæ•ˆæœé€‰æ‹©å‡½æ•°
  function selectAllComposeTransitions() {
    const checkboxes = composeTransitionEffectsContainer.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      checkbox.checked = true;
    });
  }

  function selectNoneComposeTransitions() {
    const checkboxes = composeTransitionEffectsContainer.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      checkbox.checked = false;
    });
  }

  function selectSlideComposeTransitions() {
    const checkboxes = composeTransitionEffectsContainer.querySelectorAll('input[type="checkbox"]');
    const slideEffects = ['slideleft', 'slideright', 'slideup', 'slidedown'];
    checkboxes.forEach(checkbox => {
      checkbox.checked = slideEffects.includes(checkbox.value);
    });
  }

  function selectFadeComposeTransitions() {
    const checkboxes = composeTransitionEffectsContainer.querySelectorAll('input[type="checkbox"]');
    const fadeEffects = ['fadeblack', 'fadewhite', 'dissolve', 'fadefast', 'fadeslow', 'fadegrays'];
    checkboxes.forEach(checkbox => {
      checkbox.checked = fadeEffects.includes(checkbox.value);
    });
  }

  // åˆ é™¤å†å²ä»»åŠ¡åŠŸèƒ½
  async function deleteHistoryTask(taskId, event) {
    event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
    
    // æ˜¾ç¤ºè‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†
    const confirmed = await showCustomConfirm(
      'åˆ é™¤å†å²ä»»åŠ¡',
      `ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå†å²ä»»åŠ¡å—ï¼Ÿ\n\nè¿™å°†åˆ é™¤ï¼š\nâ€¢ ä»»åŠ¡è®°å½•\nâ€¢ ç›¸å…³çš„æ‰€æœ‰å›¾ç‰‡æ–‡ä»¶\nâ€¢ ç›¸å…³çš„è§†é¢‘æ–‡ä»¶\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`,
      'åˆ é™¤',
      'å–æ¶ˆ'
    );
    
    if (!confirmed) {
      return;
    }
    
    try {
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      toast('ğŸ—‘ï¸ æ­£åœ¨åˆ é™¤å†å²ä»»åŠ¡...', 'info');
      
      const response = await fetch(`${API_BASE}/history/${taskId}`, {
        method: 'DELETE'
      });
      
      const result = await response.json();
      
      if (result.success) {
        toast(`âœ… å†å²ä»»åŠ¡åˆ é™¤æˆåŠŸï¼Œå…±åˆ é™¤ ${result.deleted_files.length} ä¸ªæ–‡ä»¶`, 'ok');
        
        // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é€‰ä¸­çš„ä»»åŠ¡ï¼Œæ¸…ç©ºé€‰ä¸­çŠ¶æ€
        if (selectedHistoryTask && selectedHistoryTask.task_id === taskId) {
          selectedHistoryTask = null;
          gallery.innerHTML = '';
          videoSection.style.display = 'none';
          statsSection.style.display = 'none';
          historyTaskConfig.style.display = 'none';
        }
        
        // é‡æ–°åŠ è½½å†å²ä»»åŠ¡åˆ—è¡¨
        await loadHistoryTasks();
        
      } else {
        throw new Error(result.error || 'åˆ é™¤å¤±è´¥');
      }
      
    } catch (error) {
      console.error('Delete history task error:', error);
      toast(`âŒ åˆ é™¤å¤±è´¥: ${error.message}`, 'err');
    }
  }

  // å°†åˆ é™¤å‡½æ•°æ·»åŠ åˆ°å…¨å±€ä½œç”¨åŸŸ
  window.deleteHistoryTask = deleteHistoryTask;

  // å°†æ–°å‡½æ•°æ·»åŠ åˆ°å…¨å±€ä½œç”¨åŸŸ
  window.selectAllImages = selectAllImages;
  window.selectNoneImages = selectNoneImages;
  window.deleteSelectedImage = deleteSelectedImage;
  window.deleteGalleryImage = deleteGalleryImage;
  window.selectAllComposeTransitions = selectAllComposeTransitions;
  window.selectNoneComposeTransitions = selectNoneComposeTransitions;
  window.selectSlideComposeTransitions = selectSlideComposeTransitions;
  window.selectFadeComposeTransitions = selectFadeComposeTransitions;



  // æ˜¾ç¤ºè‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†ï¼ˆè¿”å›Promiseï¼‰
  function showCustomConfirm(title, message, confirmText = 'ç¡®è®¤', cancelText = 'å–æ¶ˆ') {
    return new Promise((resolve) => {
      const modal = document.getElementById('customModal');
      const titleEl = modal.querySelector('.modal-title');
      const messageEl = modal.querySelector('.modal-message');
      const confirmBtn = modal.querySelector('.modal-btn-confirm');
      const cancelBtn = modal.querySelector('.modal-btn-cancel');
      
      // è®¾ç½®å†…å®¹
      titleEl.textContent = title;
      messageEl.textContent = message;
      confirmBtn.textContent = confirmText;
      cancelBtn.textContent = cancelText;
      
      // é‡ç½®ç‚¹å‡»äº‹ä»¶ï¼ˆé¿å…ä¹‹å‰çš„äº‹ä»¶å¹²æ‰°ï¼‰
      confirmBtn.onclick = () => {
        hideCustomModal();
        resolve(true);
      };
      
      cancelBtn.onclick = () => {
        hideCustomModal();
        resolve(false);
      };
      
      // æ˜¾ç¤ºæ¨¡æ€æ¡†
      modal.classList.add('show');
      
      // ESCé”®æ”¯æŒ
      const handleEscape = (event) => {
        if (event.key === 'Escape') {
          document.removeEventListener('keydown', handleEscape);
          hideCustomModal();
          resolve(false);
        }
      };
      
      document.addEventListener('keydown', handleEscape);
      
      // ç‚¹å‡»å¤–éƒ¨åŒºåŸŸå…³é—­
      const handleOutsideClick = (event) => {
        if (event.target === modal) {
          document.removeEventListener('click', handleOutsideClick);
          hideCustomModal();
          resolve(false);
        }
      };
      
      setTimeout(() => {
        document.addEventListener('click', handleOutsideClick);
      }, 100); // å»¶è¿Ÿæ·»åŠ ï¼Œé¿å…ç«‹å³è§¦å‘
    });
  }

  // æ˜¾ç¤ºè‡ªå®šä¹‰æ¨¡æ€å¯¹è¯æ¡†
  function showCustomModal(message, callback) {
    const modal = document.getElementById('customModal');
    const messageEl = modal.querySelector('.modal-message');
    
    messageEl.textContent = message;
    modalCallback = callback;
    
    modal.classList.add('show');
    
    // ç›‘å¬ ESC é”®å…³é—­å¯¹è¯æ¡†
    document.addEventListener('keydown', handleModalEscape);
  }

  // éšè—è‡ªå®šä¹‰æ¨¡æ€å¯¹è¯æ¡†
  function hideCustomModal(confirmed) {
    const modal = document.getElementById('customModal');
    modal.classList.remove('show');
    
    // ç§»é™¤ ESC é”®ç›‘å¬
    document.removeEventListener('keydown', handleModalEscape);
    
    // æ‰§è¡Œå›è°ƒ
    if (modalCallback) {
      modalCallback(confirmed);
      modalCallback = null;
    }
  }

  // å¤„ç† ESC é”®æŒ‰ä¸‹
  function handleModalEscape(event) {
    if (event.key === 'Escape') {
      hideCustomModal(false);
    }
  }

  // æ˜¾ç¤ºå¸¦è¾“å…¥æ¡†çš„è‡ªå®šä¹‰æ¨¡æ€å¯¹è¯æ¡†
  function showCustomModalWithInput(title, message, defaultValue, callback) {
    // åˆ›å»ºæ¨¡æ€å¯¹è¯æ¡†å…ƒç´ 
    const modal = document.createElement('div');
    modal.className = 'custom-modal';
    modal.innerHTML = `
      <div class="modal-content">
        <div class="modal-icon">ğŸ“</div>
        <div class="modal-title">${title}</div>
        <div class="modal-message">${message}</div>
        <input type="text" id="customModalInput" class="modal-input" value="${defaultValue}" />
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-cancel" id="modalCancelBtn">å–æ¶ˆ</button>
          <button class="modal-btn modal-btn-confirm" id="modalConfirmBtn">ç¡®è®¤</button>
        </div>
      </div>
    `;
    
    // æ·»åŠ åˆ°é¡µé¢
    document.body.appendChild(modal);
    
    // è·å–å…ƒç´ 
    const input = modal.querySelector('#customModalInput');
    const cancelBtn = modal.querySelector('#modalCancelBtn');
    const confirmBtn = modal.querySelector('#modalConfirmBtn');
    
    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    modal.classList.add('show');
    
    // èšç„¦åˆ°è¾“å…¥æ¡†
    setTimeout(() => {
      input.focus();
      input.select();
    }, 100);
    
    // ç¡®è®¤æŒ‰é’®äº‹ä»¶
    confirmBtn.onclick = () => {
      const value = input.value.trim();
      hideCustomModalWithInput(modal);
      if (callback) callback(value);
    };
    
    // å–æ¶ˆæŒ‰é’®äº‹ä»¶
    cancelBtn.onclick = () => {
      hideCustomModalWithInput(modal);
    };
    
    // å›è½¦é”®ç¡®è®¤
    input.onkeypress = (e) => {
      if (e.key === 'Enter') {
        confirmBtn.click();
      }
    };
    
    // ESCé”®å…³é—­
    const handleEscape = (event) => {
      if (event.key === 'Escape') {
        document.removeEventListener('keydown', handleEscape);
        hideCustomModalWithInput(modal);
      }
    };
    
    document.addEventListener('keydown', handleEscape);
    
    // ç‚¹å‡»å¤–éƒ¨åŒºåŸŸå…³é—­
    const handleOutsideClick = (event) => {
      if (event.target === modal) {
        document.removeEventListener('click', handleOutsideClick);
        hideCustomModalWithInput(modal);
      }
    };
    
    setTimeout(() => {
      document.addEventListener('click', handleOutsideClick);
    }, 100);
  }

  // éšè—å¸¦è¾“å…¥æ¡†çš„è‡ªå®šä¹‰æ¨¡æ€å¯¹è¯æ¡†
  function hideCustomModalWithInput(modal) {
    modal.classList.remove('show');
    setTimeout(() => {
      if (modal.parentNode) {
        modal.parentNode.removeChild(modal);
      }
    }, 300);
  }

  // å°†å‡½æ•°æ·»åŠ åˆ°å…¨å±€ä½œç”¨åŸŸ
  window.showCustomModal = showCustomModal;
  window.showCustomConfirm = showCustomConfirm;
  window.hideCustomModal = hideCustomModal;
  window.showCustomModalWithInput = showCustomModalWithInput;

  // å†å²ä»»åŠ¡è½¬åœºæ•ˆæœé€‰æ‹©å‡½æ•°
  function selectAllHistoryTransitions() {
    const checkboxes = historyTransitionEffectsContainer.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      checkbox.checked = true;
    });
  }

  function selectNoneHistoryTransitions() {
    const checkboxes = historyTransitionEffectsContainer.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      checkbox.checked = false;
    });
  }

  function selectSlideHistoryTransitions() {
    const checkboxes = historyTransitionEffectsContainer.querySelectorAll('input[type="checkbox"]');
    const slideEffects = ['slideleft', 'slideright', 'slideup', 'slidedown'];
    checkboxes.forEach(checkbox => {
      checkbox.checked = slideEffects.includes(checkbox.value);
    });
  }

  function selectFadeHistoryTransitions() {
    const checkboxes = historyTransitionEffectsContainer.querySelectorAll('input[type="checkbox"]');
    const fadeEffects = ['fadeblack', 'fadewhite', 'dissolve', 'fadefast', 'fadeslow', 'fadegrays'];
    checkboxes.forEach(checkbox => {
      checkbox.checked = fadeEffects.includes(checkbox.value);
    });
  }

  // ==================== å›¾åº“åŠŸèƒ½å‡½æ•° ====================

  // åˆ›å»ºæ–°å›¾åº“åˆ†ç»„
  async function createNewGalleryGroup() {
    // ä½¿ç”¨è‡ªå®šä¹‰æ¨¡æ€å¯¹è¯æ¡†æ›¿ä»£prompt
    showCustomModalWithInput('åˆ›å»ºæ–°åˆ†ç»„', 'è¯·è¾“å…¥æ–°åˆ†ç»„çš„åç§°:', '', (groupName) => {
      if (!groupName) {
        toast('âŒ åˆ†ç»„åç§°ä¸èƒ½ä¸ºç©º', 'err');
        return;
      }
      
      if (groupName.length > 50) {
        toast('âŒ åˆ†ç»„åç§°ä¸èƒ½è¶…è¿‡50ä¸ªå­—ç¬¦', 'err');
        return;
      }
      
      createGalleryGroup(groupName);
    });
  }

  // åˆ›å»ºå›¾åº“åˆ†ç»„çš„å®é™…å‡½æ•°
  async function createGalleryGroup(groupName) {
    try {
      const response = await fetch(`${API_BASE}/gallery/groups`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: groupName })
      });
      
      const result = await response.json();
      
      if (result.success) {
        toast('âœ… åˆ†ç»„åˆ›å»ºæˆåŠŸ', 'ok');
        // é‡æ–°åŠ è½½åˆ†ç»„åˆ—è¡¨
        await loadGalleryGroups();
      } else {
        throw new Error(result.error || 'åˆ›å»ºå¤±è´¥');
      }
    } catch (error) {
      toast(`âŒ åˆ›å»ºåˆ†ç»„å¤±è´¥: ${error.message}`, 'err');
    }
  }

  // é‡å‘½åå›¾åº“åˆ†ç»„
  async function renameGalleryGroup() {
    if (!currentGalleryGroup) {
      toast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªåˆ†ç»„', 'warn');
      return;
    }
    
    // ä½¿ç”¨è‡ªå®šä¹‰æ¨¡æ€å¯¹è¯æ¡†æ›¿ä»£prompt
    showCustomModalWithInput('é‡å‘½ååˆ†ç»„', 'è¯·è¾“å…¥æ–°çš„åˆ†ç»„åç§°:', currentGalleryGroup.name, (newName) => {
      if (!newName) {
        toast('âŒ åˆ†ç»„åç§°ä¸èƒ½ä¸ºç©º', 'err');
        return;
      }
      
      if (newName === currentGalleryGroup.name) {
        toast('âŒ æ–°åç§°ä¸èƒ½ä¸åŸåç§°ç›¸åŒ', 'warn');
        return;
      }
      
      if (newName.length > 50) {
        toast('âŒ åˆ†ç»„åç§°ä¸èƒ½è¶…è¿‡50ä¸ªå­—ç¬¦', 'err');
        return;
      }
      
      renameGalleryGroupWithName(newName);
    });
  }

  // é‡å‘½åå›¾åº“åˆ†ç»„çš„å®é™…å‡½æ•°
  async function renameGalleryGroupWithName(newName) {
    try {
      const response = await fetch(`${API_BASE}/gallery/groups/${currentGalleryGroup.id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: newName })
      });
      
      const result = await response.json();
      
      if (result.success) {
        toast('âœ… åˆ†ç»„é‡å‘½åæˆåŠŸ', 'ok');
        currentGalleryGroup.name = newName;
        // é‡æ–°åŠ è½½åˆ†ç»„åˆ—è¡¨
        await loadGalleryGroups();
        // é‡æ–°é€‰æ‹©å½“å‰åˆ†ç»„
        el('galleryGroupSelect').value = currentGalleryGroup.id;
        // é‡æ–°åŠ è½½å½“å‰åˆ†ç»„çš„å›¾ç‰‡
        await selectGalleryGroup();
      } else {
        throw new Error(result.error || 'é‡å‘½åå¤±è´¥');
      }
    } catch (error) {
      toast(`âŒ é‡å‘½ååˆ†ç»„å¤±è´¥: ${error.message}`, 'err');
    }
  }

  // åŠ è½½å›¾åº“åˆ†ç»„
  async function loadGalleryGroups() {
    try {
      const response = await fetch(`${API_BASE}/gallery/groups`);
      const data = await response.json();
      
      const groupSelect = el('galleryGroupSelect');
      groupSelect.innerHTML = '<option value="">é€‰æ‹©æˆ–åˆ›å»ºåˆ†ç»„...</option>';
      
      data.groups.forEach(group => {
        const option = document.createElement('option');
        option.value = group.id;
        option.textContent = `${group.name} (${group.image_count}å¼ å›¾ç‰‡)`;
        groupSelect.appendChild(option);
      });
      
      // å¦‚æœä¹‹å‰æœ‰é€‰ä¸­çš„åˆ†ç»„ï¼Œé‡æ–°é€‰ä¸­å®ƒ
      if (currentGalleryGroup) {
        groupSelect.value = currentGalleryGroup.id;
      }
    } catch (error) {
      toast(`åŠ è½½å›¾åº“åˆ†ç»„å¤±è´¥: ${error.message}`, 'err');
    }
  }

  // é€‰æ‹©å›¾åº“åˆ†ç»„
  async function selectGalleryGroup() {
    const groupId = el('galleryGroupSelect').value;
    
    if (!groupId) {
      // éšè—ç›¸å…³åŒºåŸŸ
      el('galleryUploadArea').style.display = 'none';
      el('galleryImagesArea').style.display = 'none';
      el('galleryVideoConfig').style.display = 'none';
      el('galleryGroupActions').style.display = 'none';
      return;
    }
    
    try {
      // è·å–åˆ†ç»„ä¿¡æ¯
      const response = await fetch(`${API_BASE}/gallery/groups/${groupId}`);
      const data = await response.json();
      
      currentGalleryGroup = data.group;
      
      // æ˜¾ç¤ºç›¸å…³åŒºåŸŸ
      el('galleryUploadArea').style.display = 'block';
      el('galleryImagesArea').style.display = 'block';
      el('galleryVideoConfig').style.display = 'block';
      el('galleryGroupActions').style.display = 'flex';
      
      // æ›´æ–°åˆ†ç»„æ ‡é¢˜
      el('galleryGroupTitle').textContent = `åˆ†ç»„: ${currentGalleryGroup.name}`;
      
      // åŠ è½½åˆ†ç»„ä¸­çš„å›¾ç‰‡
      await loadGalleryImages(groupId);
      
    } catch (error) {
      toast(`åŠ è½½å›¾åº“åˆ†ç»„å¤±è´¥: ${error.message}`, 'err');
    }
  }

  // éšè—å¸¦è¾“å…¥æ¡†çš„è‡ªå®šä¹‰æ¨¡æ€å¯¹è¯æ¡†
  function hideCustomModalWithInput(modal) {
    modal.classList.remove('show');
    setTimeout(() => {
      if (modal.parentNode) {
        modal.parentNode.removeChild(modal);
      }
    }, 300);
  }

  // å°†å‡½æ•°æ·»åŠ åˆ°å…¨å±€ä½œç”¨åŸŸ
  window.showCustomModal = showCustomModal;
  window.showCustomConfirm = showCustomConfirm;
  window.hideCustomModal = hideCustomModal;
  window.showCustomModalWithInput = showCustomModalWithInput;

  // å†å²ä»»åŠ¡è½¬åœºæ•ˆæœé€‰æ‹©å‡½æ•°
  function selectAllHistoryTransitions() {
    const checkboxes = historyTransitionEffectsContainer.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      checkbox.checked = true;
    });
  }

  function selectNoneHistoryTransitions() {
    const checkboxes = historyTransitionEffectsContainer.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      checkbox.checked = false;
    });
  }

  function selectSlideHistoryTransitions() {
    const checkboxes = historyTransitionEffectsContainer.querySelectorAll('input[type="checkbox"]');
    const slideEffects = ['slideleft', 'slideright', 'slideup', 'slidedown'];
    checkboxes.forEach(checkbox => {
      checkbox.checked = slideEffects.includes(checkbox.value);
    });
  }

  // åŠ è½½å›¾åº“å›¾ç‰‡
  async function loadGalleryImages(groupId) {
    try {
      const response = await fetch(`${API_BASE}/gallery/groups/${groupId}/images`);
      const data = await response.json();
      
      const imagesGrid = el('galleryImagesGrid');
      imagesGrid.innerHTML = '';
      
      if (data.images.length === 0) {
        imagesGrid.innerHTML = '<div style="text-align:center;color:var(--muted);padding:20px;grid-column:1/-1">è¯¥åˆ†ç»„æš‚æ— å›¾ç‰‡</div>';
        return;
      }
      
      // ä¸ºæ¯å¼ å›¾ç‰‡åˆ›å»ºç½‘æ ¼é¡¹
      data.images.forEach(image => {
        const imageItem = document.createElement('div');
        imageItem.className = 'gallery-item';
        imageItem.dataset.imageId = image.id;
        
        imageItem.innerHTML = `
          <input type="checkbox" class="gallery-item-checkbox" onchange="onGalleryImageSelect(this)">
          <button class="gallery-item-delete" onclick="deleteGalleryImage('${image.id}', event)" title="åˆ é™¤å›¾ç‰‡">Ã—</button>
          <img src="${API_BASE}/files/${image.id}" alt="${image.name}" loading="lazy">
        `;
        
        imagesGrid.appendChild(imageItem);
      });
      
    } catch (error) {
      toast(`åŠ è½½å›¾åº“å›¾ç‰‡å¤±è´¥: ${error.message}`, 'err');
    }
  }

  // å›¾åº“å›¾ç‰‡é€‰æ‹©äº‹ä»¶
  function onGalleryImageSelect(checkbox) {
    const imageItem = checkbox.closest('.gallery-item');
    if (checkbox.checked) {
      imageItem.classList.add('selected');
    } else {
      imageItem.classList.remove('selected');
    }
  }

  // å…¨é€‰å›¾åº“å›¾ç‰‡
  function selectAllGalleryImages() {
    const checkboxes = el('galleryImagesGrid').querySelectorAll('.gallery-item-checkbox');
    checkboxes.forEach(checkbox => {
      checkbox.checked = true;
      onGalleryImageSelect(checkbox);
    });
  }

  // å…¨ä¸é€‰å›¾åº“å›¾ç‰‡
  function selectNoneGalleryImages() {
    const checkboxes = el('galleryImagesGrid').querySelectorAll('.gallery-item-checkbox');
    checkboxes.forEach(checkbox => {
      checkbox.checked = false;
      onGalleryImageSelect(checkbox);
    });
  }

  // åˆ é™¤é€‰ä¸­çš„å›¾åº“å›¾ç‰‡
  async function deleteSelectedGalleryImages() {
    const selectedCheckboxes = el('galleryImagesGrid').querySelectorAll('.gallery-item-checkbox:checked');
    
    if (selectedCheckboxes.length === 0) {
      toast('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„å›¾ç‰‡', 'warn');
      return;
    }
    
    const confirmed = await showCustomConfirm(
      'ç¡®è®¤åˆ é™¤',
      `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedCheckboxes.length} å¼ å›¾ç‰‡å—ï¼Ÿåˆ é™¤åå°†æ— æ³•æ¢å¤ã€‚`,
      'åˆ é™¤',
      'å–æ¶ˆ'
    );
    
    if (!confirmed) return;
    
    try {
      const imageIds = Array.from(selectedCheckboxes).map(cb => cb.closest('.gallery-item').dataset.imageId);
      
      const response = await fetch(`${API_BASE}/gallery/images/batch-delete`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ image_ids: imageIds })
      });
      
      const result = await response.json();
      
      if (result.success) {
        toast(`âœ… æˆåŠŸåˆ é™¤ ${result.deleted_count} å¼ å›¾ç‰‡`, 'ok');
        // é‡æ–°åŠ è½½å½“å‰åˆ†ç»„
        await selectGalleryGroup();
      } else {
        throw new Error(result.error || 'åˆ é™¤å¤±è´¥');
      }
    } catch (error) {
      toast(`âŒ åˆ é™¤å›¾ç‰‡å¤±è´¥: ${error.message}`, 'err');
    }
  }

  // åˆ é™¤å•å¼ å›¾åº“å›¾ç‰‡
  async function deleteGalleryImage(imageId, event) {
    event.stopPropagation();
    
    const confirmed = await showCustomConfirm(
      'ç¡®è®¤åˆ é™¤',
      'ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿåˆ é™¤åå°†æ— æ³•æ¢å¤ã€‚',
      'åˆ é™¤',
      'å–æ¶ˆ'
    );
    
    if (!confirmed) return;
    
    try {
      const response = await fetch(`${API_BASE}/gallery/images/${imageId}`, {
        method: 'DELETE'
      });
      
      const result = await response.json();
      
      if (result.success) {
        toast('âœ… å›¾ç‰‡åˆ é™¤æˆåŠŸ', 'ok');
        // é‡æ–°åŠ è½½å½“å‰åˆ†ç»„
        await selectGalleryGroup();
      } else {
        throw new Error(result.error || 'åˆ é™¤å¤±è´¥');
      }
    } catch (error) {
      toast(`âŒ åˆ é™¤å›¾ç‰‡å¤±è´¥: ${error.message}`, 'err');
    }
  }

  // åˆ é™¤å›¾åº“åˆ†ç»„
  async function deleteGalleryGroup() {
    if (!currentGalleryGroup) {
      toast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªåˆ†ç»„', 'warn');
      return;
    }
    
    const confirmed = await showCustomConfirm(
      'ç¡®è®¤åˆ é™¤',
      `ç¡®å®šè¦åˆ é™¤åˆ†ç»„ "${currentGalleryGroup.name}" å—ï¼Ÿè¯¥åˆ†ç»„ä¸­çš„æ‰€æœ‰å›¾ç‰‡éƒ½å°†è¢«åˆ é™¤ä¸”æ— æ³•æ¢å¤ã€‚`,
      'åˆ é™¤',
      'å–æ¶ˆ'
    );
    
    if (!confirmed) return;
    
    try {
      const response = await fetch(`${API_BASE}/gallery/groups/${currentGalleryGroup.id}`, {
        method: 'DELETE'
      });
      
      const result = await response.json();
      
      if (result.success) {
        toast('âœ… åˆ†ç»„åˆ é™¤æˆåŠŸ', 'ok');
        currentGalleryGroup = null;
        // é‡æ–°åŠ è½½åˆ†ç»„åˆ—è¡¨
        await loadGalleryGroups();
        // é‡ç½®ç•Œé¢
        el('galleryGroupSelect').value = '';
        selectGalleryGroup();
      } else {
        throw new Error(result.error || 'åˆ é™¤å¤±è´¥');
      }
    } catch (error) {
      toast(`âŒ åˆ é™¤åˆ†ç»„å¤±è´¥: ${error.message}`, 'err');
    }
  }

  // å›¾åº“å›¾ç‰‡ä¸Šä¼ å¤„ç†
  async function handleGalleryImageUpload() {
    const fileInput = el('galleryImageUpload');
    const files = fileInput.files;
    
    if (!files || files.length === 0) return;
    
    if (!currentGalleryGroup) {
      toast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªåˆ†ç»„', 'warn');
      return;
    }
    
    try {
      toast(`ğŸ“¤ æ­£åœ¨ä¸Šä¼  ${files.length} å¼ å›¾ç‰‡...`, 'info');
      
      // é€ä¸ªä¸Šä¼ æ–‡ä»¶
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        
        // æ£€æŸ¥æ–‡ä»¶ç±»å‹
        if (!file.type.startsWith('image/')) {
          toast(`âš ï¸ è·³è¿‡éå›¾ç‰‡æ–‡ä»¶: ${file.name}`, 'warn');
          continue;
        }
        
        const formData = new FormData();
        formData.append('file', file);
        formData.append('type', 'image');
        formData.append('group_id', currentGalleryGroup.id);
        
        const response = await fetch(`${API_BASE}/gallery/upload`, {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (!result.success) {
          toast(`âŒ ä¸Šä¼ å¤±è´¥ ${file.name}: ${result.error || 'æœªçŸ¥é”™è¯¯'}`, 'err');
        }
      }
      
      toast('âœ… å›¾ç‰‡ä¸Šä¼ å®Œæˆ', 'ok');
      
      // æ¸…ç©ºæ–‡ä»¶è¾“å…¥æ¡†
      fileInput.value = '';
      
      // é‡æ–°åŠ è½½å½“å‰åˆ†ç»„
      await selectGalleryGroup();
      
    } catch (error) {
      toast(`âŒ å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ${error.message}`, 'err');
      console.error('Upload error:', error);
    }
  }

  // è½¬åœºæ•ˆæœé€‰æ‹©ç›¸å…³å‡½æ•°
  function selectAllGalleryTransitions() {
    const checkboxes = el('galleryTransitionEffects').querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      checkbox.checked = true;
    });
  }

  function selectNoneGalleryTransitions() {
    const checkboxes = el('galleryTransitionEffects').querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      checkbox.checked = false;
    });
  }

  function selectSlideGalleryTransitions() {
    const checkboxes = el('galleryTransitionEffects').querySelectorAll('input[type="checkbox"]');
    const slideEffects = ['slideleft', 'slideright', 'slideup', 'slidedown'];
    checkboxes.forEach(checkbox => {
      checkbox.checked = slideEffects.includes(checkbox.value);
    });
  }

  function selectFadeGalleryTransitions() {
    const checkboxes = el('galleryTransitionEffects').querySelectorAll('input[type="checkbox"]');
    const fadeEffects = ['fadeblack', 'fadewhite', 'dissolve', 'fadefast', 'fadeslow', 'fadegrays'];
    checkboxes.forEach(checkbox => {
      checkbox.checked = fadeEffects.includes(checkbox.value);
    });
  }

  // ä¿®å¤é‡å¤æš´éœ²çš„é—®é¢˜ï¼Œç¡®ä¿æ¯ä¸ªå‡½æ•°åªæš´éœ²ä¸€æ¬¡
  // è½¬åœºæ•ˆæœé€‰æ‹©ç›¸å…³å‡½æ•°
  window.selectAllTransitions = selectAllTransitions;
  window.selectNoneTransitions = selectNoneTransitions;
  window.selectSlideTransitions = selectSlideTransitions;
  window.selectFadeTransitions = selectFadeTransitions;
  
  window.selectAllHistoryTransitions = selectAllHistoryTransitions;
  window.selectNoneHistoryTransitions = selectNoneHistoryTransitions;
  window.selectSlideHistoryTransitions = selectSlideHistoryTransitions;
  window.selectFadeHistoryTransitions = selectFadeHistoryTransitions;

  // ä»…ç”Ÿæˆå›¾ç‰‡æ¨¡å¼çš„ç›¸å…³å‡½æ•°
  window.selectAllImages = selectAllImages;
  window.selectNoneImages = selectNoneImages;
  window.deleteSelectedImage = deleteSelectedImage;
  window.deleteGalleryImage = deleteGalleryImage;
  window.selectAllComposeTransitions = selectAllComposeTransitions;
  window.selectNoneComposeTransitions = selectNoneComposeTransitions;
  window.selectSlideComposeTransitions = selectSlideComposeTransitions;
  window.selectFadeComposeTransitions = selectFadeComposeTransitions;

  // å†å²ä»»åŠ¡ç›¸å…³å‡½æ•°
  window.loadHistoryTasks = loadHistoryTasks;
  window.deleteHistoryTask = deleteHistoryTask;

  // å›¾åº“ç›¸å…³å‡½æ•°
  window.createNewGalleryGroup = createNewGalleryGroup;
  window.loadGalleryGroups = loadGalleryGroups;
  window.selectGalleryGroup = selectGalleryGroup;
  window.renameGalleryGroup = renameGalleryGroup;
  window.deleteGalleryGroup = deleteGalleryGroup;
  window.selectAllGalleryImages = selectAllGalleryImages;
  window.selectNoneGalleryImages = selectNoneGalleryImages;
  window.deleteSelectedGalleryImages = deleteSelectedGalleryImages;
  window.selectAllGalleryTransitions = selectAllGalleryTransitions;
  window.selectNoneGalleryTransitions = selectNoneGalleryTransitions;
  window.selectSlideGalleryTransitions = selectSlideGalleryTransitions;
  window.selectFadeGalleryTransitions = selectFadeGalleryTransitions;
  
  // æ¨¡å¼åˆ‡æ¢å‡½æ•°
  window.switchMode = switchMode;
  
  // å…¶ä»–éœ€è¦å…¨å±€è®¿é—®çš„å‡½æ•°
  window.showCustomModal = showCustomModal;
  window.showCustomConfirm = showCustomConfirm;
  window.hideCustomModal = hideCustomModal;
  window.showCustomModalWithInput = showCustomModalWithInput;
  window.handleGenerateImagesOnly = handleGenerateImagesOnly;
  window.handleComposeVideo = handleComposeVideo;
})();
</script>
</body>
</html>