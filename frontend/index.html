<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stylize Video - AIËßÜÈ¢ëÈ£éÊ†ºËΩ¨Êç¢Â∑•ÂÖ∑</title>
  <style>
    :root{--bg:#0f172a;--panel:#111827;--text:#e5e7eb;--muted:#9ca3af;--accent:#22d3ee;--ok:#22c55e;--warn:#f59e0b;--err:#ef4444;--card:#0b1220}
    *{box-sizing:border-box} 
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0b1329 40%,#0a0f1a);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto;min-height:100vh}
    header{padding:20px 16px 8px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid rgba(255,255,255,.06)}
    h1{font-size:18px;margin:0} a{color:var(--accent);text-decoration:none}
    .wrap{max-width:1200px;margin:0 auto;padding:12px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{background:radial-gradient(1200px 400px at -10% -10%,rgba(34,211,238,.1),transparent 40%),radial-gradient(1200px 400px at 110% 110%,rgba(34,197,94,.08),transparent 40%),var(--card);border:1px solid rgba(255,255,255,.06);border-radius:16px;box-shadow:0 6px 22px rgba(0,0,0,.35)}
    .card h2{font-size:16px;margin:0;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.06)}
    .card .body{padding:14px 16px}
    label{display:block;margin:.5rem 0 .25rem;color:var(--muted);font-size:12px}
    input[type=text],input[type=password],input[type=number],select,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.1);background:#0b1120;color:var(--text);font-size:13px}
    input[type=file]{border:1px dashed rgba(255,255,255,.25);padding:16px;border-radius:12px;width:100%;background:#0b1120;color:var(--muted)}
    button{cursor:pointer;background:linear-gradient(90deg,#22d3ee,#22c55e);border:none;color:#02111a;font-weight:700;letter-spacing:.2px;transition:all .2s}
    button:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(34,211,238,.3)}
    button:disabled{filter:grayscale(1);opacity:.55;cursor:not-allowed;transform:none}
    .row{display:flex;gap:10px;align-items:center}
    .muted{color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid rgba(255,255,255,.1);background:#0b1120;border-radius:999px;padding:6px 10px;margin:4px 6px 0 0;font-size:12px;text-decoration:none}
    .gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;margin-top:12px}
    .thumb{position:relative;background:#000;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,.1)}
    .thumb img{display:block;width:100%;height:160px;object-fit:cover}
    .thumb .info{position:absolute;left:8px;right:8px;bottom:8px;background:rgba(0,0,0,.8);backdrop-filter:blur(4px);padding:6px 8px;border-radius:8px;text-align:center;border:1px solid rgba(255,255,255,.2);font-size:11px}
    .log{max-height:220px;overflow:auto;background:#0b1120;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px;font-family:monospace;font-size:12px}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    progress{width:100%;height:14px;border-radius:7px;background:#1e293b;border:1px solid rgba(255,255,255,.1)}
    progress::-webkit-progress-bar{background:#1e293b;border-radius:7px}
    progress::-webkit-progress-value{background:linear-gradient(90deg,#22d3ee,#22c55e);border-radius:7px}
    footer{padding:20px 16px;color:var(--muted);text-align:center;border-top:1px solid rgba(255,255,255,.06);margin-top:20px}
    .tiny{font-size:12px}
    details{border:1px solid rgba(255,255,255,.08);border-radius:8px;margin-top:8px}
    details[open] summary{border-bottom:1px solid rgba(255,255,255,.08);margin-bottom:0}
    summary{padding:8px 12px;color:var(--accent);font-weight:500;cursor:pointer}
    details .config-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:12px}
    details input[type=number], details select{font-size:12px;padding:6px 8px}
    details label{font-size:11px;margin:.25rem 0 .125rem;color:var(--muted)}
    .status-indicator{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px}
    .status-connecting{background:#f59e0b}
    .status-connected{background:#22c55e}
    .status-error{background:#ef4444}
    .preview-container{margin-bottom:12px}
    .preview-img{width:100%;height:200px;object-fit:contain;background:#000;border-radius:8px;border:1px solid rgba(255,255,255,.1)}
    .task-status{background:rgba(255,255,255,.02);border-radius:8px;padding:12px;margin-top:12px;border:1px solid rgba(255,255,255,.08)}
    .video-container{margin-top:12px}
    .video-player{width:100%;height:600px;border-radius:12px;border:1px solid rgba(255,255,255,.1)}
    .transition-checkbox{display:flex;align-items:center;gap:4px;font-size:10px;padding:2px 4px;border-radius:4px;cursor:pointer;transition:background-color 0.2s}
    .transition-checkbox:hover{background:rgba(255,255,255,.05)}
    .transition-checkbox input{width:auto;margin:0;transform:scale(0.8)}
    .transition-checkbox label{margin:0;cursor:pointer;color:var(--muted);font-size:10px}
    .mode-btn{width:auto;padding:6px 12px;margin:0;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:var(--muted);font-size:12px}
    .mode-btn.active{background:linear-gradient(90deg,#22d3ee,#22c55e);color:#02111a;font-weight:600}
    
    /* Ëá™ÂÆö‰πâÁ°ÆËÆ§ÂØπËØùÊ°ÜÊ†∑Âºè */
    .custom-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px);z-index:9999;display:flex;align-items:center;justify-content:center;opacity:0;visibility:hidden;transition:all 0.3s ease}
    .custom-modal.show{opacity:1;visibility:visible}
    .modal-content{background:var(--card);border:1px solid rgba(255,255,255,.15);border-radius:16px;padding:24px;max-width:400px;width:90%;box-shadow:0 20px 40px rgba(0,0,0,0.5);transform:scale(0.9);transition:transform 0.3s ease}
    .custom-modal.show .modal-content{transform:scale(1)}
    .modal-icon{font-size:48px;text-align:center;margin-bottom:16px;color:var(--warn)}
    .modal-title{font-size:18px;font-weight:600;margin-bottom:8px;text-align:center;color:var(--text)}
    .modal-message{font-size:14px;color:var(--muted);text-align:center;margin-bottom:24px;line-height:1.5;white-space:pre-line;max-height:300px;overflow-y:auto}
    .modal-buttons{display:flex;gap:12px;justify-content:center}
    .modal-btn{padding:10px 20px;border-radius:8px;border:none;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.2s;min-width:80px}
    .modal-btn-confirm{background:linear-gradient(90deg,#ef4444,#dc2626);color:white}
    .modal-btn-confirm:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(239,68,68,0.4)}
    .modal-btn-cancel{background:rgba(255,255,255,.1);color:var(--text);border:1px solid rgba(255,255,255,.2)}
    .modal-btn-cancel:hover{background:rgba(255,255,255,.15);transform:translateY(-1px)}
    .history-task{border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:12px;margin-bottom:8px;cursor:pointer;transition:all 0.2s;position:relative}
    .history-task:hover{border-color:rgba(34,211,238,.3);background:rgba(34,211,238,.05)}
    .history-task.selected{border-color:#22d3ee;background:rgba(34,211,238,.1)}
    .history-task-title{font-size:13px;font-weight:600;margin-bottom:4px;display:flex;justify-content:space-between;align-items:center}
    .history-task-info{font-size:11px;color:var(--muted);line-height:1.4}
    .history-task-delete{background:rgba(239,68,68,0.8);color:white;border:none;border-radius:50%;width:20px;height:20px;font-size:12px;font-weight:bold;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;margin-left:8px}
    .history-task-delete:hover{background:rgba(239,68,68,1);transform:scale(1.1)}
    
    /* ÂõæÂ∫ìÁΩëÊ†ºÊ†∑Âºè */
    .gallery-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;max-height:300px;overflow-y:auto;border:1px solid rgba(255,255,255,.1);border-radius:6px;padding:8px}
    .gallery-item{position:relative;aspect-ratio:1;border-radius:6px;overflow:hidden;border:2px solid transparent;transition:all 0.2s;cursor:pointer}
    .gallery-item:hover{border-color:rgba(34,211,238,.3);transform:scale(1.02)}
    .gallery-item.selected{border-color:#22d3ee;box-shadow:0 0 12px rgba(34,211,238,.4)}
    .gallery-item img{width:100%;height:100%;object-fit:cover}
    .gallery-item-checkbox{position:absolute;top:4px;left:4px;width:16px;height:16px;cursor:pointer;z-index:2}
    .gallery-item-delete{position:absolute;top:4px;right:4px;background:rgba(239,68,68,0.8);color:white;border:none;border-radius:50%;width:18px;height:18px;font-size:10px;font-weight:bold;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;z-index:2}
    .gallery-item-delete:hover{background:rgba(239,68,68,1);transform:scale(1.1)}
    .gallery-group-option{padding:8px;border-bottom:1px solid rgba(255,255,255,.1);cursor:pointer;transition:background-color 0.2s}
    .gallery-group-option:hover{background:rgba(255,255,255,.05)}
    .gallery-group-option.selected{background:rgba(34,211,238,.1);color:#22d3ee}
    
    /* ÂõæÂ∫ìËæìÂÖ•Ê°ÜÊ†∑Âºè */
    .modal-input {
      width: 100%;
      padding: 10px;
      background: rgba(0,0,0,0.2);
      border: 1px solid rgba(255,255,255,.1);
      border-radius: 6px;
      color: var(--text);
      font-size: 0.9rem;
      margin-bottom: 20px;
    }
    
    .modal-input:focus {
      outline: 2px solid var(--accent);
      border-color: var(--accent);
    }
    
    @media (max-width: 768px) {
      .grid{grid-template-columns:1fr}
      .wrap{padding:8px}
    }
  </style>
</head>
<body>
  <header class="wrap">
    <h1>üé® Stylize Video</h1>
    <div class="tiny">
      <span id="connectionStatus" class="status-indicator status-connecting"></span>
      <span id="connectionText">ËøûÊé•‰∏≠...</span>
    </div>
  </header>

  <main class="wrap grid">
    <!-- Â∑¶ÔºöÈÖçÁΩÆ‰∏éÊìç‰Ωú -->
    <section class="card">
      <h2>1) ÈÖçÁΩÆ & ÁîüÊàê</h2>
      <div class="body">
        <!-- Ê®°ÂºèÈÄâÊã© -->
        <div style="margin-bottom: 16px">
          <label>ÁîüÊàêÊ®°Âºè</label>
          <div style="display:flex;gap:8px;margin-top:4px">
            <button type="button" id="newTaskBtn" class="mode-btn active" onclick="switchMode('new')">Êñ∞‰ªªÂä°</button>
            <button type="button" id="imageOnlyBtn" class="mode-btn" onclick="switchMode('image-only')">‰ªÖÁîüÊàêÂõæÁâá</button>
            <button type="button" id="historyTaskBtn" class="mode-btn" onclick="switchMode('history')">ÂéÜÂè≤‰ªªÂä°</button>
            <button type="button" id="galleryBtn" class="mode-btn" onclick="switchMode('gallery')">ÊàëÁöÑÂõæÂ∫ì</button>
          </div>
        </div>

        <!-- Êñ∞‰ªªÂä°Ê®°Âºè -->
        <div id="newTaskMode">
          <form id="newTaskForm" onsubmit="return false;">
            <label>OpenRouter API Key</label>
            <input id="apiKey" type="password" placeholder="sk-or-v1-..." />

            <label style="margin-top:10px">‰∏ä‰º†ÂéüÂõæ</label>
            <input id="inputImage" type="file" accept="image/*" />
          <div class="preview-container" style="margin-top:8px">
            <img id="origPreview" class="preview-img" style="display:none" alt="ÂéüÂõæÈ¢ÑËßà" />
          </div>

          <label style="margin-top:10px">ÈÄâÊã©Êú¨Âú∞ËÉåÊôØÈü≥‰πêÔºàÂèØÈÄâÔºâ</label>
          <input id="bgmFile" type="file" accept="audio/*" />

          <details style="margin-top:16px">
            <summary>‚öôÔ∏è È´òÁ∫ßÈÖçÁΩÆ</summary>
            <div class="config-grid">
              <div>
                <label>È£éÊ†ºÂõæÊï∞Èáè</label>
                <input id="slideCount" type="number" value="2" min="1" max="20" />
              </div>
              <div>
                <label>Â∏ßÁéá (FPS)</label>
                <input id="videoFps" type="number" value="30" min="15" max="60" />
              </div>
              <div>
                <label>ÊØèÂº†ÂõæÊåÅÁª≠Êó∂Èó¥ (Áßí)</label>
                <input id="perSlideSeconds" type="number" value="3.0" min="0.5" max="5" step="0.1" />
              </div>
              <div>
                <label>ËøáÊ∏°Êó∂Èó¥ (Áßí)</label>
                <input id="transitionSeconds" type="number" value="0.6" min="0" max="1" step="0.1" />
              </div>
              <div style="grid-column: span 2">
                <label>ËΩ¨Âú∫ÊïàÊûúÈÄâÊã© (ÂèØÂ§öÈÄâÔºåÂæ™ÁéØ‰ΩøÁî®)</label>
                <div style="display:flex;gap:4px;margin:4px 0;font-size:10px">
                  <button type="button" onclick="selectAllTransitions()" style="padding:2px 6px;font-size:10px;width:auto">ÂÖ®ÈÄâ</button>
                  <button type="button" onclick="selectNoneTransitions()" style="padding:2px 6px;font-size:10px;width:auto">Ê∏ÖÁ©∫</button>
                  <button type="button" onclick="selectSlideTransitions()" style="padding:2px 6px;font-size:10px;width:auto">Âè™ÈÄâÊªëÂä®</button>
                  <button type="button" onclick="selectFadeTransitions()" style="padding:2px 6px;font-size:10px;width:auto">Âè™ÈÄâÊ∑°Âåñ</button>
                </div>
                <div id="transitionEffects" style="display:grid;grid-template-columns:repeat(4,1fr);gap:4px;margin-top:4px;max-height:120px;overflow-y:auto;border:1px solid rgba(255,255,255,.1);border-radius:6px;padding:8px">
                  <!-- ËΩ¨Âú∫ÊïàÊûúÈÄâÈ°πÂ∞ÜÁî±JavaScriptÁîüÊàê -->
                </div>
              </div>
              <div>
                <label>ËßÜÈ¢ëÂÆΩÂ∫¶</label>
                <select id="videoWidth">
                  <option value="720">720 (ÊäñÈü≥Á´ñÂ±è)</option>
                  <option value="1280">1280 (720p)</option>
                  <option value="1920">1920 (1080p)</option>
                  <option value="854">854 (480p)</option>
                </select>
              </div>
              <div>
                <label>ËßÜÈ¢ëÈ´òÂ∫¶</label>
                <select id="videoHeight">
                  <option value="1280">1280 (ÊäñÈü≥Á´ñÂ±è)</option>
                  <option value="720">720</option>
                  <option value="1080">1080</option>
                  <option value="480">480</option>
                </select>
              </div>
              <div>
                <label>Âπ∂ÂèëËØ∑Ê±ÇÊï∞</label>
                <input id="concurrentLimit" type="number" value="1" min="1" max="5" />
              </div>
              <div style="display:flex;align-items:center;padding-top:20px">
                <label style="margin:0">
                  <input id="includeOriginal" type="checkbox" checked style="width:auto;margin-right:6px" /> 
                  Âú®ËßÜÈ¢ë‰∏≠ÂåÖÂê´ÂéüÂõæ
                </label>
              </div>
            </div>
          </details>
          </form>
        </div>

        <!-- ‰ªÖÁîüÊàêÂõæÁâáÊ®°Âºè -->
        <div id="imageOnlyMode" style="display:none">
          <form id="imageOnlyForm" onsubmit="return false;">
            <label>OpenRouter API Key</label>
            <input id="imageApiKey" type="password" placeholder="sk-or-v1-..." />

          <label style="margin-top:10px">‰∏ä‰º†ÂéüÂõæ</label>
          <input id="imageInputImage" type="file" accept="image/*" />
          <div class="preview-container" style="margin-top:8px">
            <img id="imageOrigPreview" class="preview-img" style="display:none" alt="ÂéüÂõæÈ¢ÑËßà" />
          </div>

          <details style="margin-top:16px">
            <summary>‚öôÔ∏è ÁîüÊàêÈÖçÁΩÆ</summary>
            <div class="config-grid">
              <div>
                <label>È£éÊ†ºÂõæÊï∞Èáè</label>
                <input id="imageSlideCount" type="number" value="2" min="1" max="20" />
              </div>
              <div>
                <label>Âπ∂ÂèëËØ∑Ê±ÇÊï∞</label>
                <input id="imageConcurrentLimit" type="number" value="1" min="1" max="5" />
              </div>
            </div>
          </details>
          
          <!-- ÂõæÁâáÈÄâÊã©ÁÆ°ÁêÜÂå∫Âüü -->
          <div id="imageSelectionArea" style="display:none;margin-top:16px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <h3 style="font-size:14px;margin:0">ÈÄâÊã©Ë¶ÅÂåÖÂê´ÁöÑÂõæÁâá</h3>
              <div style="display:flex;gap:8px">
                <button type="button" onclick="selectAllImages()" style="padding:4px 8px;font-size:11px;width:auto">ÂÖ®ÈÄâ</button>
                <button type="button" onclick="selectNoneImages()" style="padding:4px 8px;font-size:11px;width:auto">ÂÖ®‰∏çÈÄâ</button>
              </div>
            </div>
            <div id="imageGallerySelection" class="gallery">
              <!-- ÂõæÁâáÈÄâÊã©ÂàóË°®Â∞ÜÁî±JavaScriptÁîüÊàê -->
            </div>
            
            <!-- ËßÜÈ¢ëÂêàÊàêÈÖçÁΩÆ -->
            <details style="margin-top:16px">
              <summary>‚öôÔ∏è ËßÜÈ¢ëÂêàÊàêÈÖçÁΩÆ</summary>
              <div class="config-grid">
                <div>
                  <label>Â∏ßÁéá (FPS)</label>
                  <input id="composeVideoFps" type="number" value="30" min="15" max="60" />
                </div>
                <div>
                  <label>ÊØèÂº†ÂõæÊåÅÁª≠Êó∂Èó¥ (Áßí)</label>
                  <input id="composePerSlideSeconds" type="number" value="3.0" min="0.5" max="5" step="0.1" />
                </div>
                <div>
                  <label>ËøáÊ∏°Êó∂Èó¥ (Áßí)</label>
                  <input id="composeTransitionSeconds" type="number" value="0.6" min="0" max="1" step="0.1" />
                </div>
                <div>
                  <label>ËßÜÈ¢ëÂÆΩÂ∫¶</label>
                  <select id="composeVideoWidth">
                    <option value="720">720 (ÊäñÈü≥Á´ñÂ±è)</option>
                    <option value="1280">1280 (720p)</option>
                    <option value="1920">1920 (1080p)</option>
                    <option value="854">854 (480p)</option>
                  </select>
                </div>
                <div>
                  <label>ËßÜÈ¢ëÈ´òÂ∫¶</label>
                  <select id="composeVideoHeight">
                    <option value="1280">1280 (ÊäñÈü≥Á´ñÂ±è)</option>
                    <option value="720">720</option>
                    <option value="1080">1080</option>
                    <option value="480">480</option>
                  </select>
                </div>
                <div style="grid-column: span 2">
                  <label>ËΩ¨Âú∫ÊïàÊûúÈÄâÊã© (ÂèØÂ§öÈÄâÔºåÂæ™ÁéØ‰ΩøÁî®)</label>
                  <div style="display:flex;gap:4px;margin:4px 0;font-size:10px">
                    <button type="button" onclick="selectAllComposeTransitions()" style="padding:2px 6px;font-size:10px;width:auto">ÂÖ®ÈÄâ</button>
                    <button type="button" onclick="selectNoneComposeTransitions()" style="padding:2px 6px;font-size:10px;width:auto">Ê∏ÖÁ©∫</button>
                    <button type="button" onclick="selectSlideComposeTransitions()" style="padding:2px 6px;font-size:10px;width:auto">Âè™ÈÄâÊªëÂä®</button>
                    <button type="button" onclick="selectFadeComposeTransitions()" style="padding:2px 6px;font-size:10px;width:auto">Âè™ÈÄâÊ∑°Âåñ</button>
                  </div>
                  <div id="composeTransitionEffects" style="display:grid;grid-template-columns:repeat(4,1fr);gap:4px;margin-top:4px;max-height:120px;overflow-y:auto;border:1px solid rgba(255,255,255,.1);border-radius:6px;padding:8px">
                    <!-- ËΩ¨Âú∫ÊïàÊûúÈÄâÈ°πÂ∞ÜÁî±JavaScriptÁîüÊàê -->
                  </div>
                </div>
                <div style="display:flex;align-items:center;padding-top:20px">
                  <label style="margin:0">
                    <input id="composeIncludeOriginal" type="checkbox" checked style="width:auto;margin-right:6px" /> 
                    Âú®ËßÜÈ¢ë‰∏≠ÂåÖÂê´ÂéüÂõæ
                  </label>
                </div>
              </div>
            </details>
            
            <label style="margin-top:10px">ÈÄâÊã©Êú¨Âú∞ËÉåÊôØÈü≥‰πêÔºàÂèØÈÄâÔºâ</label>
            <input id="composeBgmFile" type="file" accept="audio/*" />
          </div>
        </div>

        <!-- ÂéÜÂè≤‰ªªÂä°Ê®°Âºè -->
        <div id="historyTaskMode" style="display:none">
          <div style="margin-bottom:10px">
            <button type="button" onclick="loadHistoryTasks()" style="width:auto;padding:8px 16px">Âà∑Êñ∞ÂàóË°®</button>
          </div>
          <div id="historyTasksList" style="max-height:400px;overflow-y:auto">
            <!-- ÂéÜÂè≤‰ªªÂä°ÂàóË°®Â∞ÜÁî±JavaScriptÁîüÊàê -->
          </div>
          
          <!-- ÈÄâ‰∏≠‰ªªÂä°ÁöÑÈÖçÁΩÆ -->
          <div id="historyTaskConfig" style="display:none;margin-top:16px">
            <h3 style="font-size:14px;margin:0 0 12px 0">ÈáçÊñ∞ÁîüÊàêÈÖçÁΩÆ</h3>
            <div class="config-grid">
              <div>
                <label>Â∏ßÁéá (FPS)</label>
                <input id="historyVideoFps" type="number" value="30" min="15" max="60" />
              </div>
              <div>
                <label>ÊØèÂº†ÂõæÊåÅÁª≠Êó∂Èó¥ (Áßí)</label>
                <input id="historyPerSlideSeconds" type="number" value="3.0" min="0.5" max="5" step="0.1" />
              </div>
              <div>
                <label>ÂõæÁâáÂæ™ÁéØÂÄçÊï∞</label>
                <input id="historyImageMultiplier" type="number" value="1" min="1" max="10" title="ËÆæÁΩÆÂõæÁâáÂæ™ÁéØÂÄçÊï∞ÔºåÂ¶Ç3Âº†ÂõæÁâáËÆæÁΩÆ3ÂÄçÂàôÂæ™ÁéØ‰∏∫: 1-2-3-1-2-3-1-2-3" />
              </div>
              <div>
                <label>ËøáÊ∏°Êó∂Èó¥ (Áßí)</label>
                <input id="historyTransitionSeconds" type="number" value="0.6" min="0" max="1" step="0.1" />
              </div>
              <div>
                <label>ËßÜÈ¢ëÂÆΩÂ∫¶</label>
                <select id="historyVideoWidth">
                  <option value="720">720 (ÊäñÈü≥Á´ñÂ±è)</option>
                  <option value="1280">1280 (720p)</option>
                  <option value="1920">1920 (1080p)</option>
                  <option value="854">854 (480p)</option>
                </select>
              </div>
              <div>
                <label>ËßÜÈ¢ëÈ´òÂ∫¶</label>
                <select id="historyVideoHeight">
                  <option value="1280">1280 (ÊäñÈü≥Á´ñÂ±è)</option>
                  <option value="720">720</option>
                  <option value="1080">1080</option>
                  <option value="480">480</option>
                </select>
              </div>
              <div>
                <label>ËÉåÊôØÈü≥‰πê (ÂèØÈÄâ)</label>
                <input id="historyBgmFile" type="file" accept="audio/*" />
              </div>
              <div style="grid-column: span 2">
                <label>ËΩ¨Âú∫ÊïàÊûúÈÄâÊã©</label>
                <div style="display:flex;gap:4px;margin:4px 0;font-size:10px">
                  <button type="button" onclick="selectAllHistoryTransitions()" style="padding:2px 6px;font-size:10px;width:auto">ÂÖ®ÈÄâ</button>
                  <button type="button" onclick="selectNoneHistoryTransitions()" style="padding:2px 6px;font-size:10px;width:auto">Ê∏ÖÁ©∫</button>
                  <button type="button" onclick="selectSlideHistoryTransitions()" style="padding:2px 6px;font-size:10px;width:auto">Âè™ÈÄâÊªëÂä®</button>
                  <button type="button" onclick="selectFadeHistoryTransitions()" style="padding:2px 6px;font-size:10px;width:auto">Âè™ÈÄâÊ∑°Âåñ</button>
                </div>
                <div id="historyTransitionEffects" style="display:grid;grid-template-columns:repeat(4,1fr);gap:4px;margin-top:4px;max-height:120px;overflow-y:auto;border:1px solid rgba(255,255,255,.1);border-radius:6px;padding:8px">
                  <!-- ËΩ¨Âú∫ÊïàÊûúÈÄâÈ°πÂ∞ÜÁî±JavaScriptÁîüÊàê -->
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ÊàëÁöÑÂõæÂ∫ìÊ®°Âºè -->
        <div id="galleryMode" style="display:none">
          <!-- ÂàÜÁªÑÁÆ°ÁêÜ -->
          <div style="margin-bottom:16px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <h3 style="font-size:14px;margin:0">ÂõæÁâáÂàÜÁªÑÁÆ°ÁêÜ</h3>
              <div style="display:flex;gap:8px">
                <button type="button" onclick="createNewGalleryGroup()" style="padding:4px 8px;font-size:11px;width:auto">Êñ∞Âª∫ÂàÜÁªÑ</button>
                <button type="button" onclick="loadGalleryGroups()" style="padding:4px 8px;font-size:11px;width:auto">Âà∑Êñ∞</button>
              </div>
            </div>
            
            <!-- ÂàÜÁªÑÈÄâÊã©‰∏ãÊãâÊ°Ü -->
            <select id="galleryGroupSelect" onchange="selectGalleryGroup()" style="width:100%;margin-bottom:8px">
              <option value="">ÈÄâÊã©ÊàñÂàõÂª∫ÂàÜÁªÑ...</option>
            </select>
            
            <!-- ÂàÜÁªÑÁÆ°ÁêÜÊåâÈíÆ -->
            <div id="galleryGroupActions" style="display:none;gap:8px;margin-bottom:8px">
              <button type="button" onclick="renameGalleryGroup()" style="padding:4px 8px;font-size:11px;width:auto">ÈáçÂëΩÂêçÂàÜÁªÑ</button>
              <button type="button" onclick="deleteGalleryGroup()" style="padding:4px 8px;font-size:11px;width:auto;background:#dc3545;color:white">Âà†Èô§ÂàÜÁªÑ</button>
            </div>
          </div>
          
          <!-- ÂõæÁâá‰∏ä‰º†Âå∫Âüü -->
          <div id="galleryUploadArea" style="display:none;margin-bottom:16px">
            <label>‰∏ä‰º†ÂõæÁâáÂà∞ÂΩìÂâçÂàÜÁªÑ</label>
            <input id="galleryImageUpload" type="file" accept="image/*" multiple />
            <div style="font-size:11px;color:var(--muted);margin-top:4px">ÊîØÊåÅÂ§öÈÄâ‰∏ä‰º†ÔºåÂõæÁâáÂ∞ÜË¢´Ê∑ªÂä†Âà∞ÂΩìÂâçÈÄâ‰∏≠ÁöÑÂàÜÁªÑ‰∏≠</div>
          </div>
          
          <!-- ÂõæÁâáÁΩëÊ†ºÊòæÁ§∫Âå∫Âüü -->
          <div id="galleryImagesArea" style="display:none">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div style="font-size:14px;font-weight:bold" id="galleryGroupTitle">ÂàÜÁªÑ‰∏≠ÁöÑÂõæÁâá</div>
              <div style="display:flex;gap:8px">
                <button type="button" onclick="selectAllGalleryImages()" style="padding:4px 8px;font-size:11px;width:auto">ÂÖ®ÈÄâ</button>
                <button type="button" onclick="selectNoneGalleryImages()" style="padding:4px 8px;font-size:11px;width:auto">ÂÖ®‰∏çÈÄâ</button>
                <button type="button" onclick="deleteSelectedGalleryImages()" style="padding:4px 8px;font-size:11px;width:auto;background:#dc3545;color:white">Âà†Èô§ÈÄâ‰∏≠</button>
              </div>
            </div>
            <div id="galleryImagesGrid" class="gallery-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;max-height:300px;overflow-y:auto;border:1px solid rgba(255,255,255,.1);border-radius:6px;padding:8px">
              <!-- ÂõæÁâáÂ∞ÜÁî±JavaScriptÁîüÊàê -->
            </div>
          </div>
          
          <!-- ÁîüÊàêËßÜÈ¢ëÈÖçÁΩÆ -->
          <div id="galleryVideoConfig" style="display:none;margin-top:16px">
            <h3 style="font-size:14px;margin:0 0 12px 0">‰ªéÂõæÂ∫ìÁîüÊàêËßÜÈ¢ë</h3>
            <div class="config-grid">
              <div>
                <label>Â∏ßÁéá (FPS)</label>
                <input id="galleryVideoFps" type="number" value="30" min="15" max="60" />
              </div>
              <div>
                <label>ÊØèÂº†ÂõæÊåÅÁª≠Êó∂Èó¥ (Áßí)</label>
                <input id="galleryPerSlideSeconds" type="number" value="3.0" min="0.5" max="5" step="0.1" />
              </div>
              <div>
                <label>ÂõæÁâáÂæ™ÁéØÂÄçÊï∞</label>
                <input id="galleryImageMultiplier" type="number" value="1" min="1" max="10" title="ËÆæÁΩÆÂõæÁâáÂæ™ÁéØÂÄçÊï∞ÔºåÂ¶Ç3Âº†ÂõæÁâáËÆæÁΩÆ3ÂÄçÂàôÂæ™ÁéØ‰∏∫: 1-2-3-1-2-3-1-2-3" />
              </div>
              <div>
                <label>ËøáÊ∏°Êó∂Èó¥ (Áßí)</label>
                <input id="galleryTransitionSeconds" type="number" value="0.6" min="0" max="1" step="0.1" />
              </div>
              <div>
                <label>ËßÜÈ¢ëÂÆΩÂ∫¶</label>
                <select id="galleryVideoWidth">
                  <option value="720">720 (ÊäñÈü≥Á´ñÂ±è)</option>
                  <option value="1280">1280 (720p)</option>
                  <option value="1920">1920 (1080p)</option>
                  <option value="854">854 (480p)</option>
                </select>
              </div>
              <div>
                <label>ËßÜÈ¢ëÈ´òÂ∫¶</label>
                <select id="galleryVideoHeight">
                  <option value="1280">1280 (ÊäñÈü≥Á´ñÂ±è)</option>
                  <option value="720">720</option>
                  <option value="1080">1080</option>
                  <option value="480">480</option>
                </select>
              </div>
              <div>
                <label>ËÉåÊôØÈü≥‰πê (ÂèØÈÄâ)</label>
                <input id="galleryBgmFile" type="file" accept="audio/*" />
              </div>
              <div style="grid-column: span 2">
                <label>ËΩ¨Âú∫ÊïàÊûúÈÄâÊã©</label>
                <div style="display:flex;gap:4px;margin:4px 0;font-size:10px">
                  <button type="button" onclick="selectAllGalleryTransitions()" style="padding:2px 6px;font-size:10px;width:auto">ÂÖ®ÈÄâ</button>
                  <button type="button" onclick="selectNoneGalleryTransitions()" style="padding:2px 6px;font-size:10px;width:auto">Ê∏ÖÁ©∫</button>
                  <button type="button" onclick="selectSlideGalleryTransitions()" style="padding:2px 6px;font-size:10px;width:auto">Âè™ÈÄâÊªëÂä®</button>
                  <button type="button" onclick="selectFadeGalleryTransitions()" style="padding:2px 6px;font-size:10px;width:auto">Âè™ÈÄâÊ∑°Âåñ</button>
                </div>
                <div id="galleryTransitionEffects" style="display:grid;grid-template-columns:repeat(4,1fr);gap:4px;margin-top:4px;max-height:120px;overflow-y:auto;border:1px solid rgba(255,255,255,.1);border-radius:6px;padding:8px">
                  <!-- ËΩ¨Âú∫ÊïàÊûúÈÄâÈ°πÂ∞ÜÁî±JavaScriptÁîüÊàê -->
                </div>
              </div>
              <div style="display:flex;align-items:center;padding-top:20px">
                <label style="margin:0">
                  <input id="galleryIncludeOriginal" type="checkbox" style="width:auto;margin-right:6px" /> 
                  Âú®ËßÜÈ¢ë‰∏≠ÂåÖÂê´ÂéüÂõæ
                </label>
              </div>
            </div>
          </div>
        </div>

        <div style="margin-top:14px" class="row">
          <button id="startBtn">ÂºÄÂßãÁîüÊàêÂπ∂ÂêàÊàêËßÜÈ¢ë</button>
        </div>

        <div id="taskStatus" class="task-status" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <span id="taskMessage">ÂáÜÂ§á‰∏≠...</span>
            <span id="taskProgress">0%</span>
          </div>
          <progress id="prog" value="0" max="100"></progress>
          <div id="log" class="log" style="margin-top:8px;max-height:150px"></div>
        </div>
      </div>
    </section>

    <!-- Âè≥ÔºöÁªìÊûúÈ¢ÑËßà -->
    <section class="card">
      <h2>2) ÁªìÊûú & ‰∏ãËΩΩ</h2>
      <div class="body">
        <div id="imagesSection">
          <div class="muted tiny">ÁîüÊàêÁöÑÈ£éÊ†ºÂåñÂõæÁâá</div>
          <div id="gallery" class="gallery"></div>
        </div>
        
        <div id="videoSection" class="video-container" style="display:none">
          <div class="muted tiny">ÂêàÊàêËßÜÈ¢ë</div>
          <video id="videoOut" class="video-player" controls playsinline></video>
          <div class="row" style="margin-top:8px">
            <a id="dlVideo" class="pill" download="stylized_slideshow.mp4">üì• ‰∏ãËΩΩËßÜÈ¢ë</a>
            <a id="dlOrig" class="pill" download="original.jpg">üì∏ ‰∏ãËΩΩÂéüÂõæ</a>
          </div>
        </div>

        <div id="statsSection" style="margin-top:16px;display:none">
          <div class="tiny muted">ÁîüÊàêÁªüËÆ°</div>
          <div id="stats" style="font-size:11px;color:var(--muted);margin-top:4px"></div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="tiny" id="footerInfo">AIÈ©±Âä®ÁöÑËßÜÈ¢ëÈ£éÊ†ºËΩ¨Êç¢Â∑•ÂÖ∑ - ÂÆåÂÖ®Êú¨Âú∞ËøêË°åÔºå‰øùÊä§ÈöêÁßÅÂÆâÂÖ®</div>
  </footer>

  <!-- Ëá™ÂÆö‰πâÁ°ÆËÆ§ÂØπËØùÊ°Ü -->
  <div id="customModal" class="custom-modal">
    <div class="modal-content">
      <div class="modal-icon">‚ö†Ô∏è</div>
      <div class="modal-title">Á°ÆËÆ§Âà†Èô§</div>
      <div class="modal-message">Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÂº†ÂõæÁâáÂêóÔºüÂà†Èô§ÂêéÂ∞ÜÊó†Ê≥ïÊÅ¢Â§ç„ÄÇ</div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" onclick="hideCustomModal(false)">ÂèñÊ∂à</button>
        <button class="modal-btn modal-btn-confirm" onclick="hideCustomModal(true)">Âà†Èô§</button>
      </div>
    </div>
  </div>

<script>
(function(){
  // APIÈÖçÁΩÆ
  const API_BASE = '/api';
  
  // DOMÂÖÉÁ¥†
  const el = (id) => document.getElementById(id);
  const apiKeyInput = el('apiKey');
  const inputImage = el('inputImage');
  const bgmFile = el('bgmFile');
  const startBtn = el('startBtn');
  const origPreview = el('origPreview');
  const gallery = el('gallery');
  const videoOut = el('videoOut');
  const dlVideo = el('dlVideo');
  const dlOrig = el('dlOrig');
  const taskStatus = el('taskStatus');
  const taskMessage = el('taskMessage');
  const taskProgress = el('taskProgress');
  const prog = el('prog');
  const logBox = el('log');
  const connectionStatus = el('connectionStatus');
  const connectionText = el('connectionText');
  const videoSection = el('videoSection');
  const statsSection = el('statsSection');

  // ÈÖçÁΩÆÊéß‰ª∂
  const slideCountInput = el('slideCount');
  const videoFpsInput = el('videoFps');
  const perSlideSecondsInput = el('perSlideSeconds');
  const transitionSecondsInput = el('transitionSeconds');
  const videoWidthSelect = el('videoWidth');
  const videoHeightSelect = el('videoHeight');
  const includeOriginalCheckbox = el('includeOriginal');
  const concurrentLimitInput = el('concurrentLimit');
  const transitionEffectsContainer = el('transitionEffects');

  // ÂéÜÂè≤‰ªªÂä°Áõ∏ÂÖ≥ÂÖÉÁ¥†
  const newTaskMode = el('newTaskMode');
  const historyTaskMode = el('historyTaskMode');
  const historyTasksList = el('historyTasksList');
  const historyTaskConfig = el('historyTaskConfig');
  const historyVideoFpsInput = el('historyVideoFps');
  const historyPerSlideSecondsInput = el('historyPerSlideSeconds');
  const historyTransitionSecondsInput = el('historyTransitionSeconds');
  const historyImageMultiplierInput = el('historyImageMultiplier');
  const historyVideoWidthSelect = el('historyVideoWidth');
  const historyVideoHeightSelect = el('historyVideoHeight');
  const historyBgmFile = el('historyBgmFile');
  const historyTransitionEffectsContainer = el('historyTransitionEffects');

  // Êñ∞Â¢ûÔºö‰ªÖÁîüÊàêÂõæÁâáÊ®°ÂºèÁõ∏ÂÖ≥ÂÖÉÁ¥†
  const imageOnlyMode = el('imageOnlyMode');
  const imageApiKeyInput = el('imageApiKey');
  const imageInputImage = el('imageInputImage');
  const imageOrigPreview = el('imageOrigPreview');
  const imageSlideCountInput = el('imageSlideCount');
  const imageConcurrentLimitInput = el('imageConcurrentLimit');
  const imageSelectionArea = el('imageSelectionArea');
  const imageGallerySelection = el('imageGallerySelection');
  const composeVideoFpsInput = el('composeVideoFps');
  const composePerSlideSecondsInput = el('composePerSlideSeconds');
  const composeTransitionSecondsInput = el('composeTransitionSeconds');
  const composeVideoWidthSelect = el('composeVideoWidth');
  const composeVideoHeightSelect = el('composeVideoHeight');
  const composeTransitionEffectsContainer = el('composeTransitionEffects');
  const composeIncludeOriginalCheckbox = el('composeIncludeOriginal');
  const composeBgmFile = el('composeBgmFile');

  // ÂèØÁî®ÁöÑËΩ¨Âú∫ÊïàÊûúÂàóË°®
  const availableTransitions = [
    { value: 'slideleft', label: 'Â∑¶Êªë' },
    { value: 'slideright', label: 'Âè≥Êªë' },
    { value: 'slideup', label: '‰∏äÊªë' },
    { value: 'slidedown', label: '‰∏ãÊªë' },
    { value: 'wipeleft', label: 'Â∑¶Êì¶Èô§' },
    { value: 'wiperight', label: 'Âè≥Êì¶Èô§' },
    { value: 'wipeup', label: '‰∏äÊì¶Èô§' },
    { value: 'wipedown', label: '‰∏ãÊì¶Èô§' },
    { value: 'fadeblack', label: 'ÈªëËâ≤Ê∑°ÂÖ•' },
    { value: 'fadewhite', label: 'ÁôΩËâ≤Ê∑°ÂÖ•' },
    { value: 'dissolve', label: 'Ê∫∂Ëß£' },
    { value: 'pixelize', label: 'ÂÉèÁ¥†Âåñ' },
    { value: 'circlecrop', label: 'ÂúÜÂΩ¢Ë£ÅÂàá' },
    { value: 'rectcrop', label: 'Áü©ÂΩ¢Ë£ÅÂàá' },
    { value: 'distance', label: 'Ë∑ùÁ¶ª' },
    { value: 'radial', label: 'ÂæÑÂêë' },
    { value: 'smoothleft', label: 'Âπ≥ÊªëÂ∑¶Áßª' },
    { value: 'smoothright', label: 'Âπ≥ÊªëÂè≥Áßª' },
    { value: 'smoothup', label: 'Âπ≥Êªë‰∏äÁßª' },
    { value: 'smoothdown', label: 'Âπ≥Êªë‰∏ãÁßª' },
    { value: 'circleopen', label: 'ÂúÜÂΩ¢ÂºÄÂêØ' },
    { value: 'circleclose', label: 'ÂúÜÂΩ¢ÂÖ≥Èó≠' },
    { value: 'vertopen', label: 'ÂûÇÁõ¥ÂºÄÂêØ' },
    { value: 'vertclose', label: 'ÂûÇÁõ¥ÂÖ≥Èó≠' },
    { value: 'horzopen', label: 'Ê∞¥Âπ≥ÂºÄÂêØ' },
    { value: 'horzclose', label: 'Ê∞¥Âπ≥ÂÖ≥Èó≠' },
    { value: 'diagtl', label: 'ÂØπËßíÂ∑¶‰∏ä' },
    { value: 'diagtr', label: 'ÂØπËßíÂè≥‰∏ä' },
    { value: 'diagbl', label: 'ÂØπËßíÂ∑¶‰∏ã' },
    { value: 'diagbr', label: 'ÂØπËßíÂè≥‰∏ã' },
    { value: 'hlslice', label: 'Ê∞¥Âπ≥Â∑¶ÂàáÁâá' },
    { value: 'hrslice', label: 'Ê∞¥Âπ≥Âè≥ÂàáÁâá' },
    { value: 'vuslice', label: 'ÂûÇÁõ¥‰∏äÂàáÁâá' },
    { value: 'vdslice', label: 'ÂûÇÁõ¥‰∏ãÂàáÁâá' },
    { value: 'hblur', label: 'Ê∞¥Âπ≥Ê®°Á≥ä' },
    { value: 'fadegrays', label: 'ÁÅ∞Â∫¶Ê∑°Âåñ' },
    { value: 'wipetl', label: 'Â∑¶‰∏äÊì¶Èô§' },
    { value: 'wipetr', label: 'Âè≥‰∏äÊì¶Èô§' },
    { value: 'wipebl', label: 'Â∑¶‰∏ãÊì¶Èô§' },
    { value: 'wipebr', label: 'Âè≥‰∏ãÊì¶Èô§' },
    { value: 'squeezeh', label: 'Ê∞¥Âπ≥Êå§Âéã' },
    { value: 'squeezev', label: 'ÂûÇÁõ¥Êå§Âéã' },
    { value: 'zoomin', label: 'ÊîæÂ§ß' },
    { value: 'fadefast', label: 'Âø´ÈÄüÊ∑°Âåñ' },
    { value: 'fadeslow', label: 'ÁºìÊÖ¢Ê∑°Âåñ' },
    { value: 'hlwind', label: 'Ê∞¥Âπ≥Â∑¶È£é' },
    { value: 'hrwind', label: 'Ê∞¥Âπ≥Âè≥È£é' },
    { value: 'vuwind', label: 'ÂûÇÁõ¥‰∏äÈ£é' },
    { value: 'vdwind', label: 'ÂûÇÁõ¥‰∏ãÈ£é' },
    { value: 'coverleft', label: 'Â∑¶Ë¶ÜÁõñ' },
    { value: 'coverright', label: 'Âè≥Ë¶ÜÁõñ' },
    { value: 'coverup', label: '‰∏äË¶ÜÁõñ' },
    { value: 'coverdown', label: '‰∏ãË¶ÜÁõñ' },
    { value: 'revealleft', label: 'Â∑¶Êè≠Á§∫' },
    { value: 'revealright', label: 'Âè≥Êè≠Á§∫' },
    { value: 'revealup', label: '‰∏äÊè≠Á§∫' },
    { value: 'revealdown', label: '‰∏ãÊè≠Á§∫' }
  ];

  // ÂÖ®Â±ÄÂèòÈáèÁî®‰∫éÂ§ÑÁêÜÊ®°ÊÄÅÂØπËØùÊ°ÜÁöÑÂõûË∞É
  let modalCallback = null;

  // ÊòæÁ§∫Ëá™ÂÆö‰πâÁ°ÆËÆ§ÂØπËØùÊ°ÜÔºàËøîÂõûPromiseÔºâ
  function showCustomConfirm(title, message, confirmText = 'Á°ÆËÆ§', cancelText = 'ÂèñÊ∂à') {
    return new Promise((resolve) => {
      const modal = document.getElementById('customModal');
      const titleEl = modal.querySelector('.modal-title');
      const messageEl = modal.querySelector('.modal-message');
      const confirmBtn = modal.querySelector('.modal-btn-confirm');
      const cancelBtn = modal.querySelector('.modal-btn-cancel');
      
      // ËÆæÁΩÆÂÜÖÂÆπ
      titleEl.textContent = title;
      messageEl.textContent = message;
      confirmBtn.textContent = confirmText;
      cancelBtn.textContent = cancelText;
      
      // ÈáçÁΩÆÁÇπÂáª‰∫ã‰ª∂ÔºàÈÅøÂÖç‰πãÂâçÁöÑ‰∫ã‰ª∂Âπ≤Êâ∞Ôºâ
      confirmBtn.onclick = () => {
        hideCustomModal();
        resolve(true);
      };
      
      cancelBtn.onclick = () => {
        hideCustomModal();
        resolve(false);
      };
      
      // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
      modal.classList.add('show');
      
      // ESCÈîÆÊîØÊåÅ
      const handleEscape = (event) => {
        if (event.key === 'Escape') {
          document.removeEventListener('keydown', handleEscape);
          hideCustomModal();
          resolve(false);
        }
      };
      
      document.addEventListener('keydown', handleEscape);
      
      // ÁÇπÂáªÂ§ñÈÉ®Âå∫ÂüüÂÖ≥Èó≠
      const handleOutsideClick = (event) => {
        if (event.target === modal) {
          document.removeEventListener('click', handleOutsideClick);
          hideCustomModal();
          resolve(false);
        }
      };
      
      setTimeout(() => {
        document.addEventListener('click', handleOutsideClick);
      }, 100); // Âª∂ËøüÊ∑ªÂä†ÔºåÈÅøÂÖçÁ´ãÂç≥Ëß¶Âèë
    });
  }

  // ÈöêËóèËá™ÂÆö‰πâÊ®°ÊÄÅÂØπËØùÊ°Ü
  function hideCustomModal() {
    const modal = document.getElementById('customModal');
    modal.classList.remove('show');
  }

  // ÊòæÁ§∫Ëá™ÂÆö‰πâÊ®°ÊÄÅÂØπËØùÊ°Ü
  function showCustomModal(message, callback) {
    const modal = document.getElementById('customModal');
    const messageEl = modal.querySelector('.modal-message');
    
    messageEl.textContent = message;
    modalCallback = callback;
    
    modal.classList.add('show');
    
    // ÁõëÂê¨ ESC ÈîÆÂÖ≥Èó≠ÂØπËØùÊ°Ü
    document.addEventListener('keydown', handleModalEscape);
  }

  // ÈöêËóèËá™ÂÆö‰πâÊ®°ÊÄÅÂØπËØùÊ°Ü
  function hideCustomModal(confirmed) {
    const modal = document.getElementById('customModal');
    modal.classList.remove('show');
    
    // ÁßªÈô§ ESC ÈîÆÁõëÂê¨
    document.removeEventListener('keydown', handleModalEscape);
    
    // ÊâßË°åÂõûË∞É
    if (modalCallback) {
      modalCallback(confirmed);
      modalCallback = null;
    }
  }

  // Â§ÑÁêÜ ESC ÈîÆÊåâ‰∏ã
  function handleModalEscape(event) {
    if (event.key === 'Escape') {
      hideCustomModal(false);
    }
  }

  // Â∞ÜÂáΩÊï∞Ê∑ªÂä†Âà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü
  window.showCustomModal = showCustomModal;
  window.showCustomConfirm = showCustomConfirm;
  window.hideCustomModal = hideCustomModal;

  // Áä∂ÊÄÅÂèòÈáè
  let currentTaskId = null;
  let pollingInterval = null;
  let uploadedImageId = null;
  let uploadedAudioId = null;
  let currentMode = 'new';  // ÂΩìÂâçÊ®°ÂºèÔºö'new'„ÄÅ'image-only' Êàñ 'history'
  let selectedHistoryTask = null;  // ÈÄâ‰∏≠ÁöÑÂéÜÂè≤‰ªªÂä°
  let historyAudioId = null;  // ÂéÜÂè≤‰ªªÂä°Ê®°Âºè‰∏ãÁöÑÈü≥È¢ëID
  let imageOnlyTaskId = null;  // ‰ªÖÁîüÊàêÂõæÁâá‰ªªÂä°ID
  let imageOnlyUploadedImageId = null;  // ‰ªÖÁîüÊàêÂõæÁâáÊ®°Âºè‰∏ãÁöÑÂéüÂõæ ID
  let composeAudioId = null;  // ÂêàÊàêËßÜÈ¢ëÊó∂ÁöÑÈü≥È¢ëID
  let currentGalleryGroup = null;  // ÂΩìÂâçÈÄâ‰∏≠ÁöÑÂõæÂ∫ìÂàÜÁªÑ
  let galleryAudioId = null;  // ÂõæÂ∫ìÊ®°Âºè‰∏ãÁöÑÈü≥È¢ëID

  // ÂàùÂßãÂåñ
  init();

  async function init() {
    setupEventListeners();
    initTransitionEffects();
    initHistoryTransitionEffects();
    initComposeTransitionEffects();
    initGalleryTransitionEffects();
    updateButtonText();
    await checkConnection();
  }

  function initTransitionEffects() {
    // ÂàùÂßãÂåñËΩ¨Âú∫ÊïàÊûúÈÄâÊã©Âô®
    transitionEffectsContainer.innerHTML = '';
    
    // ÈªòËÆ§ÈÄâ‰∏≠ÁöÑËΩ¨Âú∫ÊïàÊûú
    const defaultSelected = ['slideleft', 'slideright', 'slideup', 'slidedown'];
    
    availableTransitions.forEach(transition => {
      const wrapper = document.createElement('div');
      wrapper.className = 'transition-checkbox';
      
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.id = `transition_${transition.value}`;
      checkbox.value = transition.value;
      checkbox.checked = defaultSelected.includes(transition.value);
      
      const label = document.createElement('label');
      label.htmlFor = checkbox.id;
      label.textContent = transition.label;
      
      wrapper.appendChild(checkbox);
      wrapper.appendChild(label);
      transitionEffectsContainer.appendChild(wrapper);
      
      // Ê∑ªÂä†ÂèòÂåñ‰∫ã‰ª∂
      checkbox.onchange = updateButtonText;
    });
  }

  function initHistoryTransitionEffects() {
    // ÂàùÂßãÂåñÂéÜÂè≤‰ªªÂä°Ê®°Âºè‰∏ãÁöÑËΩ¨Âú∫ÊïàÊûúÈÄâÊã©Âô®
    historyTransitionEffectsContainer.innerHTML = '';
    
    // ÈªòËÆ§ÈÄâ‰∏≠ÁöÑËΩ¨Âú∫ÊïàÊûú
    const defaultSelected = ['slideleft', 'slideright', 'slideup', 'slidedown'];
    
    availableTransitions.forEach(transition => {
      const wrapper = document.createElement('div');
      wrapper.className = 'transition-checkbox';
      
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.id = `history_transition_${transition.value}`;
      checkbox.value = transition.value;
      checkbox.checked = defaultSelected.includes(transition.value);
      
      const label = document.createElement('label');
      label.htmlFor = checkbox.id;
      label.textContent = transition.label;
      
      wrapper.appendChild(checkbox);
      wrapper.appendChild(label);
      historyTransitionEffectsContainer.appendChild(wrapper);
    });
  }

  function initComposeTransitionEffects() {
    // ÂàùÂßãÂåñ‰ªÖÁîüÊàêÂõæÁâáÊ®°Âºè‰∏ãÁöÑËΩ¨Âú∫ÊïàÊûúÈÄâÊã©Âô®
    composeTransitionEffectsContainer.innerHTML = '';
    
    // ÈªòËÆ§ÈÄâ‰∏≠ÁöÑËΩ¨Âú∫ÊïàÊûú
    const defaultSelected = ['slideleft', 'slideright', 'slideup', 'slidedown'];
    
    availableTransitions.forEach(transition => {
      const wrapper = document.createElement('div');
      wrapper.className = 'transition-checkbox';
      
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.id = `compose_transition_${transition.value}`;
      checkbox.value = transition.value;
      checkbox.checked = defaultSelected.includes(transition.value);
      
      const label = document.createElement('label');
      label.htmlFor = checkbox.id;
      label.textContent = transition.label;
      
      wrapper.appendChild(checkbox);
      wrapper.appendChild(label);
      composeTransitionEffectsContainer.appendChild(wrapper);
    });
  }

  function initGalleryTransitionEffects() {
    // ÂàùÂßãÂåñÂõæÂ∫ìÊ®°Âºè‰∏ãÁöÑËΩ¨Âú∫ÊïàÊûúÈÄâÊã©Âô®
    const galleryTransitionEffectsContainer = el('galleryTransitionEffects');
    galleryTransitionEffectsContainer.innerHTML = '';
    
    // ÈªòËÆ§ÈÄâ‰∏≠ÁöÑËΩ¨Âú∫ÊïàÊûú
    const defaultSelected = ['slideleft', 'slideright', 'slideup', 'slidedown'];
    
    availableTransitions.forEach(transition => {
      const wrapper = document.createElement('div');
      wrapper.className = 'transition-checkbox';
      
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.id = `gallery_transition_${transition.value}`;
      checkbox.value = transition.value;
      checkbox.checked = defaultSelected.includes(transition.value);
      
      const label = document.createElement('label');
      label.htmlFor = checkbox.id;
      label.textContent = transition.label;
      
      wrapper.appendChild(checkbox);
      wrapper.appendChild(label);
      galleryTransitionEffectsContainer.appendChild(wrapper);
    });
  }

  function switchMode(mode) {
    currentMode = mode;
    
    // ÈöêËóèÊâÄÊúâÊ®°Âºè
    newTaskMode.style.display = 'none';
    imageOnlyMode.style.display = 'none';
    historyTaskMode.style.display = 'none';
    el('galleryMode').style.display = 'none';
    
    // ÁßªÈô§ÊâÄÊúâÊåâÈíÆÁöÑÊ¥ªË∑ÉÁä∂ÊÄÅ
    el('newTaskBtn').classList.remove('active');
    el('imageOnlyBtn').classList.remove('active');
    el('historyTaskBtn').classList.remove('active');
    el('galleryBtn').classList.remove('active');
    
    if (mode === 'new') {
      newTaskMode.style.display = 'block';
      el('newTaskBtn').classList.add('active');
      startBtn.textContent = 'ÂºÄÂßãÁîüÊàêÂπ∂ÂêàÊàêËßÜÈ¢ë';
      // Ê∏ÖÁ©∫ÂÖ∂‰ªñÊ®°ÂºèÁöÑÊòæÁ§∫ÂÜÖÂÆπ
      gallery.innerHTML = '';
      videoSection.style.display = 'none';
      statsSection.style.display = 'none';
    } else if (mode === 'image-only') {
      imageOnlyMode.style.display = 'block';
      el('imageOnlyBtn').classList.add('active');
      startBtn.textContent = 'ÂºÄÂßãÁîüÊàêÂõæÁâá';
      // Ê∏ÖÁ©∫ÂÖ∂‰ªñÊ®°ÂºèÁöÑÊòæÁ§∫ÂÜÖÂÆπ
      gallery.innerHTML = '';
      imageSelectionArea.style.display = 'none';
      videoSection.style.display = 'none';
      statsSection.style.display = 'none';
    } else if (mode === 'history') {
      historyTaskMode.style.display = 'block';
      el('historyTaskBtn').classList.add('active');
      startBtn.textContent = '‰ªéÂéÜÂè≤‰ªªÂä°ÈáçÊñ∞ÁîüÊàêËßÜÈ¢ë';
      // Ê∏ÖÁ©∫ÂõæÁâáÊòæÁ§∫ÔºåÁ≠âÂæÖÁî®Êà∑ÈÄâÊã©ÂéÜÂè≤‰ªªÂä°
      gallery.innerHTML = '';
      videoSection.style.display = 'none';
      statsSection.style.display = 'none';
      loadHistoryTasks();
    } else if (mode === 'gallery') {
      el('galleryMode').style.display = 'block';
      el('galleryBtn').classList.add('active');
      startBtn.textContent = '‰ªéÂõæÂ∫ìÁîüÊàêËßÜÈ¢ë';
      // Ê∏ÖÁ©∫ÂõæÁâáÊòæÁ§∫ÔºåÁ≠âÂæÖÁî®Êà∑ÈÄâÊã©ÂõæÂ∫ìÂàÜÁªÑ
      gallery.innerHTML = '';
      videoSection.style.display = 'none';
      statsSection.style.display = 'none';
      loadGalleryGroups();
    }
    
    updateButtonText();
  }

  async function loadHistoryTasks() {
    try {
      const response = await fetch(`${API_BASE}/history`);
      const data = await response.json();
      
      historyTasksList.innerHTML = '';
      
      if (data.tasks.length === 0) {
        historyTasksList.innerHTML = '<div style="text-align:center;color:var(--muted);padding:20px">ÊöÇÊó†ÂéÜÂè≤‰ªªÂä°</div>';
        return;
      }
      
      data.tasks.forEach(task => {
        const taskElement = document.createElement('div');
        taskElement.className = 'history-task';
        taskElement.onclick = (e) => {
          // ÈÅøÂÖçÂú®ÁÇπÂáªÂà†Èô§ÊåâÈíÆÊó∂Ëß¶ÂèëÈÄâÊã©
          if (!e.target.closest('.history-task-delete')) {
            selectHistoryTask(task, e);
          }
        };
        
        const createdDate = new Date(task.created_at).toLocaleString();
        const completedDate = task.completed_at ? new Date(task.completed_at).toLocaleString() : 'Êú™ÂÆåÊàê';
        
        taskElement.innerHTML = `
          <div class="history-task-title">
            ‰ªªÂä° ${task.task_id.substr(0, 8)}...
            <button class="history-task-delete" onclick="deleteHistoryTask('${task.task_id}', event)" title="Âà†Èô§‰ªªÂä°">
              √ó
            </button>
          </div>
          <div class="history-task-info">
            ÂàõÂª∫Êó∂Èó¥: ${createdDate}<br>
            ÂÆåÊàêÊó∂Èó¥: ${completedDate}<br>
            ÂõæÁâáÊï∞Èáè: ${task.image_count} Âº†<br>
            ÂàÜËæ®Áéá: ${task.config ? (task.config.width || 720) : 720}x${task.config ? (task.config.height || 1280) : 1280}
          </div>
        `;
        
        historyTasksList.appendChild(taskElement);
      });
      
    } catch (error) {
      toast(`Âä†ËΩΩÂéÜÂè≤‰ªªÂä°Â§±Ë¥•: ${error.message}`, 'err');
    }
  }

  function selectHistoryTask(task, eventParam) {
    selectedHistoryTask = task;
    
    // Êõ¥Êñ∞ÈÄâ‰∏≠Áä∂ÊÄÅ
    document.querySelectorAll('.history-task').forEach(el => el.classList.remove('selected'));
    // ‰ΩøÁî®‰º†ÂÖ•ÁöÑ‰∫ã‰ª∂ÂèÇÊï∞ÊàñÂ∞ùËØïËé∑ÂèñÂΩìÂâç‰∫ã‰ª∂
    const event = eventParam || window.event;
    if (event && event.target) {
      event.target.closest('.history-task').classList.add('selected');
    }
    
    // ÊòæÁ§∫ÈÖçÁΩÆÈù¢Êùø
    historyTaskConfig.style.display = 'block';
    
    // ÊòæÁ§∫ÂéÜÂè≤‰ªªÂä°ÁöÑÂõæÁâá
    if (task.images && task.images.length > 0) {
      gallery.innerHTML = ''; // Ê∏ÖÁ©∫ÂΩìÂâçÊòæÁ§∫ÁöÑÂõæÁâá
      updateGallery(task.images);
      toast(`‚úÖ Â∑≤Âä†ËΩΩ ${task.images.length} Âº†ÂéÜÂè≤ÂõæÁâá`, 'ok');
    }
    
    // ÊòæÁ§∫ÂéÜÂè≤‰ªªÂä°ÁöÑËßÜÈ¢ëÈ¢ÑËßàÔºàÂ¶ÇÊûúÊúâÔºâ
    if (task.video_url) {
      videoOut.src = task.video_url;
      dlVideo.href = task.video_url;
      videoSection.style.display = 'block';
      showStats(task);
      toast(`‚úÖ Â∑≤Âä†ËΩΩÂéÜÂè≤ËßÜÈ¢ëÈ¢ÑËßà`, 'ok');
    } else {
      // Â¶ÇÊûúÊ≤°ÊúâËßÜÈ¢ëÔºåÈöêËóèËßÜÈ¢ëÂå∫Âüü
      videoSection.style.display = 'none';
      statsSection.style.display = 'none';
    }
    
    // Â°´ÂÖÖÈªòËÆ§ÈÖçÁΩÆ
    historyVideoFpsInput.value = task.config.fps || 30;
    historyPerSlideSecondsInput.value = task.config.per_slide_seconds || 3.0;
    historyTransitionSecondsInput.value = task.config.transition_seconds || 0.6;
    historyImageMultiplierInput.value = task.config.image_multiplier || 1;
    historyVideoWidthSelect.value = task.config.width || 720;
    historyVideoHeightSelect.value = task.config.height || 1280;
    
    updateButtonText();
  }

  async function handleHistoryAudioUpload() {
    const file = historyBgmFile.files?.[0];
    if (!file) {
      historyAudioId = null;
      return;
    }

    try {
      toast('üì§ Ê≠£Âú®‰∏ä‰º†Èü≥È¢ë...', 'info');
      
      const formData = new FormData();
      formData.append('file', file);
      formData.append('type', 'audio');

      const response = await fetch(`${API_BASE}/upload`, {
        method: 'POST',
        body: formData
      });

      const result = await response.json();
      
      if (result.success) {
        historyAudioId = result.file_id;
        toast('‚úÖ Èü≥È¢ë‰∏ä‰º†ÊàêÂäü', 'ok');
      } else {
        throw new Error(result.error || '‰∏ä‰º†Â§±Ë¥•');
      }
    } catch (error) {
      toast(`‚ùå Èü≥È¢ë‰∏ä‰º†Â§±Ë¥•: ${error.message}`, 'err');
      console.error('Upload error:', error);
    }
  }

  // ‰ªÖÁîüÊàêÂõæÁâáÊ®°ÂºèÁöÑÊñá‰ª∂‰∏ä‰º†Â§ÑÁêÜ
  async function handleImageOnlyImageUpload() {
    const file = imageInputImage.files?.[0];
    if (!file) return;

    try {
      toast('üì§ Ê≠£Âú®‰∏ä‰º†ÂõæÁâá...', 'info');
      
      const formData = new FormData();
      formData.append('file', file);
      formData.append('type', 'image');

      const response = await fetch(`${API_BASE}/upload`, {
        method: 'POST',
        body: formData
      });

      const result = await response.json();
      
      if (result.success) {
        imageOnlyUploadedImageId = result.file_id;
        imageOrigPreview.src = `${API_BASE}/files/${result.file_id}`;
        imageOrigPreview.style.display = 'block';
        toast('‚úÖ ÂõæÁâá‰∏ä‰º†ÊàêÂäü', 'ok');
      } else {
        throw new Error(result.error || '‰∏ä‰º†Â§±Ë¥•');
      }
    } catch (error) {
      toast(`‚ùå ÂõæÁâá‰∏ä‰º†Â§±Ë¥•: ${error.message}`, 'err');
      console.error('Upload error:', error);
    }
  }

  async function handleComposeAudioUpload() {
    const file = composeBgmFile.files?.[0];
    if (!file) {
      composeAudioId = null;
      return;
    }

    try {
      toast('üì§ Ê≠£Âú®‰∏ä‰º†Èü≥È¢ë...', 'info');
      
      const formData = new FormData();
      formData.append('file', file);
      formData.append('type', 'audio');

      const response = await fetch(`${API_BASE}/upload`, {
        method: 'POST',
        body: formData
      });

      const result = await response.json();
      
      if (result.success) {
        composeAudioId = result.file_id;
        toast('‚úÖ Èü≥È¢ë‰∏ä‰º†ÊàêÂäü', 'ok');
      } else {
        throw new Error(result.error || '‰∏ä‰º†Â§±Ë¥•');
      }
    } catch (error) {
      toast(`‚ùå Èü≥È¢ë‰∏ä‰º†Â§±Ë¥•: ${error.message}`, 'err');
      console.error('Upload error:', error);
    }
  }

  function setupEventListeners() {
    // Êñá‰ª∂‰∏ä‰º†
    inputImage.onchange = handleImageUpload;
    bgmFile.onchange = handleAudioUpload;
    historyBgmFile.onchange = handleHistoryAudioUpload;
    
    // ÂõæÂ∫ìÊñá‰ª∂‰∏ä‰º†
    el('galleryImageUpload').onchange = handleGalleryImageUpload;
    el('galleryBgmFile').onchange = handleGalleryAudioUpload;
    
    // ‰ªÖÁîüÊàêÂõæÁâáÊ®°ÂºèÁöÑÊñá‰ª∂‰∏ä‰º†
    imageInputImage.onchange = handleImageOnlyImageUpload;
    composeBgmFile.onchange = handleComposeAudioUpload;
    
    // ‰ªÖÁîüÊàêÂõæÁâáÊ®°ÂºèÁöÑÊñá‰ª∂‰∏ä‰º†
    imageInputImage.onchange = handleImageOnlyImageUpload;
    composeBgmFile.onchange = handleComposeAudioUpload;
    
    // ÈÖçÁΩÆÂèòÂåñ
    [slideCountInput, videoFpsInput, perSlideSecondsInput, transitionSecondsInput, includeOriginalCheckbox].forEach(input => {
      input.onchange = updateButtonText;
      input.oninput = updateButtonText;
    });

    // ÂéÜÂè≤‰ªªÂä°ÈÖçÁΩÆÂèòÂåñ
    [historyVideoFpsInput, historyPerSlideSecondsInput, historyTransitionSecondsInput, historyImageMultiplierInput].forEach(input => {
      input.onchange = updateButtonText;
      input.oninput = updateButtonText;
    });

    // ‰ªÖÁîüÊàêÂõæÁâáÊ®°ÂºèÈÖçÁΩÆÂèòÂåñ
    [imageSlideCountInput, imageConcurrentLimitInput, composeVideoFpsInput, composePerSlideSecondsInput, composeTransitionSecondsInput].forEach(input => {
      input.onchange = updateButtonText;
      input.oninput = updateButtonText;
    });

    // ËßÜÈ¢ëÂ∞∫ÂØ∏ÂêåÊ≠•
    videoWidthSelect.onchange = () => {
      const width = parseInt(videoWidthSelect.value);
      if (width === 720) videoHeightSelect.value = '1280';  // ÊäñÈü≥Á´ñÂ±è 9:16
      else if (width === 1280) videoHeightSelect.value = '720';
      else if (width === 1920) videoHeightSelect.value = '1080';
      else if (width === 854) videoHeightSelect.value = '480';
      updateButtonText();
    };
    
    videoHeightSelect.onchange = () => {
      const height = parseInt(videoHeightSelect.value);
      if (height === 1280) videoWidthSelect.value = '720';  // ÊäñÈü≥Á´ñÂ±è 9:16
      else if (height === 720) videoWidthSelect.value = '1280';
      else if (height === 1080) videoWidthSelect.value = '1920';
      else if (height === 480) videoWidthSelect.value = '854';
      updateButtonText();
    };

    // ‰ªÖÁîüÊàêÂõæÁâáÊ®°ÂºèËßÜÈ¢ëÂ∞∫ÂØ∏ÂêåÊ≠•
    composeVideoWidthSelect.onchange = () => {
      const width = parseInt(composeVideoWidthSelect.value);
      if (width === 720) composeVideoHeightSelect.value = '1280';
      else if (width === 1280) composeVideoHeightSelect.value = '720';
      else if (width === 1920) composeVideoHeightSelect.value = '1080';
      else if (width === 854) composeVideoHeightSelect.value = '480';
      updateButtonText();
    };

    composeVideoHeightSelect.onchange = updateButtonText;

    // ÂêØÂä®ÊåâÈíÆ‰∫ã‰ª∂
    startBtn.onclick = handleGenerate;
  }

  async function checkConnection() {
    try {
      const response = await fetch(`${API_BASE}/health`);
      if (response.ok) {
        setConnectionStatus('connected', 'ÂêéÁ´ØÂ∑≤ËøûÊé•');
      } else {
        setConnectionStatus('error', 'ÂêéÁ´ØËøûÊé•Â§±Ë¥•');
      }
    } catch (error) {
      setConnectionStatus('error', 'Êó†Ê≥ïËøûÊé•ÂêéÁ´Ø');
      toast('‚ùå Êó†Ê≥ïËøûÊé•Âà∞ÂêéÁ´ØÊúçÂä°ÔºåËØ∑Á°Æ‰øùÂêéÁ´ØÊúçÂä°Â∑≤ÂêØÂä®', 'err');
    }
  }

  function setConnectionStatus(status, text) {
    connectionStatus.className = `status-indicator status-${status}`;
    connectionText.textContent = text;
  }

  async function handleImageUpload() {
    const file = inputImage.files?.[0];
    if (!file) return;

    try {
      toast('üì§ Ê≠£Âú®‰∏ä‰º†ÂõæÁâá...', 'info');
      
      const formData = new FormData();
      formData.append('file', file);
      formData.append('type', 'image');

      const response = await fetch(`${API_BASE}/upload`, {
        method: 'POST',
        body: formData
      });

      const result = await response.json();
      
      if (result.success) {
        uploadedImageId = result.file_id;
        origPreview.src = `${API_BASE}/files/${result.file_id}`;
        origPreview.style.display = 'block';
        dlOrig.href = `${API_BASE}/files/${result.file_id}`;
        dlOrig.download = result.filename;
        toast('‚úÖ ÂõæÁâá‰∏ä‰º†ÊàêÂäü', 'ok');
      } else {
        throw new Error(result.error || '‰∏ä‰º†Â§±Ë¥•');
      }
    } catch (error) {
      toast(`‚ùå ÂõæÁâá‰∏ä‰º†Â§±Ë¥•: ${error.message}`, 'err');
      console.error('Upload error:', error);
    }
  }

  async function handleAudioUpload() {
    const file = bgmFile.files?.[0];
    if (!file) return;

    try {
      toast('üì§ Ê≠£Âú®‰∏ä‰º†Èü≥È¢ë...', 'info');
      
      const formData = new FormData();
      formData.append('file', file);
      formData.append('type', 'audio');

      const response = await fetch(`${API_BASE}/upload`, {
        method: 'POST',
        body: formData
      });

      const result = await response.json();
      
      if (result.success) {
        uploadedAudioId = result.file_id;
        toast('‚úÖ Èü≥È¢ë‰∏ä‰º†ÊàêÂäü', 'ok');
      } else {
        throw new Error(result.error || '‰∏ä‰º†Â§±Ë¥•');
      }
    } catch (error) {
      toast(`‚ùå Èü≥È¢ë‰∏ä‰º†Â§±Ë¥•: ${error.message}`, 'err');
      console.error('Upload error:', error);
    }
  }

  async function handleGalleryAudioUpload() {
    const file = el('galleryBgmFile').files?.[0];
    if (!file) return;

    if (!currentGalleryGroup) {
      toast('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ÂàÜÁªÑ', 'warn');
      return;
    }

    try {
      toast('üì§ Ê≠£Âú®‰∏ä‰º†ËÉåÊôØÈü≥‰πê...', 'info');
      
      const formData = new FormData();
      formData.append('file', file);
      formData.append('type', 'audio');

      const response = await fetch(`${API_BASE}/upload`, {
        method: 'POST',
        body: formData
      });

      const result = await response.json();
      
      if (result.success) {
        galleryAudioId = result.file_id;
        toast('‚úÖ ËÉåÊôØÈü≥‰πê‰∏ä‰º†ÊàêÂäü', 'ok');
      } else {
        throw new Error(result.error || '‰∏ä‰º†Â§±Ë¥•');
      }
    } catch (error) {
      toast(`‚ùå ËÉåÊôØÈü≥‰πê‰∏ä‰º†Â§±Ë¥•: ${error.message}`, 'err');
      console.error('Gallery audio upload error:', error);
    }
  }

  async function handleGenerate() {
    if (startBtn.disabled) return;
    
    if (currentMode === 'new') {
      // Êñ∞‰ªªÂä°Ê®°Âºè
      // È™åËØÅËæìÂÖ•
      if (!apiKeyInput.value.trim()) {
        toast('‚ùå ËØ∑ÂÖàÂ°´ÂÜô OpenRouter API Key', 'err');
        return;
      }

      if (!uploadedImageId) {
        toast('‚ùå ËØ∑ÂÖà‰∏ä‰º†ÂéüÂõæ', 'err');
        return;
      }

      try {
        startBtn.disabled = true;
        taskStatus.style.display = 'block';
        gallery.innerHTML = ''; // Ê∏ÖÁ©∫ÂõæÁâáÂªäÔºå‰∏∫ÂÆûÊó∂ÊòæÁ§∫ÂÅöÂáÜÂ§á
        videoSection.style.display = 'none';
        statsSection.style.display = 'none';
        logBox.innerHTML = '';

        // Ëé∑ÂèñÈÖçÁΩÆ
        const config = getConfig();
        
        // ÂèëÈÄÅÁîüÊàêËØ∑Ê±Ç
        const response = await fetch(`${API_BASE}/generate`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            image_id: uploadedImageId,
            audio_id: uploadedAudioId,
            api_key: apiKeyInput.value.trim(),
            ...config
          })
        });

        const result = await response.json();
        
        if (result.success) {
          currentTaskId = result.task_id;
          toast('üöÄ ËßÜÈ¢ëÁîüÊàê‰ªªÂä°Â∑≤ÂºÄÂßã', 'ok');
          startPolling();
        } else {
          throw new Error(result.error || '‰ªªÂä°ÂàõÂª∫Â§±Ë¥•');
        }
      } catch (error) {
        toast(`‚ùå ÁîüÊàêÂ§±Ë¥•: ${error.message}`, 'err');
        console.error('Generate error:', error);
        resetUI();
      }
    } else if (currentMode === 'image-only') {
      // ‰ªÖÁîüÊàêÂõæÁâáÊ®°Âºè
      if (imageOnlyTaskId && document.querySelector('#imageSelectionArea[style*="display: block"]')) {
        // Â¶ÇÊûúÂõæÁâáÂ∑≤ÁîüÊàêÔºåÂàôÂêàÊàêËßÜÈ¢ë
        handleComposeVideo();
      } else {
        // ÂºÄÂßãÁîüÊàêÂõæÁâá
        handleGenerateImagesOnly();
      }
    } else if (currentMode === 'gallery') {
      // ÂõæÂ∫ìÊ®°Âºè
      if (!currentGalleryGroup) {
        toast('‚ùå ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ÂõæÂ∫ìÂàÜÁªÑ', 'err');
        return;
      }

      // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑÂõæÁâá
      const selectedCheckboxes = el('galleryImagesGrid').querySelectorAll('.gallery-item-checkbox:checked');
      const selectedCount = selectedCheckboxes.length;
      
      if (selectedCount === 0) {
        toast('‚ùå ËØ∑ÂÖàÈÄâÊã©Ë¶Å‰ΩøÁî®ÁöÑÂõæÁâá', 'err');
        return;
      }

      try {
        startBtn.disabled = true;
        taskStatus.style.display = 'block';
        videoSection.style.display = 'none';
        statsSection.style.display = 'none';
        logBox.innerHTML = '';

        // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑÂõæÁâáID
        const imageIds = Array.from(selectedCheckboxes).map(cb => cb.closest('.gallery-item').dataset.imageId);
        
        // Ëé∑ÂèñÂõæÂ∫ìÈÖçÁΩÆ
        const config = getGalleryConfig();
        
        // ÂèëÈÄÅÁîüÊàêËØ∑Ê±Ç
        const response = await fetch(`${API_BASE}/gallery/compose-video`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            selected_image_ids: imageIds,
            audio_id: galleryAudioId,
            ...config
          })
        });

        const result = await response.json();
        
        if (result.success) {
          currentTaskId = result.task_id;
          toast('üöÄ ‰ªéÂõæÂ∫ìÁîüÊàêËßÜÈ¢ë‰ªªÂä°Â∑≤ÂºÄÂßã', 'ok');
          startPolling();
        } else {
          throw new Error(result.error || '‰ªªÂä°ÂàõÂª∫Â§±Ë¥•');
        }
      } catch (error) {
        toast(`‚ùå ÁîüÊàêÂ§±Ë¥•: ${error.message}`, 'err');
        console.error('Generate from gallery error:', error);
        resetUI();
      }
    } else {
      // ÂéÜÂè≤‰ªªÂä°Ê®°Âºè
      if (!selectedHistoryTask) {
        toast('‚ùå ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ÂéÜÂè≤‰ªªÂä°', 'err');
        return;
      }

      try {
        startBtn.disabled = true;
        taskStatus.style.display = 'block';
        // ‰∏çÊ∏ÖÁ©∫ galleryÔºå‰øùÊåÅÂéÜÂè≤ÂõæÁâáÊòæÁ§∫
        // gallery.innerHTML = '';
        videoSection.style.display = 'none';
        statsSection.style.display = 'none';
        logBox.innerHTML = '';

        // ÂéÜÂè≤ÂõæÁâáÂ∑≤ÁªèÂú® selectHistoryTask ‰∏≠ÊòæÁ§∫‰∫ÜÔºå‰∏çÈúÄË¶ÅÈáçÂ§çÊòæÁ§∫
        // if (selectedHistoryTask.images) {
        //   updateGallery(selectedHistoryTask.images);
        // }

        // Ëé∑ÂèñÂéÜÂè≤‰ªªÂä°ÈÖçÁΩÆ
        const config = getHistoryConfig();
        
        // ÂèëÈÄÅÈáçÊñ∞ÁîüÊàêËØ∑Ê±Ç
        const response = await fetch(`${API_BASE}/regenerate`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            task_id: selectedHistoryTask.task_id,
            audio_id: historyAudioId,
            ...config
          })
        });

        const result = await response.json();
        
        if (result.success) {
          currentTaskId = result.task_id;
          toast('üöÄ ËßÜÈ¢ëÈáçÊñ∞ÁîüÊàê‰ªªÂä°Â∑≤ÂºÄÂßã', 'ok');
          startPolling();
        } else {
          throw new Error(result.error || '‰ªªÂä°ÂàõÂª∫Â§±Ë¥•');
        }
      } catch (error) {
        toast(`‚ùå ÈáçÊñ∞ÁîüÊàêÂ§±Ë¥•: ${error.message}`, 'err');
        console.error('Regenerate error:', error);
        resetUI();
      }
    }
  }

  function getConfig() {
    // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑËΩ¨Âú∫ÊïàÊûú
    const selectedTransitions = [];
    const checkboxes = transitionEffectsContainer.querySelectorAll('input[type="checkbox"]:checked');
    checkboxes.forEach(checkbox => {
      selectedTransitions.push(checkbox.value);
    });
    
    return {
      slide_count: parseInt(slideCountInput.value) || 2,
      fps: parseInt(videoFpsInput.value) || 30,
      per_slide_seconds: parseFloat(perSlideSecondsInput.value) || 1.0,
      transition_seconds: parseFloat(transitionSecondsInput.value) || 0.6,
      transition_effects: selectedTransitions,
      width: parseInt(videoWidthSelect.value) || 720,
      height: parseInt(videoHeightSelect.value) || 1280,
      include_original: includeOriginalCheckbox.checked,
      concurrent_limit: parseInt(concurrentLimitInput.value) || 1
    };
  }

  function getGalleryConfig() {
    // Ëé∑ÂèñÂõæÂ∫ìÊ®°Âºè‰∏ãÁöÑÈÖçÁΩÆ
    const selectedTransitions = [];
    const checkboxes = el('galleryTransitionEffects').querySelectorAll('input[type="checkbox"]:checked');
    checkboxes.forEach(checkbox => {
      selectedTransitions.push(checkbox.value);
    });
    
    return {
      fps: parseInt(el('galleryVideoFps').value) || 30,
      per_slide_seconds: parseFloat(el('galleryPerSlideSeconds').value) || 3.0,
      transition_seconds: parseFloat(el('galleryTransitionSeconds').value) || 0.6,
      transition_effects: selectedTransitions,
      width: parseInt(el('galleryVideoWidth').value) || 720,
      height: parseInt(el('galleryVideoHeight').value) || 1280,
      image_multiplier: parseInt(el('galleryImageMultiplier').value) || 1,
      include_original: el('galleryIncludeOriginal').checked
    };
  }

  function getHistoryConfig() {
    // Ëé∑ÂèñÂéÜÂè≤‰ªªÂä°Ê®°Âºè‰∏ãÁöÑÈÖçÁΩÆ
    const selectedTransitions = [];
    const checkboxes = historyTransitionEffectsContainer.querySelectorAll('input[type="checkbox"]:checked');
    checkboxes.forEach(checkbox => {
      selectedTransitions.push(checkbox.value);
    });
    
    return {
      fps: parseInt(historyVideoFpsInput.value) || 30,
      per_slide_seconds: parseFloat(historyPerSlideSecondsInput.value) || 3.0,
      transition_seconds: parseFloat(historyTransitionSecondsInput.value) || 0.6,
      transition_effects: selectedTransitions,
      width: parseInt(historyVideoWidthSelect.value) || 720,
      height: parseInt(historyVideoHeightSelect.value) || 1280,
      image_multiplier: parseInt(historyImageMultiplierInput.value) || 1
    };
  }

  function updateButtonText() {
    if (currentMode === 'new') {
      const config = getConfig();
      const totalSeconds = config.include_original ? 
        (config.slide_count + 1) * config.per_slide_seconds : 
        config.slide_count * config.per_slide_seconds;
      const resolution = `${config.width}x${config.height}`;
      
      startBtn.textContent = `ÂºÄÂßãÁîüÊàêÔºà${config.slide_count}Âº†ÔºâÂπ∂ÂêàÊàê ${totalSeconds.toFixed(1)}ÁßíËßÜÈ¢ë (${resolution})`;
    } else if (currentMode === 'image-only') {
      if (imageSelectionArea.style.display === 'block') {
        // ÂõæÁâáÂ∑≤ÁîüÊàêÔºåÊòæÁ§∫ÂêàÊàêËßÜÈ¢ëÊåâÈíÆ
        const selectedCount = getSelectedImages().length;
        const config = getComposeConfig();
        const totalSeconds = config.include_original ? 
          (selectedCount + 1) * config.per_slide_seconds : 
          selectedCount * config.per_slide_seconds;
        const resolution = `${config.width}x${config.height}`;
        
        startBtn.textContent = `ÂêàÊàêËßÜÈ¢ëÔºà${selectedCount}Âº†Ôºâ${totalSeconds.toFixed(1)}Áßí (${resolution})`;
      } else {
        // Â∞öÊú™ÁîüÊàêÂõæÁâá
        const slideCount = parseInt(imageSlideCountInput.value) || 2;
        startBtn.textContent = `ÂºÄÂßãÁîüÊàê ${slideCount} Âº†È£éÊ†ºÂõæÁâá`;
      }
    } else if (currentMode === 'history') {
      if (selectedHistoryTask) {
        const config = getHistoryConfig();
        const originalImageCount = selectedHistoryTask.images ? selectedHistoryTask.images.length : 0;
        const totalImages = originalImageCount * config.image_multiplier;
        const totalSeconds = totalImages * config.per_slide_seconds;
        const resolution = `${config.width}x${config.height}`;
        
        if (config.image_multiplier > 1) {
          startBtn.textContent = `ÈáçÊñ∞ÁîüÊàêËßÜÈ¢ëÔºà${originalImageCount}Âº†√ó${config.image_multiplier}ÂÄç=${totalImages}Âº†Ôºâ${totalSeconds.toFixed(1)}Áßí (${resolution})`;
        } else {
          startBtn.textContent = `‰ªéÂéÜÂè≤‰ªªÂä°ÈáçÊñ∞ÁîüÊàêËßÜÈ¢ëÔºà${originalImageCount}Âº†Ôºâ${totalSeconds.toFixed(1)}Áßí (${resolution})`;
        }
      } else {
        startBtn.textContent = '‰ªéÂéÜÂè≤‰ªªÂä°ÈáçÊñ∞ÁîüÊàêËßÜÈ¢ë';
      }
    } else if (currentMode === 'gallery') {
      if (currentGalleryGroup) {
        // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑÂõæÁâáÊï∞Èáè
        const selectedCheckboxes = el('galleryImagesGrid').querySelectorAll('.gallery-item-checkbox:checked');
        const selectedCount = selectedCheckboxes.length;
        
        if (selectedCount > 0) {
          const config = getGalleryConfig();
          const totalImages = selectedCount * config.image_multiplier;
          const totalSeconds = totalImages * config.per_slide_seconds;
          const resolution = `${config.width}x${config.height}`;
          
          if (config.image_multiplier > 1) {
            startBtn.textContent = `‰ªéÂõæÂ∫ìÁîüÊàêËßÜÈ¢ëÔºà${selectedCount}Âº†√ó${config.image_multiplier}ÂÄç=${totalImages}Âº†Ôºâ${totalSeconds.toFixed(1)}Áßí (${resolution})`;
          } else {
            startBtn.textContent = `‰ªéÂõæÂ∫ìÁîüÊàêËßÜÈ¢ëÔºà${selectedCount}Âº†Ôºâ${totalSeconds.toFixed(1)}Áßí (${resolution})`;
          }
        } else {
          startBtn.textContent = '‰ªéÂõæÂ∫ìÁîüÊàêËßÜÈ¢ëÔºàËØ∑ÂÖàÈÄâÊã©ÂõæÁâáÔºâ';
        }
      } else {
        startBtn.textContent = '‰ªéÂõæÂ∫ìÁîüÊàêËßÜÈ¢ëÔºàËØ∑ÂÖàÈÄâÊã©ÂàÜÁªÑÔºâ';
      }
    }
  }

  function startPolling() {
    if (pollingInterval) clearInterval(pollingInterval);
    
    pollingInterval = setInterval(async () => {
      if (!currentTaskId) return;
      
      try {
        const response = await fetch(`${API_BASE}/tasks/${currentTaskId}`);
        const task = await response.json();
        
        updateTaskStatus(task);
        
        if (task.status === 'completed' || task.status === 'images_ready') {
          stopPolling();
          handleTaskCompleted(task);
        } else if (task.status === 'error') {
          stopPolling();
          handleTaskError(task);
        }
      } catch (error) {
        console.error('Polling error:', error);
      }
    }, 1000); // ÊØè1ÁßíËΩÆËØ¢‰∏ÄÊ¨°ÔºåÊõ¥ÂèäÊó∂Âú∞ÊòæÁ§∫Êñ∞ÁîüÊàêÁöÑÂõæÁâá
  }

  function stopPolling() {
    if (pollingInterval) {
      clearInterval(pollingInterval);
      pollingInterval = null;
    }
  }

  function updateTaskStatus(task) {
    taskMessage.textContent = task.message || 'Â§ÑÁêÜ‰∏≠...';
    taskProgress.textContent = `${Math.round(task.progress || 0)}%`;
    prog.value = task.progress || 0;
    
    // ÊòæÁ§∫ÁîüÊàêÁöÑÂõæÁâá
    if (task.images && task.images.length > 0) {
      updateGallery(task.images);
      
      // Â¶ÇÊûúÊòØ‰ªÖÁîüÊàêÂõæÁâáÊ®°Âºè‰∏îÁä∂ÊÄÅ‰∏∫ images_readyÔºåÊòæÁ§∫ÈÄâÊã©ÁïåÈù¢
      if (currentMode === 'image-only' && task.status === 'images_ready') {
        updateImageSelectionArea(task.images);
        imageSelectionArea.style.display = 'block';
        startBtn.textContent = 'ÂêàÊàêËßÜÈ¢ë';
        startBtn.disabled = false;
      }
    }
  }

  function updateImageSelectionArea(images) {
    imageGallerySelection.innerHTML = '';
    
    images.forEach((img, index) => {
      if (img) {
        const wrap = document.createElement('div');
        wrap.className = 'thumb';
        wrap.style.position = 'relative';
        
        const imgEl = document.createElement('img');
        imgEl.src = `${API_BASE}/files/${img.file_id}`;
        imgEl.alt = img.style;
        imgEl.loading = 'lazy';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = img.file_id;
        checkbox.checked = img.selected !== false; // ÈªòËÆ§ÈÄâ‰∏≠
        checkbox.style.position = 'absolute';
        checkbox.style.top = '8px';
        checkbox.style.left = '8px';
        checkbox.style.width = 'auto';
        checkbox.style.zIndex = '10';
        
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = '√ó';
        deleteBtn.style.position = 'absolute';
        deleteBtn.style.top = '8px';
        deleteBtn.style.right = '8px';
        deleteBtn.style.width = '24px';
        deleteBtn.style.height = '24px';
        deleteBtn.style.padding = '0';
        deleteBtn.style.fontSize = '16px';
        deleteBtn.style.fontWeight = 'bold';
        deleteBtn.style.color = 'white';
        deleteBtn.style.backgroundColor = 'rgba(239, 68, 68, 0.8)';
        deleteBtn.style.border = 'none';
        deleteBtn.style.borderRadius = '50%';
        deleteBtn.style.cursor = 'pointer';
        deleteBtn.style.zIndex = '10';
        deleteBtn.onclick = () => deleteSelectedImage(img.file_id);
        
        const info = document.createElement('div');
        info.className = 'info';
        // Á°ÆÂÆöË¶ÅÊòæÁ§∫ÁöÑÊñáÊú¨ÔºöÂ¶ÇÊûúÊúâstyleÂ∞±ÊòæÁ§∫styleÔºåÂ¶ÇÊûúÊ≤°ÊúâÂ∞±ÊòæÁ§∫filename
        const displayText = img.style ? img.style : (img.filename || 'Êó†È£éÊ†º');
        // Â¶ÇÊûúÊñáÊú¨ËøáÈïøÔºåÊ∑ªÂä†titleÂ±ûÊÄß‰ª•‰æøÊÇ¨ÂÅúÊó∂ÊòæÁ§∫ÂÆåÊï¥ÊñáÊú¨
        const titleAttr = displayText.length > 20 ? ` title="${displayText}"` : '';
        info.innerHTML = `
          <div${titleAttr} style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${displayText}</div>
          <a href="${API_BASE}/files/${img.file_id}" download="style_${img.index}.png" style="color:var(--accent)">‰∏ãËΩΩ</a>
        `;
        
        wrap.appendChild(imgEl);
        wrap.appendChild(checkbox);
        wrap.appendChild(deleteBtn);
        wrap.appendChild(info);
        imageGallerySelection.appendChild(wrap);
      }
    });
  }

  function updateGallery(images) {
    // Ëé∑ÂèñÂΩìÂâçÂ∑≤Â±ïÁ§∫ÁöÑÂõæÁâáÊï∞Èáè
    const currentImageCount = gallery.children.length;
    
    // Âè™Ê∑ªÂä†Êñ∞ÁöÑÂõæÁâáÔºåÈÅøÂÖçÈáçÂ§çÊ∏≤Êüì
    for (let i = currentImageCount; i < images.length; i++) {
      const img = images[i];
      if (img) {
        const wrap = document.createElement('div');
        wrap.className = 'thumb';
        wrap.style.position = 'relative'; // ËÆæÁΩÆÁõ∏ÂØπÂÆö‰Ωç‰ª•‰æøÊ∑ªÂä†Âà†Èô§ÊåâÈíÆ
        
        const imgEl = document.createElement('img');
        imgEl.src = `${API_BASE}/files/${img.file_id}`;
        imgEl.alt = img.style;
        imgEl.loading = 'lazy';
        
        // Ê∑ªÂä†Âä†ËΩΩÂä®ÁîªÊïàÊûú
        imgEl.style.opacity = '0';
        imgEl.style.transition = 'opacity 0.3s ease-in-out';
        imgEl.onload = () => {
          imgEl.style.opacity = '1';
        };
        
        // Ê∑ªÂä†Âà†Èô§ÊåâÈíÆ
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = '√ó';
        deleteBtn.style.position = 'absolute';
        deleteBtn.style.top = '8px';
        deleteBtn.style.right = '8px';
        deleteBtn.style.width = '24px';
        deleteBtn.style.height = '24px';
        deleteBtn.style.padding = '0';
        deleteBtn.style.fontSize = '16px';
        deleteBtn.style.fontWeight = 'bold';
        deleteBtn.style.color = 'white';
        deleteBtn.style.backgroundColor = 'rgba(239, 68, 68, 0.8)';
        deleteBtn.style.border = 'none';
        deleteBtn.style.borderRadius = '50%';
        deleteBtn.style.cursor = 'pointer';
        deleteBtn.style.zIndex = '10';
        deleteBtn.style.opacity = '0.8';
        deleteBtn.style.transition = 'opacity 0.2s';
        deleteBtn.title = 'Âà†Èô§ËøôÂº†ÂõæÁâá';
        
        // Èº†Ê†áÊÇ¨ÂÅúÊïàÊûú
        deleteBtn.onmouseover = () => deleteBtn.style.opacity = '1';
        deleteBtn.onmouseout = () => deleteBtn.style.opacity = '0.8';
        
        // Âà†Èô§‰∫ã‰ª∂
        deleteBtn.onclick = (e) => {
          e.stopPropagation(); // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°
          deleteGalleryImage(img.file_id, wrap);
        };
        
        const info = document.createElement('div');
        info.className = 'info';
        // Á°ÆÂÆöË¶ÅÊòæÁ§∫ÁöÑÊñáÊú¨ÔºöÂ¶ÇÊûúÊúâstyleÂ∞±ÊòæÁ§∫styleÔºåÂ¶ÇÊûúÊ≤°ÊúâÂ∞±ÊòæÁ§∫filename
        const displayText = img.style ? img.style : (img.filename || 'Êó†È£éÊ†º');
        // Â¶ÇÊûúÊñáÊú¨ËøáÈïøÔºåÊ∑ªÂä†titleÂ±ûÊÄß‰ª•‰æøÊÇ¨ÂÅúÊó∂ÊòæÁ§∫ÂÆåÊï¥ÊñáÊú¨
        const titleAttr = displayText.length > 20 ? ` title="${displayText}"` : '';
        info.innerHTML = `
          <div${titleAttr} style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${displayText}</div>
          <a href="${API_BASE}/files/${img.file_id}" download="style_${img.index}.png" style="color:var(--accent)">‰∏ãËΩΩ</a>
        `;
        
        wrap.appendChild(imgEl);
        wrap.appendChild(deleteBtn);
        wrap.appendChild(info);
        gallery.appendChild(wrap);
        
        // Ê∑ªÂä†ÂÖ•Âú∫Âä®Áîª
        wrap.style.opacity = '0';
        wrap.style.transform = 'scale(0.9)';
        wrap.style.transition = 'all 0.3s ease-in-out';
        
        // Âª∂ËøüÊâßË°åÂä®Áîª
        setTimeout(() => {
          wrap.style.opacity = '1';
          wrap.style.transform = 'scale(1)';
        }, 50);
        
        // ÊòæÁ§∫Êñ∞ÂõæÁâáÁîüÊàêÁöÑÊèêÁ§∫
        toast(`‚ú® Êñ∞È£éÊ†ºÂõæÁâáÁîüÊàê: ${img.style}`, 'ok');
      }
    }
  }

  function handleTaskCompleted(task) {
    if (task.status === 'images_ready') {
      // ÂõæÁâáÁîüÊàêÂÆåÊàêÔºåÁ≠âÂæÖÁî®Êà∑ÈÄâÊã©
      toast('‚úÖ ÂõæÁâáÁîüÊàêÂÆåÊàêÔºÅËØ∑ÈÄâÊã©Ë¶ÅÂåÖÂê´ÁöÑÂõæÁâáÂêéÁÇπÂáª‚ÄúÂêàÊàêËßÜÈ¢ë‚Äù', 'ok');
      return; // ‰∏çÈáçÁΩÆUIÔºåÁ≠âÂæÖÁî®Êà∑Êìç‰Ωú
    }
    
    toast('‚úÖ ËßÜÈ¢ëÁîüÊàêÂÆåÊàêÔºÅ', 'ok');
    
    // ÊòæÁ§∫ËßÜÈ¢ë
    if (task.video_url) {
      videoOut.src = task.video_url;
      dlVideo.href = task.video_url;
      videoSection.style.display = 'block';
    }
    
    // ÊòæÁ§∫ÁªüËÆ°‰ø°ÊÅØ
    showStats(task);
    
    resetUI();
  }

  function handleTaskError(task) {
    let errorMessage = task.error || 'Êú™Áü•ÈîôËØØ';
    
    // ÂØπ‰∏çÂêåÁ±ªÂûãÁöÑÈîôËØØÊèê‰æõÊõ¥Â•ΩÁöÑÊèêÁ§∫
    if (errorMessage.includes('ÈÄüÁéáÈôêÂà∂')) {
      toast(`‚ö†Ô∏è APIË∞ÉÁî®Ëøá‰∫éÈ¢ëÁπÅÔºåËØ∑Á®çÂêéÂÜçËØïÊàñÂáèÂ∞ëÂπ∂ÂèëÊï∞Èáè`, 'warn');
      errorMessage = 'APIÈÄüÁéáÈôêÂà∂ÔºåËØ∑Á®çÂêéÂÜçËØïÊàñÂú®È´òÁ∫ßÈÖçÁΩÆ‰∏≠ÂáèÂ∞ë‚ÄúÂπ∂ÂèëËØ∑Ê±ÇÊï∞‚Äù';
    } else if (errorMessage.includes('ÂõæÁâáÁîüÊàêÂÆåÊàêÔºåÊàêÂäü: 0')) {
      toast(`‚ö†Ô∏è ÊâÄÊúâÂõæÁâáÁîüÊàêÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•API KeyÊàñÁ®çÂêéÂÜçËØï`, 'warn');
      errorMessage = 'ÊâÄÊúâÂõæÁâáÁîüÊàêÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•OpenRouter API KeyÊòØÂê¶ÊúâÊïà';
    }
    
    toast(`‚ùå ÁîüÊàêÂ§±Ë¥•: ${errorMessage}`, 'err');
    resetUI();
  }

  function showStats(task) {
    const stats = el('stats');
    const config = task.config || {};
    const imageCount = task.images ? task.images.length : 0;
    
    stats.innerHTML = `
      ÊàêÂäüÁîüÊàê: ${imageCount}/${config.slide_count || 0} Âº†ÂõæÁâá<br>
      ËßÜÈ¢ëÂàÜËæ®Áéá: ${config.width || 0}√ó${config.height || 0}<br>
      ËßÜÈ¢ëÂ∏ßÁéá: ${config.fps || 0} FPS<br>
      ÂÆåÊàêÊó∂Èó¥: ${new Date(task.completed_at).toLocaleString()}
    `;
    
    statsSection.style.display = 'block';
  }

  function resetUI() {
    startBtn.disabled = false;
    currentTaskId = null;
  }

  function toast(msg, type) {
    const line = document.createElement('div');
    line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
    if (type === 'ok') line.classList.add('ok');
    else if (type === 'warn') line.classList.add('warn');
    else if (type === 'err') line.classList.add('err');
    
    logBox.appendChild(line);
    logBox.scrollTop = logBox.scrollHeight;
  }

  // È°µÈù¢Âç∏ËΩΩÊó∂Ê∏ÖÁêÜ
  window.addEventListener('beforeunload', () => {
    stopPolling();
  });

  // ËΩ¨Âú∫ÊïàÊûúÈÄâÊã©Âø´Êç∑ÂáΩÊï∞
  function selectAllTransitions() {
    const checkboxes = transitionEffectsContainer.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      checkbox.checked = true;
    });
    updateButtonText();
  }

  function selectNoneTransitions() {
    const checkboxes = transitionEffectsContainer.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      checkbox.checked = false;
    });
    updateButtonText();
  }

  function selectSlideTransitions() {
    const checkboxes = transitionEffectsContainer.querySelectorAll('input[type="checkbox"]');
    const slideEffects = ['slideleft', 'slideright', 'slideup', 'slidedown'];
    checkboxes.forEach(checkbox => {
      checkbox.checked = slideEffects.includes(checkbox.value);
    });
    updateButtonText();
  }

  function selectFadeTransitions() {
    const checkboxes = transitionEffectsContainer.querySelectorAll('input[type="checkbox"]');
    const fadeEffects = ['fadeblack', 'fadewhite', 'dissolve', 'fadefast', 'fadeslow', 'fadegrays'];
    checkboxes.forEach(checkbox => {
      checkbox.checked = fadeEffects.includes(checkbox.value);
    });
    updateButtonText();
  }

  // Â∞ÜÂáΩÊï∞Ê∑ªÂä†Âà∞ÂÖ®Â±Ä‰ΩúÁî®ÂüüÔºå‰ª•‰æø onclick ÂèØ‰ª•ËÆøÈóÆ
  window.selectAllTransitions = selectAllTransitions;
  window.selectNoneTransitions = selectNoneTransitions;
  window.selectSlideTransitions = selectSlideTransitions;
  window.selectFadeTransitions = selectFadeTransitions;
  window.switchMode = switchMode;
  window.loadHistoryTasks = loadHistoryTasks;

  // ‰ªÖÁîüÊàêÂõæÁâáÊ®°ÂºèÁöÑÁõ∏ÂÖ≥ÂáΩÊï∞
  async function handleGenerateImagesOnly() {
    // È™åËØÅËæìÂÖ•
    if (!imageApiKeyInput.value.trim()) {
      toast('‚ùå ËØ∑ÂÖàÂ°´ÂÜô OpenRouter API Key', 'err');
      return;
    }

    if (!imageOnlyUploadedImageId) {
      toast('‚ùå ËØ∑ÂÖà‰∏ä‰º†ÂéüÂõæ', 'err');
      return;
    }

    try {
      startBtn.disabled = true;
      taskStatus.style.display = 'block';
      gallery.innerHTML = '';
      imageGallerySelection.innerHTML = '';
      imageSelectionArea.style.display = 'none';
      videoSection.style.display = 'none';
      statsSection.style.display = 'none';
      logBox.innerHTML = '';

      // Ëé∑ÂèñÈÖçÁΩÆ
      const config = {
        slide_count: parseInt(imageSlideCountInput.value) || 2,
        concurrent_limit: parseInt(imageConcurrentLimitInput.value) || 1
      };
      
      // ÂèëÈÄÅÁîüÊàêÂõæÁâáËØ∑Ê±Ç
      const response = await fetch(`${API_BASE}/generate-images`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          image_id: imageOnlyUploadedImageId,
          api_key: imageApiKeyInput.value.trim(),
          ...config
        })
      });

      const result = await response.json();
      
      if (result.success) {
        imageOnlyTaskId = result.task_id;
        currentTaskId = result.task_id;
        toast('üöÄ ÂõæÁâáÁîüÊàê‰ªªÂä°Â∑≤ÂºÄÂßã', 'ok');
        startPolling();
      } else {
        throw new Error(result.error || '‰ªªÂä°ÂàõÂª∫Â§±Ë¥•');
      }
    } catch (error) {
      toast(`‚ùå ÁîüÊàêÂ§±Ë¥•: ${error.message}`, 'err');
      console.error('Generate error:', error);
      resetUI();
    }
  }

  async function handleComposeVideo() {
    // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑÂõæÁâá
    const selectedImages = getSelectedImages();
    
    if (selectedImages.length === 0) {
      toast('‚ùå ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏ÄÂº†ÂõæÁâá', 'err');
      return;
    }

    try {
      startBtn.disabled = true;
      taskStatus.style.display = 'block';
      videoSection.style.display = 'none';
      statsSection.style.display = 'none';
      logBox.innerHTML = '';

      // Ëé∑ÂèñÈÖçÁΩÆ
      const config = getComposeConfig();
      
      // ÂèëÈÄÅÂêàÊàêËßÜÈ¢ëËØ∑Ê±Ç
      const response = await fetch(`${API_BASE}/compose-video`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          task_id: imageOnlyTaskId,
          selected_image_ids: selectedImages,
          audio_id: composeAudioId,
          ...config
        })
      });

      const result = await response.json();
      
      if (result.success) {
        currentTaskId = result.task_id;
        toast('üöÄ ËßÜÈ¢ëÂêàÊàê‰ªªÂä°Â∑≤ÂºÄÂßã', 'ok');
        startPolling();
      } else {
        throw new Error(result.error || '‰ªªÂä°ÂàõÂª∫Â§±Ë¥•');
      }
    } catch (error) {
      toast(`‚ùå ÂêàÊàêÂ§±Ë¥•: ${error.message}`, 'err');
      console.error('Compose error:', error);
      resetUI();
    }
  }

  function getSelectedImages() {
    const selectedImages = [];
    const checkboxes = imageGallerySelection.querySelectorAll('input[type="checkbox"]:checked');
    checkboxes.forEach(checkbox => {
      selectedImages.push(checkbox.value);
    });
    return selectedImages;
  }

  function getComposeConfig() {
    // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑËΩ¨Âú∫ÊïàÊûú
    const selectedTransitions = [];
    const checkboxes = composeTransitionEffectsContainer.querySelectorAll('input[type="checkbox"]:checked');
    checkboxes.forEach(checkbox => {
      selectedTransitions.push(checkbox.value);
    });
    
    return {
      fps: parseInt(composeVideoFpsInput.value) || 30,
      per_slide_seconds: parseFloat(composePerSlideSecondsInput.value) || 3.0,
      transition_seconds: parseFloat(composeTransitionSecondsInput.value) || 0.6,
      transition_effects: selectedTransitions,
      width: parseInt(composeVideoWidthSelect.value) || 720,
      height: parseInt(composeVideoHeightSelect.value) || 1280,
      include_original: composeIncludeOriginalCheckbox.checked
    };
  }

  function selectAllImages() {
    const checkboxes = imageGallerySelection.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      checkbox.checked = true;
    });
  }

  function selectNoneImages() {
    const checkboxes = imageGallerySelection.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      checkbox.checked = false;
    });
  }

  async function deleteSelectedImage(imageId) {
    showCustomModal('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÂº†ÂõæÁâáÂêóÔºü', async (confirmed) => {
      if (!confirmed) {
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/images/${imageId}`, {
          method: 'DELETE'
        });

        const result = await response.json();
        
        if (result.success) {
          // ‰ªéÁïåÈù¢‰∏≠ÁßªÈô§ÂõæÁâá
          const imageElement = document.querySelector(`input[value="${imageId}"]`).closest('.thumb');
          if (imageElement) {
            imageElement.remove();
          }
          toast('‚úÖ ÂõæÁâáÂà†Èô§ÊàêÂäü', 'ok');
        } else {
          throw new Error(result.error || 'Âà†Èô§Â§±Ë¥•');
        }
      } catch (error) {
        toast(`‚ùå Âà†Èô§ÂõæÁâáÂ§±Ë¥•: ${error.message}`, 'err');
        console.error('Delete error:', error);
      }
    });
  }

  async function deleteGalleryImage(imageId, imageElement) {
    showCustomModal('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÂº†ÂõæÁâáÂêóÔºüÂà†Èô§ÂêéÂ∞ÜÊó†Ê≥ïÊÅ¢Â§ç„ÄÇ', async (confirmed) => {
      if (!confirmed) {
        return;
      }

      try {
        // Ê∑ªÂä†Âà†Èô§Âä®Áîª
        imageElement.style.transition = 'all 0.3s ease-in-out';
        imageElement.style.opacity = '0.5';
        imageElement.style.transform = 'scale(0.9)';
        
        const response = await fetch(`${API_BASE}/images/${imageId}`, {
          method: 'DELETE'
        });

        const result = await response.json();
        
        if (result.success) {
          // Ê∑ªÂä†ÈÄÄÂú∫Âä®ÁîªÂêéÁßªÈô§ÂÖÉÁ¥†
          imageElement.style.opacity = '0';
          imageElement.style.transform = 'scale(0.8)';
          
          setTimeout(() => {
            if (imageElement.parentNode) {
              imageElement.remove();
            }
          }, 300);
          
          toast('‚úÖ ÂõæÁâáÂà†Èô§ÊàêÂäü', 'ok');
        } else {
          // ÊÅ¢Â§çÂéüÁä∂
          imageElement.style.opacity = '1';
          imageElement.style.transform = 'scale(1)';
          throw new Error(result.error || 'Âà†Èô§Â§±Ë¥•');
        }
      } catch (error) {
        // ÊÅ¢Â§çÂéüÁä∂
        imageElement.style.opacity = '1';
        imageElement.style.transform = 'scale(1)';
        toast(`‚ùå Âà†Èô§ÂõæÁâáÂ§±Ë¥•: ${error.message}`, 'err');
        console.error('Delete error:', error);
      }
    });
  }

  // ‰ªÖÁîüÊàêÂõæÁâáÊ®°ÂºèËΩ¨Âú∫ÊïàÊûúÈÄâÊã©ÂáΩÊï∞
  function selectAllComposeTransitions() {
    const checkboxes = composeTransitionEffectsContainer.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      checkbox.checked = true;
    });
  }

  function selectNoneComposeTransitions() {
    const checkboxes = composeTransitionEffectsContainer.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      checkbox.checked = false;
    });
  }

  function selectSlideComposeTransitions() {
    const checkboxes = composeTransitionEffectsContainer.querySelectorAll('input[type="checkbox"]');
    const slideEffects = ['slideleft', 'slideright', 'slideup', 'slidedown'];
    checkboxes.forEach(checkbox => {
      checkbox.checked = slideEffects.includes(checkbox.value);
    });
  }

  function selectFadeComposeTransitions() {
    const checkboxes = composeTransitionEffectsContainer.querySelectorAll('input[type="checkbox"]');
    const fadeEffects = ['fadeblack', 'fadewhite', 'dissolve', 'fadefast', 'fadeslow', 'fadegrays'];
    checkboxes.forEach(checkbox => {
      checkbox.checked = fadeEffects.includes(checkbox.value);
    });
  }

  // Âà†Èô§ÂéÜÂè≤‰ªªÂä°ÂäüËÉΩ
  async function deleteHistoryTask(taskId, event) {
    event.stopPropagation(); // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°
    
    // ÊòæÁ§∫Ëá™ÂÆö‰πâÁ°ÆËÆ§ÂØπËØùÊ°Ü
    const confirmed = await showCustomConfirm(
      'Âà†Èô§ÂéÜÂè≤‰ªªÂä°',
      `Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ÂéÜÂè≤‰ªªÂä°ÂêóÔºü\n\nËøôÂ∞ÜÂà†Èô§Ôºö\n‚Ä¢ ‰ªªÂä°ËÆ∞ÂΩï\n‚Ä¢ Áõ∏ÂÖ≥ÁöÑÊâÄÊúâÂõæÁâáÊñá‰ª∂\n‚Ä¢ Áõ∏ÂÖ≥ÁöÑËßÜÈ¢ëÊñá‰ª∂\n\nÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ`,
      'Âà†Èô§',
      'ÂèñÊ∂à'
    );
    
    if (!confirmed) {
      return;
    }
    
    try {
      // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
      toast('üóëÔ∏è Ê≠£Âú®Âà†Èô§ÂéÜÂè≤‰ªªÂä°...', 'info');
      
      const response = await fetch(`${API_BASE}/history/${taskId}`, {
        method: 'DELETE'
      });
      
      const result = await response.json();
      
      if (result.success) {
        toast(`‚úÖ ÂéÜÂè≤‰ªªÂä°Âà†Èô§ÊàêÂäüÔºåÂÖ±Âà†Èô§ ${result.deleted_files.length} ‰∏™Êñá‰ª∂`, 'ok');
        
        // Â¶ÇÊûúÂà†Èô§ÁöÑÊòØÂΩìÂâçÈÄâ‰∏≠ÁöÑ‰ªªÂä°ÔºåÊ∏ÖÁ©∫ÈÄâ‰∏≠Áä∂ÊÄÅ
        if (selectedHistoryTask && selectedHistoryTask.task_id === taskId) {
          selectedHistoryTask = null;
          gallery.innerHTML = '';
          videoSection.style.display = 'none';
          statsSection.style.display = 'none';
          historyTaskConfig.style.display = 'none';
        }
        
        // ÈáçÊñ∞Âä†ËΩΩÂéÜÂè≤‰ªªÂä°ÂàóË°®
        await loadHistoryTasks();
        
      } else {
        throw new Error(result.error || 'Âà†Èô§Â§±Ë¥•');
      }
      
    } catch (error) {
      console.error('Delete history task error:', error);
      toast(`‚ùå Âà†Èô§Â§±Ë¥•: ${error.message}`, 'err');
    }
  }

  // Â∞ÜÂà†Èô§ÂáΩÊï∞Ê∑ªÂä†Âà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü
  window.deleteHistoryTask = deleteHistoryTask;

  // Â∞ÜÊñ∞ÂáΩÊï∞Ê∑ªÂä†Âà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü
  window.selectAllImages = selectAllImages;
  window.selectNoneImages = selectNoneImages;
  window.deleteSelectedImage = deleteSelectedImage;
  window.deleteGalleryImage = deleteGalleryImage;
  window.selectAllComposeTransitions = selectAllComposeTransitions;
  window.selectNoneComposeTransitions = selectNoneComposeTransitions;
  window.selectSlideComposeTransitions = selectSlideComposeTransitions;
  window.selectFadeComposeTransitions = selectFadeComposeTransitions;



  // ÊòæÁ§∫Ëá™ÂÆö‰πâÁ°ÆËÆ§ÂØπËØùÊ°ÜÔºàËøîÂõûPromiseÔºâ
  function showCustomConfirm(title, message, confirmText = 'Á°ÆËÆ§', cancelText = 'ÂèñÊ∂à') {
    return new Promise((resolve) => {
      const modal = document.getElementById('customModal');
      const titleEl = modal.querySelector('.modal-title');
      const messageEl = modal.querySelector('.modal-message');
      const confirmBtn = modal.querySelector('.modal-btn-confirm');
      const cancelBtn = modal.querySelector('.modal-btn-cancel');
      
      // ËÆæÁΩÆÂÜÖÂÆπ
      titleEl.textContent = title;
      messageEl.textContent = message;
      confirmBtn.textContent = confirmText;
      cancelBtn.textContent = cancelText;
      
      // ÈáçÁΩÆÁÇπÂáª‰∫ã‰ª∂ÔºàÈÅøÂÖç‰πãÂâçÁöÑ‰∫ã‰ª∂Âπ≤Êâ∞Ôºâ
      confirmBtn.onclick = () => {
        hideCustomModal();
        resolve(true);
      };
      
      cancelBtn.onclick = () => {
        hideCustomModal();
        resolve(false);
      };
      
      // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
      modal.classList.add('show');
      
      // ESCÈîÆÊîØÊåÅ
      const handleEscape = (event) => {
        if (event.key === 'Escape') {
          document.removeEventListener('keydown', handleEscape);
          hideCustomModal();
          resolve(false);
        }
      };
      
      document.addEventListener('keydown', handleEscape);
      
      // ÁÇπÂáªÂ§ñÈÉ®Âå∫ÂüüÂÖ≥Èó≠
      const handleOutsideClick = (event) => {
        if (event.target === modal) {
          document.removeEventListener('click', handleOutsideClick);
          hideCustomModal();
          resolve(false);
        }
      };
      
      setTimeout(() => {
        document.addEventListener('click', handleOutsideClick);
      }, 100); // Âª∂ËøüÊ∑ªÂä†ÔºåÈÅøÂÖçÁ´ãÂç≥Ëß¶Âèë
    });
  }

  // ÊòæÁ§∫Ëá™ÂÆö‰πâÊ®°ÊÄÅÂØπËØùÊ°Ü
  function showCustomModal(message, callback) {
    const modal = document.getElementById('customModal');
    const messageEl = modal.querySelector('.modal-message');
    
    messageEl.textContent = message;
    modalCallback = callback;
    
    modal.classList.add('show');
    
    // ÁõëÂê¨ ESC ÈîÆÂÖ≥Èó≠ÂØπËØùÊ°Ü
    document.addEventListener('keydown', handleModalEscape);
  }

  // ÈöêËóèËá™ÂÆö‰πâÊ®°ÊÄÅÂØπËØùÊ°Ü
  function hideCustomModal(confirmed) {
    const modal = document.getElementById('customModal');
    modal.classList.remove('show');
    
    // ÁßªÈô§ ESC ÈîÆÁõëÂê¨
    document.removeEventListener('keydown', handleModalEscape);
    
    // ÊâßË°åÂõûË∞É
    if (modalCallback) {
      modalCallback(confirmed);
      modalCallback = null;
    }
  }

  // Â§ÑÁêÜ ESC ÈîÆÊåâ‰∏ã
  function handleModalEscape(event) {
    if (event.key === 'Escape') {
      hideCustomModal(false);
    }
  }

  // ÊòæÁ§∫Â∏¶ËæìÂÖ•Ê°ÜÁöÑËá™ÂÆö‰πâÊ®°ÊÄÅÂØπËØùÊ°Ü
  function showCustomModalWithInput(title, message, defaultValue, callback) {
    // ÂàõÂª∫Ê®°ÊÄÅÂØπËØùÊ°ÜÂÖÉÁ¥†
    const modal = document.createElement('div');
    modal.className = 'custom-modal';
    modal.innerHTML = `
      <div class="modal-content">
        <div class="modal-icon">üìÅ</div>
        <div class="modal-title">${title}</div>
        <div class="modal-message">${message}</div>
        <input type="text" id="customModalInput" class="modal-input" value="${defaultValue}" />
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-cancel" id="modalCancelBtn">ÂèñÊ∂à</button>
          <button class="modal-btn modal-btn-confirm" id="modalConfirmBtn">Á°ÆËÆ§</button>
        </div>
      </div>
    `;
    
    // Ê∑ªÂä†Âà∞È°µÈù¢
    document.body.appendChild(modal);
    
    // Ëé∑ÂèñÂÖÉÁ¥†
    const input = modal.querySelector('#customModalInput');
    const cancelBtn = modal.querySelector('#modalCancelBtn');
    const confirmBtn = modal.querySelector('#modalConfirmBtn');
    
    // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
    modal.classList.add('show');
    
    // ËÅöÁÑ¶Âà∞ËæìÂÖ•Ê°Ü
    setTimeout(() => {
      input.focus();
      input.select();
    }, 100);
    
    // Á°ÆËÆ§ÊåâÈíÆ‰∫ã‰ª∂
    confirmBtn.onclick = () => {
      const value = input.value.trim();
      hideCustomModalWithInput(modal);
      if (callback) callback(value);
    };
    
    // ÂèñÊ∂àÊåâÈíÆ‰∫ã‰ª∂
    cancelBtn.onclick = () => {
      hideCustomModalWithInput(modal);
    };
    
    // ÂõûËΩ¶ÈîÆÁ°ÆËÆ§
    input.onkeypress = (e) => {
      if (e.key === 'Enter') {
        confirmBtn.click();
      }
    };
    
    // ESCÈîÆÂÖ≥Èó≠
    const handleEscape = (event) => {
      if (event.key === 'Escape') {
        document.removeEventListener('keydown', handleEscape);
        hideCustomModalWithInput(modal);
      }
    };
    
    document.addEventListener('keydown', handleEscape);
    
    // ÁÇπÂáªÂ§ñÈÉ®Âå∫ÂüüÂÖ≥Èó≠
    const handleOutsideClick = (event) => {
      if (event.target === modal) {
        document.removeEventListener('click', handleOutsideClick);
        hideCustomModalWithInput(modal);
      }
    };
    
    setTimeout(() => {
      document.addEventListener('click', handleOutsideClick);
    }, 100);
  }

  // ÈöêËóèÂ∏¶ËæìÂÖ•Ê°ÜÁöÑËá™ÂÆö‰πâÊ®°ÊÄÅÂØπËØùÊ°Ü
  function hideCustomModalWithInput(modal) {
    modal.classList.remove('show');
    setTimeout(() => {
      if (modal.parentNode) {
        modal.parentNode.removeChild(modal);
      }
    }, 300);
  }

  // Â∞ÜÂáΩÊï∞Ê∑ªÂä†Âà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü
  window.showCustomModal = showCustomModal;
  window.showCustomConfirm = showCustomConfirm;
  window.hideCustomModal = hideCustomModal;
  window.showCustomModalWithInput = showCustomModalWithInput;

  // ÂéÜÂè≤‰ªªÂä°ËΩ¨Âú∫ÊïàÊûúÈÄâÊã©ÂáΩÊï∞
  function selectAllHistoryTransitions() {
    const checkboxes = historyTransitionEffectsContainer.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      checkbox.checked = true;
    });
  }

  function selectNoneHistoryTransitions() {
    const checkboxes = historyTransitionEffectsContainer.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      checkbox.checked = false;
    });
  }

  function selectSlideHistoryTransitions() {
    const checkboxes = historyTransitionEffectsContainer.querySelectorAll('input[type="checkbox"]');
    const slideEffects = ['slideleft', 'slideright', 'slideup', 'slidedown'];
    checkboxes.forEach(checkbox => {
      checkbox.checked = slideEffects.includes(checkbox.value);
    });
  }

  function selectFadeHistoryTransitions() {
    const checkboxes = historyTransitionEffectsContainer.querySelectorAll('input[type="checkbox"]');
    const fadeEffects = ['fadeblack', 'fadewhite', 'dissolve', 'fadefast', 'fadeslow', 'fadegrays'];
    checkboxes.forEach(checkbox => {
      checkbox.checked = fadeEffects.includes(checkbox.value);
    });
  }

  // ==================== ÂõæÂ∫ìÂäüËÉΩÂáΩÊï∞ ====================

  // ÂàõÂª∫Êñ∞ÂõæÂ∫ìÂàÜÁªÑ
  async function createNewGalleryGroup() {
    // ‰ΩøÁî®Ëá™ÂÆö‰πâÊ®°ÊÄÅÂØπËØùÊ°ÜÊõø‰ª£prompt
    showCustomModalWithInput('ÂàõÂª∫Êñ∞ÂàÜÁªÑ', 'ËØ∑ËæìÂÖ•Êñ∞ÂàÜÁªÑÁöÑÂêçÁß∞:', '', (groupName) => {
      if (!groupName) {
        toast('‚ùå ÂàÜÁªÑÂêçÁß∞‰∏çËÉΩ‰∏∫Á©∫', 'err');
        return;
      }
      
      if (groupName.length > 50) {
        toast('‚ùå ÂàÜÁªÑÂêçÁß∞‰∏çËÉΩË∂ÖËøá50‰∏™Â≠óÁ¨¶', 'err');
        return;
      }
      
      createGalleryGroup(groupName);
    });
  }

  // ÂàõÂª∫ÂõæÂ∫ìÂàÜÁªÑÁöÑÂÆûÈôÖÂáΩÊï∞
  async function createGalleryGroup(groupName) {
    try {
      const response = await fetch(`${API_BASE}/gallery/groups`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: groupName })
      });
      
      const result = await response.json();
      
      if (result.success) {
        toast('‚úÖ ÂàÜÁªÑÂàõÂª∫ÊàêÂäü', 'ok');
        // ÈáçÊñ∞Âä†ËΩΩÂàÜÁªÑÂàóË°®
        await loadGalleryGroups();
      } else {
        throw new Error(result.error || 'ÂàõÂª∫Â§±Ë¥•');
      }
    } catch (error) {
      toast(`‚ùå ÂàõÂª∫ÂàÜÁªÑÂ§±Ë¥•: ${error.message}`, 'err');
    }
  }

  // ÈáçÂëΩÂêçÂõæÂ∫ìÂàÜÁªÑ
  async function renameGalleryGroup() {
    if (!currentGalleryGroup) {
      toast('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ÂàÜÁªÑ', 'warn');
      return;
    }
    
    // ‰ΩøÁî®Ëá™ÂÆö‰πâÊ®°ÊÄÅÂØπËØùÊ°ÜÊõø‰ª£prompt
    showCustomModalWithInput('ÈáçÂëΩÂêçÂàÜÁªÑ', 'ËØ∑ËæìÂÖ•Êñ∞ÁöÑÂàÜÁªÑÂêçÁß∞:', currentGalleryGroup.name, (newName) => {
      if (!newName) {
        toast('‚ùå ÂàÜÁªÑÂêçÁß∞‰∏çËÉΩ‰∏∫Á©∫', 'err');
        return;
      }
      
      if (newName === currentGalleryGroup.name) {
        toast('‚ùå Êñ∞ÂêçÁß∞‰∏çËÉΩ‰∏éÂéüÂêçÁß∞Áõ∏Âêå', 'warn');
        return;
      }
      
      if (newName.length > 50) {
        toast('‚ùå ÂàÜÁªÑÂêçÁß∞‰∏çËÉΩË∂ÖËøá50‰∏™Â≠óÁ¨¶', 'err');
        return;
      }
      
      renameGalleryGroupWithName(newName);
    });
  }

  // ÈáçÂëΩÂêçÂõæÂ∫ìÂàÜÁªÑÁöÑÂÆûÈôÖÂáΩÊï∞
  async function renameGalleryGroupWithName(newName) {
    try {
      const response = await fetch(`${API_BASE}/gallery/groups/${currentGalleryGroup.id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: newName })
      });
      
      const result = await response.json();
      
      if (result.success) {
        toast('‚úÖ ÂàÜÁªÑÈáçÂëΩÂêçÊàêÂäü', 'ok');
        currentGalleryGroup.name = newName;
        // ÈáçÊñ∞Âä†ËΩΩÂàÜÁªÑÂàóË°®
        await loadGalleryGroups();
        // ÈáçÊñ∞ÈÄâÊã©ÂΩìÂâçÂàÜÁªÑ
        el('galleryGroupSelect').value = currentGalleryGroup.id;
        // ÈáçÊñ∞Âä†ËΩΩÂΩìÂâçÂàÜÁªÑÁöÑÂõæÁâá
        await selectGalleryGroup();
      } else {
        throw new Error(result.error || 'ÈáçÂëΩÂêçÂ§±Ë¥•');
      }
    } catch (error) {
      toast(`‚ùå ÈáçÂëΩÂêçÂàÜÁªÑÂ§±Ë¥•: ${error.message}`, 'err');
    }
  }

  // Âä†ËΩΩÂõæÂ∫ìÂàÜÁªÑ
  async function loadGalleryGroups() {
    try {
      const response = await fetch(`${API_BASE}/gallery/groups`);
      const data = await response.json();
      
      const groupSelect = el('galleryGroupSelect');
      groupSelect.innerHTML = '<option value="">ÈÄâÊã©ÊàñÂàõÂª∫ÂàÜÁªÑ...</option>';
      
      data.groups.forEach(group => {
        const option = document.createElement('option');
        option.value = group.id;
        option.textContent = `${group.name} (${group.image_count}Âº†ÂõæÁâá)`;
        groupSelect.appendChild(option);
      });
      
      // Â¶ÇÊûú‰πãÂâçÊúâÈÄâ‰∏≠ÁöÑÂàÜÁªÑÔºåÈáçÊñ∞ÈÄâ‰∏≠ÂÆÉ
      if (currentGalleryGroup) {
        groupSelect.value = currentGalleryGroup.id;
      }
    } catch (error) {
      toast(`Âä†ËΩΩÂõæÂ∫ìÂàÜÁªÑÂ§±Ë¥•: ${error.message}`, 'err');
    }
  }

  // ÈÄâÊã©ÂõæÂ∫ìÂàÜÁªÑ
  async function selectGalleryGroup() {
    const groupId = el('galleryGroupSelect').value;
    
    if (!groupId) {
      // ÈöêËóèÁõ∏ÂÖ≥Âå∫Âüü
      el('galleryUploadArea').style.display = 'none';
      el('galleryImagesArea').style.display = 'none';
      el('galleryVideoConfig').style.display = 'none';
      el('galleryGroupActions').style.display = 'none';
      return;
    }
    
    try {
      // Ëé∑ÂèñÂàÜÁªÑ‰ø°ÊÅØ
      const response = await fetch(`${API_BASE}/gallery/groups/${groupId}`);
      const data = await response.json();
      
      currentGalleryGroup = data.group;
      
      // ÊòæÁ§∫Áõ∏ÂÖ≥Âå∫Âüü
      el('galleryUploadArea').style.display = 'block';
      el('galleryImagesArea').style.display = 'block';
      el('galleryVideoConfig').style.display = 'block';
      el('galleryGroupActions').style.display = 'flex';
      
      // Êõ¥Êñ∞ÂàÜÁªÑÊ†áÈ¢ò
      el('galleryGroupTitle').textContent = `ÂàÜÁªÑ: ${currentGalleryGroup.name}`;
      
      // Âä†ËΩΩÂàÜÁªÑ‰∏≠ÁöÑÂõæÁâá
      await loadGalleryImages(groupId);
      
    } catch (error) {
      toast(`Âä†ËΩΩÂõæÂ∫ìÂàÜÁªÑÂ§±Ë¥•: ${error.message}`, 'err');
    }
  }

  // ÈöêËóèÂ∏¶ËæìÂÖ•Ê°ÜÁöÑËá™ÂÆö‰πâÊ®°ÊÄÅÂØπËØùÊ°Ü
  function hideCustomModalWithInput(modal) {
    modal.classList.remove('show');
    setTimeout(() => {
      if (modal.parentNode) {
        modal.parentNode.removeChild(modal);
      }
    }, 300);
  }

  // Â∞ÜÂáΩÊï∞Ê∑ªÂä†Âà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü
  window.showCustomModal = showCustomModal;
  window.showCustomConfirm = showCustomConfirm;
  window.hideCustomModal = hideCustomModal;
  window.showCustomModalWithInput = showCustomModalWithInput;

  // ÂéÜÂè≤‰ªªÂä°ËΩ¨Âú∫ÊïàÊûúÈÄâÊã©ÂáΩÊï∞
  function selectAllHistoryTransitions() {
    const checkboxes = historyTransitionEffectsContainer.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      checkbox.checked = true;
    });
  }

  function selectNoneHistoryTransitions() {
    const checkboxes = historyTransitionEffectsContainer.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      checkbox.checked = false;
    });
  }

  function selectSlideHistoryTransitions() {
    const checkboxes = historyTransitionEffectsContainer.querySelectorAll('input[type="checkbox"]');
    const slideEffects = ['slideleft', 'slideright', 'slideup', 'slidedown'];
    checkboxes.forEach(checkbox => {
      checkbox.checked = slideEffects.includes(checkbox.value);
    });
  }

  // Âä†ËΩΩÂõæÂ∫ìÂõæÁâá
  async function loadGalleryImages(groupId) {
    try {
      const response = await fetch(`${API_BASE}/gallery/groups/${groupId}/images`);
      const data = await response.json();
      
      const imagesGrid = el('galleryImagesGrid');
      imagesGrid.innerHTML = '';
      
      if (data.images.length === 0) {
        imagesGrid.innerHTML = '<div style="text-align:center;color:var(--muted);padding:20px;grid-column:1/-1">ËØ•ÂàÜÁªÑÊöÇÊó†ÂõæÁâá</div>';
        return;
      }
      
      // ‰∏∫ÊØèÂº†ÂõæÁâáÂàõÂª∫ÁΩëÊ†ºÈ°π
      data.images.forEach(image => {
        const imageItem = document.createElement('div');
        imageItem.className = 'gallery-item';
        imageItem.dataset.imageId = image.id;
        
        imageItem.innerHTML = `
          <input type="checkbox" class="gallery-item-checkbox" onchange="onGalleryImageSelect(this)">
          <button class="gallery-item-delete" onclick="deleteGalleryImage('${image.id}', event)" title="Âà†Èô§ÂõæÁâá">√ó</button>
          <img src="${API_BASE}/files/${image.id}" alt="${image.name}" loading="lazy">
        `;
        
        imagesGrid.appendChild(imageItem);
      });
      
    } catch (error) {
      toast(`Âä†ËΩΩÂõæÂ∫ìÂõæÁâáÂ§±Ë¥•: ${error.message}`, 'err');
    }
  }

  // ÂõæÂ∫ìÂõæÁâáÈÄâÊã©‰∫ã‰ª∂
  function onGalleryImageSelect(checkbox) {
    const imageItem = checkbox.closest('.gallery-item');
    if (checkbox.checked) {
      imageItem.classList.add('selected');
    } else {
      imageItem.classList.remove('selected');
    }
  }

  // ÂÖ®ÈÄâÂõæÂ∫ìÂõæÁâá
  function selectAllGalleryImages() {
    const checkboxes = el('galleryImagesGrid').querySelectorAll('.gallery-item-checkbox');
    checkboxes.forEach(checkbox => {
      checkbox.checked = true;
      onGalleryImageSelect(checkbox);
    });
  }

  // ÂÖ®‰∏çÈÄâÂõæÂ∫ìÂõæÁâá
  function selectNoneGalleryImages() {
    const checkboxes = el('galleryImagesGrid').querySelectorAll('.gallery-item-checkbox');
    checkboxes.forEach(checkbox => {
      checkbox.checked = false;
      onGalleryImageSelect(checkbox);
    });
  }

  // Âà†Èô§ÈÄâ‰∏≠ÁöÑÂõæÂ∫ìÂõæÁâá
  async function deleteSelectedGalleryImages() {
    const selectedCheckboxes = el('galleryImagesGrid').querySelectorAll('.gallery-item-checkbox:checked');
    
    if (selectedCheckboxes.length === 0) {
      toast('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑÂõæÁâá', 'warn');
      return;
    }
    
    const confirmed = await showCustomConfirm(
      'Á°ÆËÆ§Âà†Èô§',
      `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${selectedCheckboxes.length} Âº†ÂõæÁâáÂêóÔºüÂà†Èô§ÂêéÂ∞ÜÊó†Ê≥ïÊÅ¢Â§ç„ÄÇ`,
      'Âà†Èô§',
      'ÂèñÊ∂à'
    );
    
    if (!confirmed) return;
    
    try {
      const imageIds = Array.from(selectedCheckboxes).map(cb => cb.closest('.gallery-item').dataset.imageId);
      
      const response = await fetch(`${API_BASE}/gallery/images/batch-delete`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ image_ids: imageIds })
      });
      
      const result = await response.json();
      
      if (result.success) {
        toast(`‚úÖ ÊàêÂäüÂà†Èô§ ${result.deleted_count} Âº†ÂõæÁâá`, 'ok');
        // ÈáçÊñ∞Âä†ËΩΩÂΩìÂâçÂàÜÁªÑ
        await selectGalleryGroup();
      } else {
        throw new Error(result.error || 'Âà†Èô§Â§±Ë¥•');
      }
    } catch (error) {
      toast(`‚ùå Âà†Èô§ÂõæÁâáÂ§±Ë¥•: ${error.message}`, 'err');
    }
  }

  // Âà†Èô§ÂçïÂº†ÂõæÂ∫ìÂõæÁâá
  async function deleteGalleryImage(imageId, event) {
    event.stopPropagation();
    
    const confirmed = await showCustomConfirm(
      'Á°ÆËÆ§Âà†Èô§',
      'Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÂº†ÂõæÁâáÂêóÔºüÂà†Èô§ÂêéÂ∞ÜÊó†Ê≥ïÊÅ¢Â§ç„ÄÇ',
      'Âà†Èô§',
      'ÂèñÊ∂à'
    );
    
    if (!confirmed) return;
    
    try {
      const response = await fetch(`${API_BASE}/gallery/images/${imageId}`, {
        method: 'DELETE'
      });
      
      const result = await response.json();
      
      if (result.success) {
        toast('‚úÖ ÂõæÁâáÂà†Èô§ÊàêÂäü', 'ok');
        // ÈáçÊñ∞Âä†ËΩΩÂΩìÂâçÂàÜÁªÑ
        await selectGalleryGroup();
      } else {
        throw new Error(result.error || 'Âà†Èô§Â§±Ë¥•');
      }
    } catch (error) {
      toast(`‚ùå Âà†Èô§ÂõæÁâáÂ§±Ë¥•: ${error.message}`, 'err');
    }
  }

  // Âà†Èô§ÂõæÂ∫ìÂàÜÁªÑ
  async function deleteGalleryGroup() {
    if (!currentGalleryGroup) {
      toast('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ÂàÜÁªÑ', 'warn');
      return;
    }
    
    const confirmed = await showCustomConfirm(
      'Á°ÆËÆ§Âà†Èô§',
      `Á°ÆÂÆöË¶ÅÂà†Èô§ÂàÜÁªÑ "${currentGalleryGroup.name}" ÂêóÔºüËØ•ÂàÜÁªÑ‰∏≠ÁöÑÊâÄÊúâÂõæÁâáÈÉΩÂ∞ÜË¢´Âà†Èô§‰∏îÊó†Ê≥ïÊÅ¢Â§ç„ÄÇ`,
      'Âà†Èô§',
      'ÂèñÊ∂à'
    );
    
    if (!confirmed) return;
    
    try {
      const response = await fetch(`${API_BASE}/gallery/groups/${currentGalleryGroup.id}`, {
        method: 'DELETE'
      });
      
      const result = await response.json();
      
      if (result.success) {
        toast('‚úÖ ÂàÜÁªÑÂà†Èô§ÊàêÂäü', 'ok');
        currentGalleryGroup = null;
        // ÈáçÊñ∞Âä†ËΩΩÂàÜÁªÑÂàóË°®
        await loadGalleryGroups();
        // ÈáçÁΩÆÁïåÈù¢
        el('galleryGroupSelect').value = '';
        selectGalleryGroup();
      } else {
        throw new Error(result.error || 'Âà†Èô§Â§±Ë¥•');
      }
    } catch (error) {
      toast(`‚ùå Âà†Èô§ÂàÜÁªÑÂ§±Ë¥•: ${error.message}`, 'err');
    }
  }

  // ÂõæÂ∫ìÂõæÁâá‰∏ä‰º†Â§ÑÁêÜ
  async function handleGalleryImageUpload() {
    const fileInput = el('galleryImageUpload');
    const files = fileInput.files;
    
    if (!files || files.length === 0) return;
    
    if (!currentGalleryGroup) {
      toast('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ÂàÜÁªÑ', 'warn');
      return;
    }
    
    try {
      toast(`üì§ Ê≠£Âú®‰∏ä‰º† ${files.length} Âº†ÂõæÁâá...`, 'info');
      
      // ÈÄê‰∏™‰∏ä‰º†Êñá‰ª∂
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        
        // Ê£ÄÊü•Êñá‰ª∂Á±ªÂûã
        if (!file.type.startsWith('image/')) {
          toast(`‚ö†Ô∏è Ë∑≥ËøáÈùûÂõæÁâáÊñá‰ª∂: ${file.name}`, 'warn');
          continue;
        }
        
        const formData = new FormData();
        formData.append('file', file);
        formData.append('type', 'image');
        formData.append('group_id', currentGalleryGroup.id);
        
        const response = await fetch(`${API_BASE}/gallery/upload`, {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (!result.success) {
          toast(`‚ùå ‰∏ä‰º†Â§±Ë¥• ${file.name}: ${result.error || 'Êú™Áü•ÈîôËØØ'}`, 'err');
        }
      }
      
      toast('‚úÖ ÂõæÁâá‰∏ä‰º†ÂÆåÊàê', 'ok');
      
      // Ê∏ÖÁ©∫Êñá‰ª∂ËæìÂÖ•Ê°Ü
      fileInput.value = '';
      
      // ÈáçÊñ∞Âä†ËΩΩÂΩìÂâçÂàÜÁªÑ
      await selectGalleryGroup();
      
    } catch (error) {
      toast(`‚ùå ÂõæÁâá‰∏ä‰º†Â§±Ë¥•: ${error.message}`, 'err');
      console.error('Upload error:', error);
    }
  }

  // ËΩ¨Âú∫ÊïàÊûúÈÄâÊã©Áõ∏ÂÖ≥ÂáΩÊï∞
  function selectAllGalleryTransitions() {
    const checkboxes = el('galleryTransitionEffects').querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      checkbox.checked = true;
    });
  }

  function selectNoneGalleryTransitions() {
    const checkboxes = el('galleryTransitionEffects').querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      checkbox.checked = false;
    });
  }

  function selectSlideGalleryTransitions() {
    const checkboxes = el('galleryTransitionEffects').querySelectorAll('input[type="checkbox"]');
    const slideEffects = ['slideleft', 'slideright', 'slideup', 'slidedown'];
    checkboxes.forEach(checkbox => {
      checkbox.checked = slideEffects.includes(checkbox.value);
    });
  }

  function selectFadeGalleryTransitions() {
    const checkboxes = el('galleryTransitionEffects').querySelectorAll('input[type="checkbox"]');
    const fadeEffects = ['fadeblack', 'fadewhite', 'dissolve', 'fadefast', 'fadeslow', 'fadegrays'];
    checkboxes.forEach(checkbox => {
      checkbox.checked = fadeEffects.includes(checkbox.value);
    });
  }

  // ‰øÆÂ§çÈáçÂ§çÊö¥Èú≤ÁöÑÈóÆÈ¢òÔºåÁ°Æ‰øùÊØè‰∏™ÂáΩÊï∞Âè™Êö¥Èú≤‰∏ÄÊ¨°
  // ËΩ¨Âú∫ÊïàÊûúÈÄâÊã©Áõ∏ÂÖ≥ÂáΩÊï∞
  window.selectAllTransitions = selectAllTransitions;
  window.selectNoneTransitions = selectNoneTransitions;
  window.selectSlideTransitions = selectSlideTransitions;
  window.selectFadeTransitions = selectFadeTransitions;
  
  window.selectAllHistoryTransitions = selectAllHistoryTransitions;
  window.selectNoneHistoryTransitions = selectNoneHistoryTransitions;
  window.selectSlideHistoryTransitions = selectSlideHistoryTransitions;
  window.selectFadeHistoryTransitions = selectFadeHistoryTransitions;

  // ‰ªÖÁîüÊàêÂõæÁâáÊ®°ÂºèÁöÑÁõ∏ÂÖ≥ÂáΩÊï∞
  window.selectAllImages = selectAllImages;
  window.selectNoneImages = selectNoneImages;
  window.deleteSelectedImage = deleteSelectedImage;
  window.deleteGalleryImage = deleteGalleryImage;
  window.selectAllComposeTransitions = selectAllComposeTransitions;
  window.selectNoneComposeTransitions = selectNoneComposeTransitions;
  window.selectSlideComposeTransitions = selectSlideComposeTransitions;
  window.selectFadeComposeTransitions = selectFadeComposeTransitions;

  // ÂéÜÂè≤‰ªªÂä°Áõ∏ÂÖ≥ÂáΩÊï∞
  window.loadHistoryTasks = loadHistoryTasks;
  window.deleteHistoryTask = deleteHistoryTask;

  // ÂõæÂ∫ìÁõ∏ÂÖ≥ÂáΩÊï∞
  window.createNewGalleryGroup = createNewGalleryGroup;
  window.loadGalleryGroups = loadGalleryGroups;
  window.selectGalleryGroup = selectGalleryGroup;
  window.renameGalleryGroup = renameGalleryGroup;
  window.deleteGalleryGroup = deleteGalleryGroup;
  window.selectAllGalleryImages = selectAllGalleryImages;
  window.selectNoneGalleryImages = selectNoneGalleryImages;
  window.deleteSelectedGalleryImages = deleteSelectedGalleryImages;
  window.selectAllGalleryTransitions = selectAllGalleryTransitions;
  window.selectNoneGalleryTransitions = selectNoneGalleryTransitions;
  window.selectSlideGalleryTransitions = selectSlideGalleryTransitions;
  window.selectFadeGalleryTransitions = selectFadeGalleryTransitions;
  
  // Ê®°ÂºèÂàáÊç¢ÂáΩÊï∞
  window.switchMode = switchMode;
  
  // ÂÖ∂‰ªñÈúÄË¶ÅÂÖ®Â±ÄËÆøÈóÆÁöÑÂáΩÊï∞
  window.showCustomModal = showCustomModal;
  window.showCustomConfirm = showCustomConfirm;
  window.hideCustomModal = hideCustomModal;
  window.showCustomModalWithInput = showCustomModalWithInput;
  window.handleGenerateImagesOnly = handleGenerateImagesOnly;
  window.handleComposeVideo = handleComposeVideo;
})();
</script>
</body>
</html>